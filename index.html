<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PROTOTYPE — Demo Prototype</title>
<style>
  /* ========== Design System: CSS Variables ========== */
  :root{
    /* Color Palette */
    --color-bg: #f5f7fb;
    --color-surface: #ffffff;
    --color-primary: #1e4f8f;
    --color-primary-soft: #3b6fb8;
    --color-primary-lighter: #5a89d6;
    --color-primary-bg: #eef5ff;
    --color-accent-success: #10b981;
    --color-accent-success-bg: #d1fae5;
    --color-accent-success-text: #065f46;
    --color-accent-warning: #f59e0b;
    --color-accent-warning-bg: #fef3c7;
    --color-accent-warning-text: #92400e;
    --color-accent-error: #ef4444;
    --color-accent-error-bg: #fee2e2;
    --color-accent-error-text: #991b1b;
    --color-border: #dde3ee;
    --color-text-main: #1f2933;
    --color-text-muted: #6b7280;
    --color-text-light: #94a3b8;
    
    /* Spacing */
    --spacing-xs: 0.375rem;
    --spacing-sm: 0.5rem;
    --spacing-md: 0.75rem;
    --spacing-lg: 1rem;
    --spacing-xl: 1.5rem;
    --spacing-2xl: 2rem;
    
    /* Border Radius */
    --radius-sm: 0.375rem;
    --radius-md: 0.5rem;
    --radius-lg: 0.75rem;
    --radius-xl: 1rem;
    --radius-full: 9999px;
    
    /* Shadows */
    --shadow-sm: 0 1px 3px rgba(15, 23, 42, 0.04);
    --shadow-md: 0 4px 12px rgba(15, 23, 42, 0.06);
    --shadow-lg: 0 8px 20px rgba(15, 23, 42, 0.08);
    --shadow-xl: 0 12px 32px rgba(15, 23, 42, 0.12);
    
    /* Typography */
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  }
  
  /* ========== Base Styles ========== */
  *, *::before, *::after { box-sizing: border-box; }
  html, body { 
    margin: 0; 
    padding: 0;
    background: var(--color-bg); 
    color: var(--color-text-main); 
    line-height: 1.6;
  }
  
  h1, h2, h3, h4, h5, h6 { 
    margin: 0; 
    font-weight: 600; 
    line-height: 1.3; 
    color: var(--color-text-main);
  }
  h1 { font-size: 2rem; }
  h2 { font-size: 1.5rem; }
  h3 { font-size: 1.25rem; }
  h4 { font-size: 1.125rem; }
  
  /* ========== Utility Classes ========== */
  .muted { color: var(--color-text-muted); font-size: 0.875rem; }
  .text-light { color: var(--color-text-light); }
  .spacer { flex: 1; }
  
  /* ========== Layout ========== */
  .app-shell { 
    max-width: 1280px; 
    margin: 0 auto; 
    padding: var(--spacing-xl) 1.75rem; 
  }
  .container { 
    padding: var(--spacing-xl); 
    max-width: 1280px; 
    margin: 0 auto; 
  }
  .main-layout {
    display: flex;
    gap: var(--spacing-xl);
    align-items: flex-start;
  }
  .main-layout > .main-content { flex: 1; }
  .main-layout > .sidebar { 
    flex: 0 0 280px; 
    position: sticky;
    top: var(--spacing-xl);
  }
  
  /* ========== Header / Navbar ========== */
  header {
    padding: 1.125rem 1.75rem;
    display: flex;
    align-items: center;
    gap: var(--spacing-xl);
    background: var(--color-primary);
    color: white;
    box-shadow: var(--shadow-md);
    position: sticky;
    top: 0;
    z-index: 100;
  }
  .brand { 
    display: flex; 
    gap: 0.875rem; 
    align-items: center; 
  }
  .brand .logo { 
    width: 48px;
    height: 48px;
    border-radius: var(--radius-md);
    background: white;
    color: var(--color-primary);
    display: flex;
    justify-content: center;
    align-items: center;
    font-weight: 800;
    font-size: 1.125rem;
    box-shadow: var(--shadow-sm);
  }
  .brand-text {
    display: flex;
    flex-direction: column;
    gap: 0.125rem;
  }
  .brand-title { 
    font-size: 1.125rem; 
    font-weight: 700; 
    letter-spacing: 0.025em;
    color: white;
  }
  .brand-subtitle { 
    font-size: 0.75rem; 
    color: rgba(255, 255, 255, 0.8); 
    font-weight: 500;
  }
  .user-info { 
    text-align: right; 
    color: white;
  }
  .user-name { 
    font-size: 0.9375rem; 
    font-weight: 700;
    color: white;
  }
  .user-meta { 
    font-size: 0.75rem; 
    color: rgba(255, 255, 255, 0.85); 
    line-height: 1.4; 
    margin-top: 0.25rem;
  }

  /* ========== Navigation Pills ========== */
  .nav-pills {
    display: flex;
    gap: var(--spacing-sm);
    flex-wrap: wrap;
  }
  .nav-pill {
    padding: 0.5rem 1rem;
    border-radius: var(--radius-full);
    border: 1.5px solid var(--color-border);
    background: white;
    color: var(--color-text-main);
    font-weight: 600;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  .nav-pill:hover {
    border-color: var(--color-primary);
    background: var(--color-primary-bg);
    color: var(--color-primary);
  }
  .nav-pill.active {
    background: var(--color-primary);
    border-color: var(--color-primary);
    color: white;
    box-shadow: var(--shadow-sm);
  }
  
  /* ========== Buttons ========== */
  button { 
    padding: 0.55rem 1.2rem; 
    border-radius: var(--radius-md); 
    border: none; 
    cursor: pointer; 
    font-weight: 600; 
    font-size: 0.9375rem;
    transition: all 0.2s ease;
    font-family: inherit;
  }
  .btn-primary,
  button:not(.secondary):not(.link):not(.btn):not(.close):not(.del):not(.mark-rec):not(.small) { 
    background: var(--color-primary); 
    color: white; 
    box-shadow: var(--shadow-sm);
  }
  .btn-primary:hover,
  button:not(.secondary):not(.link):not(.btn):not(.close):not(.del):not(.mark-rec):not(.small):hover {
    background: var(--color-primary-soft);
    box-shadow: var(--shadow-md);
    transform: translateY(-1px);
  }
  button.secondary { 
    background: var(--color-text-main); 
    color: white;
    box-shadow: var(--shadow-sm);
  }
  button.secondary:hover {
    background: #374151;
    box-shadow: var(--shadow-md);
    transform: translateY(-1px);
  }
  button.link { 
    background: transparent; 
    color: var(--color-primary); 
    box-shadow: none; 
    padding: 0.25rem 0.5rem;
    font-weight: 600;
  }
  button.link:hover {
    background: var(--color-primary-bg);
    text-decoration: underline;
    transform: none;
  }
  button:disabled { 
    opacity: 0.5; 
    cursor: not-allowed; 
  }
  button:disabled:hover {
    transform: none;
    box-shadow: var(--shadow-sm);
  }
  .btn.small { 
    padding: 0.375rem 0.75rem; 
    font-size: 0.8125rem; 
    border-radius: var(--radius-sm); 
  }
  
  /* ========== Forms ========== */
  input, select, textarea { 
    border: 1.5px solid var(--color-border); 
    padding: 0.55rem 0.75rem; 
    border-radius: var(--radius-md);
    background: white;
    color: var(--color-text-main);
    font-family: inherit;
    font-size: 0.9375rem;
    transition: all 0.2s ease;
  }
  input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px var(--color-primary-bg);
  }
  label {
    display: inline-block;
    font-weight: 600;
    color: var(--color-text-main);
    font-size: 0.875rem;
    margin-bottom: 0.375rem;
  }
  .form-row {
    display: flex;
    gap: var(--spacing-lg);
    align-items: flex-start;
  }
  .form-row > * { flex: 1; }
  
  /* ========== Cards ========== */
  .card { 
    background: var(--color-surface); 
    border-radius: var(--radius-lg); 
    box-shadow: var(--shadow-lg); 
    padding: 1.5rem 1.75rem;
    border: 1px solid rgba(226, 232, 240, 0.6);
  }
  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-lg);
  }
  .card-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--color-text-main);
    margin: 0;
  }
  
  .grid { 
    display: grid; 
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
    gap: var(--spacing-xl); 
  }
  .big { font-size: 2rem; font-weight: 700; }
  #lists { margin-top: var(--spacing-xl); }
  
  /* ========== Toolbar ========== */
  .toolbar { 
    display: flex; 
    align-items: center; 
    gap: var(--spacing-md); 
    flex-wrap: wrap; 
  }
  
  /* ========== Step Progress Bar ========== */
  .steps { 
    display: flex; 
    gap: var(--spacing-sm); 
    margin: var(--spacing-xl) 0; 
    flex-wrap: wrap;
    background: white;
    padding: var(--spacing-lg);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-md);
  }
  .step { 
    padding: 0.65rem 1rem; 
    border-radius: var(--radius-full); 
    background: var(--color-bg); 
    color: var(--color-text-muted); 
    font-weight: 600; 
    cursor: pointer; 
    font-size: 0.8125rem;
    border: 2px solid transparent;
    transition: all 0.2s ease;
    position: relative;
  }
  .step:hover {
    background: var(--color-primary-bg);
    color: var(--color-primary);
  }
  .step.active { 
    background: var(--color-primary); 
    color: white;
    box-shadow: var(--shadow-md);
    border-color: var(--color-primary);
  }
  .step.done {
    background: var(--color-accent-success-bg);
    color: var(--color-accent-success-text);
    border-color: var(--color-accent-success);
  }
  .step.done::after {
    content: "✓";
    position: absolute;
    top: -4px;
    right: -4px;
    width: 18px;
    height: 18px;
    background: var(--color-accent-success);
    color: white;
    border-radius: 50%;
    font-size: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
  }

  /* ========== Tables ========== */
  table { 
    width: 100%; 
    border-collapse: collapse; 
  }
  thead tr {
    background: var(--color-primary-bg);
    border-bottom: 2px solid var(--color-primary);
  }
  th, td { 
    text-align: left; 
    padding: 0.875rem 1rem; 
    border-bottom: 1px solid var(--color-border); 
  }
  th {
    font-weight: 700;
    font-size: 0.875rem;
    color: var(--color-text-main);
    text-transform: uppercase;
    letter-spacing: 0.025em;
  }
  tbody tr {
    transition: background 0.15s ease;
  }
  tbody tr:nth-child(even) {
    background: rgba(248, 250, 252, 0.5);
  }
  tbody tr:hover {
    background: var(--color-primary-bg);
  }
  
  /* ========== Status Pills / Chips ========== */
  .chip, .status-pill { 
    padding: 0.375rem 0.75rem; 
    border-radius: var(--radius-full); 
    font-weight: 600; 
    font-size: 0.75rem; 
    display: inline-flex; 
    align-items: center; 
    gap: 0.375rem;
    text-transform: uppercase;
    letter-spacing: 0.025em;
  }
  .ok, .status-completed { 
    background: var(--color-accent-success-bg); 
    color: var(--color-accent-success-text); 
  }
  .miss, .status-pending, .status-failed { 
    background: var(--color-accent-error-bg); 
    color: var(--color-accent-error-text); 
  }
  .warn, .status-in-progress, .status-onsite { 
    background: var(--color-accent-warning-bg); 
    color: var(--color-accent-warning-text); 
  }
  .info { 
    background: #dbeafe; 
    color: #1e40af; 
  }

  /* ========== Progress Bars ========== */
  .bar { 
    height: 10px; 
    background: var(--color-border); 
    border-radius: var(--radius-full); 
    overflow: hidden; 
  }
  .bar > i { 
    display: block; 
    height: 100%; 
    background: linear-gradient(90deg, var(--color-primary-lighter), var(--color-primary));
    transition: width 0.3s ease;
  }
  
  /* ========== Pills (team members, tags) ========== */
  .pill { 
    display: inline-flex; 
    align-items: center; 
    gap: var(--spacing-xs); 
    padding: 0.375rem 0.75rem; 
    background: var(--color-primary-bg); 
    border-radius: var(--radius-full); 
    font-size: 0.8125rem; 
    margin: 0.25rem 0.375rem 0.25rem 0;
    color: var(--color-primary);
    font-weight: 600;
  }
  .pill b { font-weight: 700; }

  /* ========== Flexbox Utilities ========== */
  .row { 
    display: flex; 
    gap: var(--spacing-lg); 
    flex-wrap: wrap; 
    align-items: stretch;
  }
  .col { 
    flex: 1; 
    min-width: 260px; 
  }

  /* ========== Login Page ========== */
  .login-wrap {
    min-height: 100vh; 
    display: flex; 
    align-items: center; 
    justify-content: center;
    position: relative; 
    padding: 2rem; 
    background: linear-gradient(135deg, #e0f2fe 0%, #f5f7fb 50%, #ede9fe 100%);
  }
  .login-card {
    width: min(480px, 94vw);
    background: white;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-xl);
    padding: 2.5rem;
  }
  .login-card h1 { 
    font-size: 1.875rem; 
    margin: 0 0 0.5rem 0; 
    font-weight: 700; 
    letter-spacing: 0.025em; 
    color: var(--color-primary); 
  }
  .login-card .tagline { 
    margin-top: 0.375rem; 
    color: var(--color-text-muted); 
    font-size: 0.9375rem;
    margin-bottom: 1.5rem;
  }
  .login-card label { 
    display: block; 
    font-weight: 600; 
    margin-top: 1.125rem;
    margin-bottom: 0.375rem;
    color: var(--color-text-main);
    font-size: 0.875rem;
  }
  .login-card input { 
    width: 100%; 
    padding: 0.75rem 1rem; 
    border: 1.5px solid var(--color-border); 
    border-radius: var(--radius-md); 
    margin-top: 0.25rem; 
    background: white;
    font-size: 0.9375rem;
  }
  .login-card input:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px var(--color-primary-bg);
  }
  .login-actions { 
    display: flex; 
    align-items: center; 
    justify-content: space-between; 
    gap: var(--spacing-lg); 
    margin-top: 1.5rem; 
  }
  .login-actions .btn,
  .login-card .btn { 
    padding: 0.75rem 1.5rem; 
    border-radius: var(--radius-md); 
    border: none; 
    background: var(--color-primary); 
    color: white; 
    font-weight: 700; 
    cursor: pointer;
    font-size: 0.9375rem;
    box-shadow: var(--shadow-md);
    transition: all 0.2s ease;
  }
  .login-actions .btn:hover,
  .login-card .btn:hover {
    background: var(--color-primary-soft);
    box-shadow: var(--shadow-lg);
    transform: translateY(-2px);
  }
  .login-actions .link { 
    background: transparent; 
    border: none; 
    color: var(--color-primary); 
    cursor: pointer; 
    font-weight: 600;
    font-size: 0.875rem;
    padding: 0.5rem;
  }
  .login-actions .link:hover {
    text-decoration: underline;
  }
  .login-footer-text {
    text-align: center;
    font-size: 0.8125rem;
    color: var(--color-text-light);
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--color-border);
  }


  /* ========== Config Tabs ========== */
  .tabs { 
    display: flex; 
    gap: var(--spacing-sm); 
    margin: var(--spacing-xl) 0; 
    flex-wrap: wrap;
    background: white;
    padding: var(--spacing-md);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
  }
  .tab { 
    padding: 0.625rem 1rem; 
    border-radius: var(--radius-md); 
    background: var(--color-bg); 
    border: 1.5px solid transparent; 
    cursor: pointer; 
    font-weight: 600; 
    color: var(--color-text-main); 
    font-size: 0.875rem;
    transition: all 0.2s ease;
  }
  .tab:hover {
    background: var(--color-primary-bg);
    color: var(--color-primary);
    border-color: var(--color-primary);
  }
  .tab.active { 
    background: var(--color-primary); 
    color: white; 
    border-color: var(--color-primary); 
    box-shadow: var(--shadow-md);
  }

  /* ========== Footer ========== */
  .footer {
    text-align: center;
    margin-top: 3rem;
    padding: 1.5rem;
    color: var(--color-text-light);
    font-size: 0.8125rem;
    font-weight: 400;
    font-family: inherit;
    border-top: 1px solid var(--color-border);
  }

  /* ========== Config Root Spacing ========== */
  #config-root { margin-top: var(--spacing-xl); }

/* ========== Modal (final report) ========== */
.modal { 
  position: fixed; 
  inset: 0; 
  display: none; 
  align-items: center; 
  justify-content: center; 
  background: rgba(15, 23, 42, 0.6); 
  z-index: 1200;
  backdrop-filter: blur(4px);
}
.modal.show { display: flex; }
.modal .dialog { 
  width: 94%; 
  max-width: 960px; 
  background: white; 
  border-radius: var(--radius-xl); 
  padding: 1.75rem; 
  box-shadow: var(--shadow-xl);
  border: 1px solid var(--color-border);
}
.modal .dialog header { 
  display: flex; 
  justify-content: space-between; 
  align-items: center; 
  margin-bottom: var(--spacing-lg);
  padding-bottom: var(--spacing-lg);
  border-bottom: 2px solid var(--color-border);
}
.modal .dialog .content { 
  height: 560px; 
  overflow: auto; 
  border: 1px solid var(--color-border); 
  border-radius: var(--radius-md); 
  padding: var(--spacing-lg); 
  background: var(--color-bg);
}
.modal .close { 
  background: transparent; 
  border: none; 
  font-weight: 700; 
  cursor: pointer; 
  color: var(--color-text-main);
  font-size: 1.5rem;
  padding: 0.25rem 0.5rem;
  border-radius: var(--radius-sm);
  transition: all 0.2s ease;
}
.modal .close:hover {
  background: var(--color-accent-error-bg);
  color: var(--color-accent-error);
}

  /* ========== Step Checklist Layout ========== */
  .step-layout { 
    display: flex; 
    gap: var(--spacing-xl); 
    align-items: flex-start; 
  }
  .step-main { flex: 1; }
  .step-tasks { 
    flex: 0 0 280px; 
    background: var(--color-primary-bg);
    border: 1.5px solid var(--color-primary);
    border-radius: var(--radius-lg);
    padding: var(--spacing-lg);
    font-size: 0.875rem;
    position: sticky;
    top: calc(64px + var(--spacing-xl));
  }
  .step-tasks h4 {
    margin: 0 0 var(--spacing-md) 0;
    color: var(--color-primary);
    font-size: 1rem;
    font-weight: 700;
  }
  .task-list { 
    list-style: none; 
    padding-left: 0; 
    margin: var(--spacing-md) 0 0; 
  }
  .task-list li { 
    margin-bottom: var(--spacing-md);
    display: flex;
    align-items: flex-start;
    gap: var(--spacing-sm);
  }
  .task-list li label {
    display: flex;
    align-items: flex-start;
    gap: var(--spacing-sm);
    cursor: pointer;
    font-weight: 500;
    font-size: 0.875rem;
  }
  .task-list input[type="checkbox"] {
    margin-top: 0.125rem;
    cursor: pointer;
    width: 16px;
    height: 16px;
    flex-shrink: 0;
  }

  /* ========== Task Status Icons (Step 1) ========== */
  .task-item {
    display: flex;
    align-items: flex-start;
    gap: var(--spacing-sm);
    margin-bottom: var(--spacing-md);
    font-size: 0.875rem;
    font-weight: 500;
  }
  .task-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    font-size: 0.6875rem;
    font-weight: 700;
    flex-shrink: 0;
    margin-top: 0.125rem;
  }
  .task-icon.status-pending {
    background: var(--color-accent-error-bg);
    color: var(--color-accent-error);
  }
  .task-icon.status-done {
    background: var(--color-accent-success);
    color: white;
  }

  /* ========== Stage Completion Chip ========== */
  .stage-chip { 
    margin-left: var(--spacing-md); 
    display: inline-block; 
  }
  .stage-chip.chip { 
    background: var(--color-accent-success-bg); 
    color: var(--color-accent-success-text);
    font-weight: 700;
  }

  /* ========== Insurer Portal Styles ========== */
  .kpi-grid { 
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: var(--spacing-lg); 
    margin-top: var(--spacing-lg); 
  }
  .kpi-card { 
    padding: var(--spacing-lg); 
    text-align: left;
    background: linear-gradient(135deg, var(--color-primary-bg) 0%, white 100%);
    border: 1.5px solid var(--color-primary);
    transition: all 0.2s ease;
  }
  .kpi-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
  }
  .kpi-title { 
    color: var(--color-text-muted); 
    font-weight: 600; 
    font-size: 0.8125rem;
    text-transform: uppercase;
    letter-spacing: 0.025em;
  }
  .kpi-value { 
    font-size: 2rem; 
    font-weight: 700; 
    color: var(--color-primary); 
    margin-top: var(--spacing-sm); 
  }
  .flex-row { 
    display: flex; 
    gap: var(--spacing-xl); 
    align-items: flex-start; 
    margin-top: var(--spacing-lg); 
  }

  /* ========== Insurer-specific Tab Styles ========== */
  .insurer-tabs { 
    display: flex; 
    gap: var(--spacing-xs); 
    margin-bottom: var(--spacing-lg); 
    border-bottom: 2px solid var(--color-border); 
    padding-bottom: 0;
  }
  .insurer-tab { 
    padding: 0.75rem 1.25rem; 
    border-radius: var(--radius-md) var(--radius-md) 0 0; 
    background: transparent; 
    cursor: pointer; 
    font-weight: 600; 
    font-size: 0.875rem; 
    color: var(--color-text-muted); 
    transition: all 0.2s;
    border: 2px solid transparent;
    border-bottom: none;
    position: relative;
    bottom: -2px;
  }
  .insurer-tab:hover { 
    background: var(--color-primary-bg); 
    color: var(--color-primary);
  }
  .insurer-tab.active { 
    background: white; 
    color: var(--color-primary);
    border-color: var(--color-border);
    border-bottom-color: white;
    font-weight: 700;
  }
  .insurer-tab-panel { display: none; }
  .insurer-tab-panel.active { display: block; }

  /* ========== Toggle Switch ========== */
  .switch {
    position: relative;
    display: inline-block;
    width: 48px;
    height: 24px;
  }
  .switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }
  .slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: var(--color-border);
    transition: 0.3s;
    border-radius: var(--radius-full);
  }
  .slider:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: 0.3s;
    border-radius: 50%;
    box-shadow: var(--shadow-sm);
  }
  input:checked + .slider {
    background-color: var(--color-primary);
  }
  input:checked + .slider:before {
    transform: translateX(24px);
  }

  /* ========== Field Groups (Details/Summary) ========== */
  details.field-group {
    margin-bottom: var(--spacing-md);
    border: 1.5px solid var(--color-border);
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
    background: var(--color-bg);
  }
  details.field-group summary {
    font-weight: 600;
    color: var(--color-primary);
    cursor: pointer;
    user-select: none;
    padding: var(--spacing-xs);
    margin: calc(-1 * var(--spacing-md));
    padding: var(--spacing-md);
    border-radius: var(--radius-md);
  }
  details.field-group summary:hover {
    background: var(--color-primary-bg);
  }
  details.field-group[open] summary {
    margin-bottom: var(--spacing-md);
    border-bottom: 1.5px solid var(--color-border);
  }
  .field-list {
    padding: var(--spacing-md) 0 0;
  }
  .field-list label {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    margin-bottom: var(--spacing-sm);
    font-weight: 500;
    cursor: pointer;
  }
  .field-list input[type="checkbox"] {
    cursor: pointer;
    width: 16px;
    height: 16px;
  }

  /* ========== Page Title Headers ========== */
  .page-header {
    margin-bottom: var(--spacing-2xl);
  }
  .page-header h2 {
    color: var(--color-primary);
    margin-bottom: var(--spacing-xs);
  }
  .page-header .muted {
    margin-top: var(--spacing-xs);
  }

  /* ========== Responsive Adjustments ========== */
  @media (max-width: 768px) {
    .step-tasks {
      position: static;
      flex: 1 1 100%;
      max-width: none;
    }
    .step-layout {
      flex-direction: column;
    }
    .main-layout {
      flex-direction: column;
    }
    .main-layout > .sidebar {
      flex: 1 1 100%;
      position: static;
    }
  }
  @media (max-width: 768px) {
    .app-shell, .container {
      padding: var(--spacing-lg);
    }
    header {
      padding: var(--spacing-lg);
    }
    .brand-text {
      display: none;
    }
    .steps {
      flex-wrap: wrap;
    }
    .nav-pills {
      width: 100%;
    }
  }

  /* ========== Edit Inspection Modal ========== */
  #edit-modal {
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    background: rgba(15, 23, 42, 0.6);
    z-index: 1200;
    backdrop-filter: blur(4px);
  }
  #edit-modal.show { display: flex; }
  #edit-modal .dialog {
    width: 94%;
    max-width: 720px;
    background: white;
    border-radius: var(--radius-xl);
    padding: 1.75rem;
    box-shadow: var(--shadow-xl);
    border: 1px solid var(--color-border);
  }
  #edit-modal .dialog header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-lg);
    padding-bottom: var(--spacing-lg);
    border-bottom: 2px solid var(--color-border);
  }
  #edit-modal .form-group {
    margin-bottom: var(--spacing-lg);
  }
  #edit-modal .form-group label {
    display: block;
    font-weight: 600;
    margin-bottom: var(--spacing-xs);
    color: var(--color-text-main);
    font-size: 0.875rem;
  }
  #edit-modal .form-group input,
  #edit-modal .form-group select,
  #edit-modal .form-group textarea {
    width: 100%;
    padding: 0.625rem 0.75rem;
    border: 1.5px solid var(--color-border);
    border-radius: var(--radius-md);
    font-size: 0.9375rem;
  }
  #edit-modal .form-group input:read-only {
    background: var(--color-bg);
    color: var(--color-text-muted);
    cursor: not-allowed;
  }
  #edit-modal .form-group textarea {
    min-height: 80px;
    resize: vertical;
  }
  #edit-modal .form-row {
    display: flex;
    gap: var(--spacing-lg);
  }
  #edit-modal .form-row > * {
    flex: 1;
  }
  #edit-modal .modal-actions {
    display: flex;
    gap: var(--spacing-md);
    justify-content: flex-end;
    margin-top: var(--spacing-xl);
    padding-top: var(--spacing-lg);
    border-top: 1px solid var(--color-border);
  }
  #edit-modal .modal-actions button {
    padding: 0.625rem 1.25rem;
  }
  #edit-modal .btn-save {
    background: var(--color-primary);
    color: white;
  }
  #edit-modal .btn-postpone {
    background: var(--color-accent-warning);
    color: white;
  }
  #edit-modal .btn-drop {
    background: var(--color-accent-error);
    color: white;
  }
  #edit-modal .btn-close {
    background: var(--color-text-main);
    color: white;
  }

  /* Disabled edit button styling */
  .btn.edit-btn:disabled {
    background: var(--color-border);
    color: var(--color-text-muted);
    cursor: not-allowed;
    opacity: 0.6;
  }
  .btn.edit-btn:disabled:hover {
    transform: none;
    box-shadow: none;
  }

  /* Tooltip for disabled edit button */
  .edit-btn-wrapper {
    position: relative;
    display: inline-block;
  }
  .edit-btn-wrapper[data-tooltip]:hover::after {
    content: attr(data-tooltip);
    position: absolute;
    bottom: calc(100% + 8px);
    right: 0;
    background: var(--color-text-main);
    color: white;
    padding: 0.5rem 0.75rem;
    border-radius: var(--radius-md);
    font-size: 0.75rem;
    white-space: nowrap;
    z-index: 1000;
    box-shadow: var(--shadow-lg);
  }
  .edit-btn-wrapper[data-tooltip]:hover::before {
    content: '';
    position: absolute;
    bottom: calc(100% + 2px);
    right: 12px;
    border: 6px solid transparent;
    border-top-color: var(--color-text-main);
    z-index: 1000;
  }

  /* Center align specific table columns */
  table td:nth-child(6),  /* Communication column */
  table td:nth-child(7),  /* Modify column */
  table th:nth-child(6),
  table th:nth-child(7) {
    text-align: center !important;
  }

  /* ========== Company Dashboard Styles ========== */
  .company-header {
    background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-soft) 100%);
    color: white;
    padding: var(--spacing-2xl);
    border-radius: var(--radius-lg);
    margin-bottom: var(--spacing-2xl);
    box-shadow: var(--shadow-lg);
  }
  .company-header h1 {
    color: white;
    margin-bottom: var(--spacing-sm);
    display: flex;
    align-items: center;
    gap: var(--spacing-lg);
  }
  .company-type-badge {
    display: inline-block;
    padding: 0.5rem 1rem;
    background: rgba(255, 255, 255, 0.2);
    border: 1.5px solid rgba(255, 255, 255, 0.5);
    border-radius: var(--radius-full);
    font-size: 0.875rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  .company-meta {
    display: flex;
    gap: var(--spacing-2xl);
    flex-wrap: wrap;
    margin-top: var(--spacing-lg);
    font-size: 0.9375rem;
    opacity: 0.95;
  }
  .company-meta-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }
  .company-meta-label {
    font-size: 0.75rem;
    opacity: 0.8;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  .company-meta-value {
    font-size: 1rem;
    font-weight: 700;
  }

  .snapshot-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: var(--spacing-lg);
    margin-bottom: var(--spacing-2xl);
  }
  .snapshot-card {
    background: white;
    padding: var(--spacing-xl);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    border: 1px solid var(--color-border);
    cursor: pointer;
    transition: all 0.2s ease;
  }
  .snapshot-card:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-xl);
    border-color: var(--color-primary);
  }
  .snapshot-card-label {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.025em;
    margin-bottom: var(--spacing-sm);
  }
  .snapshot-card-value {
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--color-primary);
    margin: var(--spacing-sm) 0;
  }
  .snapshot-card-trend {
    font-size: 0.8125rem;
    color: var(--color-text-muted);
    display: flex;
    align-items: center;
    gap: 0.375rem;
  }

  .dashboard-section {
    margin-bottom: var(--spacing-2xl);
  }
  .section-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--color-text-main);
    margin-bottom: var(--spacing-lg);
    padding-bottom: var(--spacing-sm);
    border-bottom: 2px solid var(--color-primary);
    display: flex;
    align-items: center;
    justify-content: flex-start;
    width: 100%;
    cursor: pointer;
    user-select: none;
    transition: all 0.2s ease;
  }
  .section-title:hover {
    color: var(--color-primary);
  }
  .section-toggle-icon {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--color-primary);
    transition: transform 0.3s ease;
    margin-right: var(--spacing-md);
  }
  .section-toggle-icon.collapsed {
    transform: rotate(-90deg);
  }
  .section-content {
    transition: all 0.3s ease;
    overflow: hidden;
  }
  .section-content.collapsed {
    display: none;
  }

  .dashboard-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(480px, 1fr));
    gap: var(--spacing-xl);
    margin-bottom: var(--spacing-2xl);
  }
  .dashboard-row > .card {
    display: flex;
    flex-direction: column;
  }

  .timeline {
    position: relative;
    padding-left: var(--spacing-xl);
  }
  .timeline::before {
    content: '';
    position: absolute;
    left: 8px;
    top: 8px;
    bottom: 8px;
    width: 2px;
    background: var(--color-border);
  }
  .timeline-item {
    position: relative;
    padding: var(--spacing-md) var(--spacing-lg);
    margin-bottom: var(--spacing-md);
    background: white;
    border-radius: var(--radius-md);
    border: 1px solid var(--color-border);
    transition: all 0.2s ease;
  }
  .timeline-item:hover {
    box-shadow: var(--shadow-md);
    border-color: var(--color-primary);
  }
  .timeline-item::before {
    content: '';
    position: absolute;
    left: -21px;
    top: 20px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: white;
    border: 3px solid var(--color-primary);
    z-index: 2;
  }
  .timeline-date {
    font-size: 0.75rem;
    font-weight: 700;
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.375rem;
  }
  .timeline-type {
    font-weight: 600;
    color: var(--color-text-main);
    margin-bottom: 0.25rem;
  }

  .risk-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.375rem 0.75rem;
    border-radius: var(--radius-full);
    font-weight: 700;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.025em;
  }
  .risk-badge-high {
    background: var(--color-accent-error-bg);
    color: var(--color-accent-error-text);
    border: 1.5px solid var(--color-accent-error);
  }
  .risk-badge-medium {
    background: var(--color-accent-warning-bg);
    color: var(--color-accent-warning-text);
    border: 1.5px solid var(--color-accent-warning);
  }
  .risk-badge-low {
    background: var(--color-accent-success-bg);
    color: var(--color-accent-success-text);
    border: 1.5px solid var(--color-accent-success);
  }

  .trend-arrow {
    font-weight: 700;
    font-size: 1rem;
  }
  .trend-up { color: var(--color-accent-error); }
  .trend-stable { color: var(--color-accent-warning); }
  .trend-down { color: var(--color-accent-success); }

  .risk-heatmap {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0.375rem;
  }
  .risk-heatmap th {
    background: var(--color-primary-bg);
    color: var(--color-primary);
    font-weight: 700;
    padding: var(--spacing-md);
    text-align: center;
    font-size: 0.8125rem;
    text-transform: uppercase;
    letter-spacing: 0.025em;
  }
  .risk-heatmap td {
    padding: var(--spacing-lg);
    text-align: center;
    font-weight: 700;
    font-size: 0.875rem;
    border-radius: var(--radius-md);
    border: 2px solid transparent;
    transition: all 0.2s ease;
  }
  .risk-heatmap td:hover {
    transform: scale(1.05);
    box-shadow: var(--shadow-md);
  }
  .risk-high {
    background: #fee2e2;
    color: #991b1b;
    border-color: #ef4444;
  }
  .risk-medium {
    background: #fef3c7;
    color: #92400e;
    border-color: #f59e0b;
  }
  .risk-low {
    background: #d1fae5;
    color: #065f46;
    border-color: #10b981;
  }

  .quality-score {
    text-align: center;
    padding: var(--spacing-xl);
    background: linear-gradient(135deg, var(--color-primary-bg) 0%, white 100%);
    border-radius: var(--radius-lg);
    border: 2px solid var(--color-primary);
    margin-bottom: var(--spacing-lg);
  }
  .quality-score-value {
    font-size: 3rem;
    font-weight: 700;
    color: var(--color-primary);
    margin: var(--spacing-sm) 0;
  }
  .quality-score-label {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .mini-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--spacing-lg);
    margin: var(--spacing-xl) 0;
  }
  .mini-stat {
    padding: var(--spacing-lg);
    background: var(--color-bg);
    border-radius: var(--radius-md);
    border: 1px solid var(--color-border);
  }
  .mini-stat-label {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.025em;
    margin-bottom: 0.375rem;
  }
  .mini-stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--color-primary);
  }

  .scorecard-table {
    width: 100%;
    border-collapse: collapse;
  }
  .scorecard-table th {
    background: var(--color-primary-bg);
    color: var(--color-primary);
    font-weight: 700;
    padding: var(--spacing-md);
    text-align: left;
    font-size: 0.8125rem;
    text-transform: uppercase;
    letter-spacing: 0.025em;
    border-bottom: 2px solid var(--color-primary);
  }
  .scorecard-table td {
    padding: var(--spacing-lg) var(--spacing-md);
    border-bottom: 1px solid var(--color-border);
    vertical-align: top;
  }
  .scorecard-table tbody tr:hover {
    background: var(--color-primary-bg);
  }

  .action-list {
    background: #fffbeb;
    border: 2px solid #f59e0b;
    border-radius: var(--radius-lg);
    padding: var(--spacing-xl);
  }
  .action-list h4 {
    color: #92400e;
    margin-bottom: var(--spacing-lg);
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
  }
  .action-list ol {
    margin: 0;
    padding-left: var(--spacing-xl);
  }
  .action-list li {
    margin-bottom: var(--spacing-md);
    color: var(--color-text-main);
    font-weight: 500;
    line-height: 1.6;
  }

  .grievance-bars {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
    margin-top: var(--spacing-lg);
  }
  .grievance-bar-item {
    display: flex;
    align-items: center;
    gap: var(--spacing-lg);
  }
  .grievance-bar-label {
    flex: 0 0 140px;
    font-weight: 600;
    font-size: 0.875rem;
    color: var(--color-text-main);
  }
  .grievance-bar-track {
    flex: 1;
    height: 24px;
    background: var(--color-border);
    border-radius: var(--radius-full);
    position: relative;
    overflow: hidden;
  }
  .grievance-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--color-primary-lighter), var(--color-primary));
    border-radius: var(--radius-full);
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding: 0 var(--spacing-sm);
    color: white;
    font-weight: 700;
    font-size: 0.75rem;
    transition: width 0.3s ease;
  }

  .badge-green {
    background: var(--color-accent-success-bg);
    color: var(--color-accent-success-text);
    border: 1.5px solid var(--color-accent-success);
  }
  .badge-amber {
    background: var(--color-accent-warning-bg);
    color: var(--color-accent-warning-text);
    border: 1.5px solid var(--color-accent-warning);
  }
  .badge-red {
    background: var(--color-accent-error-bg);
    color: var(--color-accent-error-text);
    border: 1.5px solid var(--color-accent-error);
  }

  .compliance-score {
    text-align: center;
    padding: var(--spacing-xl);
    background: linear-gradient(135deg, #fef3c7 0%, white 100%);
    border-radius: var(--radius-lg);
    border: 2px solid #f59e0b;
    margin-bottom: var(--spacing-lg);
  }
  .compliance-score-value {
    font-size: 3rem;
    font-weight: 700;
    color: #92400e;
    margin: var(--spacing-sm) 0;
  }

  .severity-chips {
    display: flex;
    gap: var(--spacing-lg);
    justify-content: center;
    flex-wrap: wrap;
    margin: var(--spacing-lg) 0;
  }
  .severity-chip {
    padding: var(--spacing-sm) var(--spacing-lg);
    border-radius: var(--radius-md);
    font-weight: 600;
    font-size: 0.875rem;
    border: 2px solid transparent;
  }
  .severity-critical {
    background: var(--color-accent-error-bg);
    color: var(--color-accent-error-text);
    border-color: var(--color-accent-error);
  }
  .severity-moderate {
    background: var(--color-accent-warning-bg);
    color: var(--color-accent-warning-text);
    border-color: var(--color-accent-warning);
  }
  .severity-minor {
    background: #e0e7ff;
    color: #3730a3;
    border-color: #6366f1;
  }
</style>
</head>
<body>

<!-- ===== Login ===== -->
<section id="login" class="login-wrap">
  <div class="login-card">
    <h1>PROTOTYPE</h1>
    <div class="tagline">Demo Prototype<br></div>
    <label>Username</label>
    <input type="email" id="email" placeholder="Enter your username">
    <label>Password</label>
    <input type="password" id="password" placeholder="Enter your password">
    <div class="login-actions">
      <button id="login-btn" type="button" class="btn">Login</button>
      <button id="forgot" type="button" class="link">Forgot Password?</button>
    </div>
    <div class="login-footer-text">Developed by InsurTech Team </div>
  </div>
</section>

<!-- ===== App ===== -->
<section id="app-root" style="display:none;">
  <header>
    <div class="brand">
      <div class="logo">P</div>
      <div class="brand-text">
        <div class="brand-title">PROTOTYPE</div>
        <div class="brand-subtitle">Demo Prototype</div>
      </div>
    </div>
    <div class="spacer"></div>
    <div class="user-info">
      <div class="user-name">User-Name</div>
      <div class="user-meta">Logged in: 12-Nov-2025 11:15 | IP: 192.168.1.108</div>

      <!-- Role switch and Logout on same line -->
      <div style="margin-top:0.75rem; display:flex; align-items:center; gap:1rem;">
        <label for="role-switch" style="font-size:0.8125rem; margin:0; color:rgba(255,255,255,0.9);">View as:</label>
        <select id="role-switch" style="padding:0.375rem 0.625rem; border-radius:0.375rem; border:1.5px solid rgba(255,255,255,0.3); background:rgba(255,255,255,0.1); color:white; font-size:0.8125rem; font-weight:600;">
          <option value="regulator-admin" selected style="color:#1f2933; background:white;">Regulator - Admin</option>
          <option value="regulator-user" style="color:#1f2933; background:white;">Regulator - User</option>
          <option value="insurer" style="color:#1f2933; background:white;">Insurer</option>
        </select>
        <button id="logout-btn" type="button" class="link" style="margin:0; font-size:0.8125rem; color:white; padding:0.25rem 0.5rem;">Logout</button>
      </div>
    </div>
  </header>

  <main class="app-shell" id="app">
  <!-- Regulator - Admin View -->
  <div id="regulator-admin-view">
    <!-- Supervision toolbar: hidden by default, shown only when Home -> Supervision tab is active -->
    <div id="supervision-toolbar" class="toolbar" style="display:none; margin-bottom:var(--spacing-xl); padding-bottom:var(--spacing-lg); border-bottom:2px solid var(--color-border);">
      <button id="btn-start" type="button">Start New Inspection</button>
      <button id="btn-view-ongoing" type="button">View Ongoing</button>
      <button id="btn-view-completed" type="button">View Completed</button>
      <button id="btn-config" type="button">Configure</button>
      <div style="border-left:2px solid var(--color-border); height:32px; margin:0 var(--spacing-sm);"></div>
      <button id="btn-view-company-dashboard" type="button" class="secondary" onclick="showCompanyDashboard('Wisdom General Insurance Co. Ltd.')">Supervision Dashboard</button>
    </div>

    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:var(--spacing-xl);">
      <div class="nav-pills">
        <button id="btn-home" type="button" class="nav-pill active">Home</button>
      </div>
      <h2 style="margin:0; color:var(--color-text-muted); font-size:1.25rem;"></h2>
    </div>

    <!-- HOME -->
    <div id="home" style="display:none; min-height:220px;">
      <div class="card">
        <div class="tabs">
          <div class="tab active" data-home="rbs">Risk Based Supervision</div>
          <div class="tab" data-home="supervision">Supervision</div>
          <div class="tab" data-home="enforcement">Enforcement</div>
          <div class="tab" data-home="grievance">Grievance Intelligence</div>
        </div>

        <div id="home-panels" style="margin-top:var(--spacing-lg);">
          <div id="home-rbs" class="card" style="display:block; box-shadow:var(--shadow-sm); border:1px solid var(--color-border);">
            <h4 style="margin-top:0; color:var(--color-primary);">Risk Based Supervision</h4>
            <div class="muted">Placeholder view for Risk Based Supervision.</div>
          </div>

          <div id="home-supervision" class="card" style="display:none; box-shadow:var(--shadow-sm); border:1px solid var(--color-border);">
            <h4 style="margin-top:0; color:var(--color-primary);">Supervision</h4>
            <div class="muted">Quick access to supervision features.</div>
            <!-- removed duplicated internal toolbar (buttons moved to #supervision-toolbar) -->
            <div style="margin-top:var(--spacing-md);" class="muted">Click any action to open the supervision workspace.</div>
          </div>

          <div id="home-enforcement" class="card" style="display:none; box-shadow:var(--shadow-sm); border:1px solid var(--color-border);">
            <h4 style="margin-top:0; color:var(--color-primary);">Enforcement</h4>
            <div class="muted">Placeholder view for Enforcement.</div>
          </div>

          <div id="home-grievance" class="card" style="display:none; box-shadow:var(--shadow-sm); border:1px solid var(--color-border);">
            <h4 style="margin-top:0; color:var(--color-primary);">Grievance Intelligence</h4>
            <div class="muted">Placeholder view for Grievance Intelligence.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- LISTS (default) -->
    <div id="lists" style="margin-top:var(--spacing-xl);">
      <div class="card">
        <div class="card-header">
          <h3 id="list-title" class="card-title">Completed Inspections</h3>
          <div class="muted">Demo data</div>
        </div>
        <table style="margin-top:var(--spacing-md);">
          <thead><tr><th>ID</th><th>Insurer</th><th>Period</th><th>Status</th><th>Owner</th><th>Final Report</th></tr></thead>
          <tbody id="list-body"></tbody>
        </table>
      </div>
    </div>

    <!-- FLOW -->
    <div id="flow" style="display:none;">
      <div class="steps" id="steps">
        <div class="step" data-step="1">1. Create Inspection</div>
        <div class="step" data-step="2">2. Data Fetch (Status)</div>
        <div class="step" data-step="3">3. Data Validation</div>
        <div class="step" data-step="4">4. Regulatory Check</div>
        <div class="step" data-step="5">5. Analytics & Risk-Based Sampling</div>
        <div class="step" data-step="6">6. Onsite Inspection Support</div>
        <div class="step" data-step="7">7. Observations & Report</div>
      </div>

      <div id="area" style="margin-top:var(--spacing-xl);">
        <!-- Step 1 -->
        <div class="card" id="step-1">
          <h3 style="color:var(--color-primary); margin-bottom:var(--spacing-md);">Create New Inspection <span class="chip stage-chip" data-step="1" style="display:none;">Stage completed</span></h3>
          <div class="step-layout">
            <div class="step-main">
              <div class="muted" style="margin-bottom:var(--spacing-lg);">Fill basic info and assign team.</div>
              <div style="margin-bottom:var(--spacing-xl);">
                <label>Insurer</label>
                <select id="insurer" style="width:100%; max-width:480px; margin-top:var(--spacing-xs);">
                  <option value="">-- Select Insurer --</option>
                  <option>LIC</option><option>ICICI Lombard</option><option>SBI Life</option><option>HDFC Ergo</option>
                </select>
              </div>
              <div class="form-row" style="max-width:480px;">
                <div style="flex:1;">
                  <label>From Date</label>
                  <input type="date" id="from" style="width:100%; margin-top:var(--spacing-xs);">
                </div>
                <div style="flex:1;">
                  <label>To Date</label>
                  <input type="date" id="to" style="width:100%; margin-top:var(--spacing-xs);">
                </div>
              </div>
              <!-- Data category controls (unchanged markup kept) -->
              <div style="margin-top:var(--spacing-xl);">
                <label>Data Category (select one or more)</label>
                <div style="margin-top:var(--spacing-md); max-width:880px;">
                  <!-- Mode chooser -->
                  <div style="margin-bottom:var(--spacing-lg); display:flex; gap:var(--spacing-xl); flex-wrap:wrap;">
                    <label style="font-weight:600; display:flex; align-items:center; gap:var(--spacing-sm); cursor:pointer;">
                      <input type="radio" name="tpl-mode" id="mode-template" checked style="cursor:pointer;"> Use inspection template
                    </label>
                    <label style="font-weight:600; display:flex; align-items:center; gap:var(--spacing-sm); cursor:pointer;">
                      <input type="radio" name="tpl-mode" id="mode-manual" style="cursor:pointer;"> Choose data category and fields manually
                    </label>
                  </div>
                  <div id="templateSection">
                    <div id="template-control" style="margin-bottom:var(--spacing-md);">
                      <label style="display:block; font-weight:600; margin-bottom:var(--spacing-xs);">Inspection template</label>
                      <select id="template-select" style="width:100%; padding:0.625rem 0.75rem; border-radius:var(--radius-md); border:1.5px solid var(--color-border); background:white;">
                        <option value="">-- Select template --</option>
                        <option value="claims_basic">Claims – Basic Claim Inspection</option>
                        <option value="claims_advanced">Claims – Advanced Fraud Review</option>
                        <option value="sales_perf">Sales – Agent Performance Review</option>
                      </select>
                    </div>
                  </div>
                  <div id="manualSection" style="display:none;">
                    <div id="manual-controls">
                      <select id="data-cats" multiple size="4" style="width:100%; padding:0.625rem 0.75rem; border-radius:var(--radius-md); border:1.5px solid var(--color-border); background:white;">
                        <option value="claims">Claims</option>
                        <option value="under">Underwriting</option>
                        <option value="griev">Grievances</option>
                        <option value="sales">Sales/Agents</option>
                      </select>
                    </div>
                    <div id="fields-container" style="margin-top:10px;">
                      <details id="fields-claims" class="field-group" style="display:none;">
                        <summary>Claims fields</summary>
                        <div class="field-list">
                          <label><input type="checkbox" class="field" data-cat="claims" value="claim_id" checked> Claim ID</label><br/>
                          <label><input type="checkbox" class="field" data-cat="claims" value="policy_number" checked> Policy Number</label><br/>
                          <label><input type="checkbox" class="field" data-cat="claims" value="claim_date"> Claim Date</label><br/>
                          <label><input type="checkbox" class="field" data-cat="claims" value="claim_amount"> Claim Amount</label><br/>
                          <label><input type="checkbox" class="field" data-cat="claims" value="settlement_date"> Settlement Date</label><br/>
                        </div>
                      </details>
                      <details id="fields-under" class="field-group" style="display:none;">
                        <summary>Underwriting fields</summary>
                        <div class="field-list">
                          <label><input type="checkbox" class="field" data-cat="under" value="policy_number" checked> Policy Number</label><br/>
                          <label><input type="checkbox" class="field" data-cat="under" value="inception_date"> Inception Date</label><br/>
                          <label><input type="checkbox" class="field" data-cat="under" value="sum_assured"> Sum Assured</label><br/>
                          <label><input type="checkbox" class="field" data-cat="under" value="product_code"> Product Code</label><br/>
                          <label><input type="checkbox" class="field" data-cat="under" value="underwriting_decision"> Underwriting Decision</label><br/>
                        </div>
                      </details>
                      <details id="fields-griev" class="field-group" style="display:none;">
                        <summary>Grievances fields</summary>
                        <div class="field-list">
                          <label><input type="checkbox" class="field" data-cat="griev" value="complaint_id" checked> Complaint ID</label><br/>
                          <label><input type="checkbox" class="field" data-cat="griev" value="received_date"> Received Date</label><br/>
                          <label><input type="checkbox" class="field" data-cat="griev" value="category"> Complaint Category</label><br/>
                          <label><input type="checkbox" class="field" data-cat="griev" value="resolution_date"> Resolution Date</label><br/>
                          <label><input type="checkbox" class="field" data-cat="griev" value="status"> Complaint Status</label><br/>
                        </div>
                      </details>
                      <details id="fields-sales" class="field-group" style="display:none;">
                        <summary>Sales / Agents fields</summary>
                        <div class="field-list">
                          <label><input type="checkbox" class="field" data-cat="sales" value="agent_id" checked> Agent ID</label><br/>
                          <label><input type="checkbox" class="field" data-cat="sales" value="agent_name"> Agent Name</label><br/>
                          <label><input type="checkbox" class="field" data-cat="sales" value="channel"> Channel</label><br/>
                          <label><input type="checkbox" class="field" data-cat="sales" value="sales_date"> Sales Date</label><br/>
                          <label><input type="checkbox" class="field" data-cat="sales" value="commission"> Commission Amount</label><br/>
                        </div>
                      </details>
                    </div>
                  </div>
                </div>
              </div>
              <div style="margin-top:var(--spacing-xl);">
                <label>Assign Team</label>
                <div id="team-list" style="margin-top:var(--spacing-md); display:flex; flex-wrap:wrap; gap:var(--spacing-lg);">
                  <label style="display:flex; align-items:center; gap:var(--spacing-sm); cursor:pointer; font-weight:500;">
                    <input type="checkbox" class="team" value="A. Kumar" style="cursor:pointer;"> A. Kumar
                  </label>
                  <label style="display:flex; align-items:center; gap:var(--spacing-sm); cursor:pointer; font-weight:500;">
                    <input type="checkbox" class="team" value="R. Singh" style="cursor:pointer;"> R. Singh
                  </label>
                  <label style="display:flex; align-items:center; gap:var(--spacing-sm); cursor:pointer; font-weight:500;">
                    <input type="checkbox" class="team" value="P. Rao" style="cursor:pointer;"> P. Rao
                  </label>
                  <label style="display:flex; align-items:center; gap:var(--spacing-sm); cursor:pointer; font-weight:500;">
                    <input type="checkbox" class="team" value="S. Iyer" style="cursor:pointer;"> S. Iyer
                  </label>
                </div>
                <div id="team-pills" style="margin-top:var(--spacing-md);"></div>
              </div>
              <div style="margin-top:var(--spacing-2xl); display:flex; align-items:center; gap:var(--spacing-lg); flex-wrap:wrap;">
                <button id="create-inspection" type="button" class="secondary">Create Inspection</button>
                <div class="muted">Assigned Members and Insurance Company will be notified (simulated).</div>
              </div>
            </div>
            <aside class="step-tasks" data-step="1">
              <h4>Tasks in this stage</h4>
              <ul class="task-list" id="step1-tasks">
                <li class="task-item" data-task="insurer">
                  <span class="task-icon status-pending">✕</span>
                  <span>Select insurer</span>
                </li>
                <li class="task-item" data-task="dates">
                  <span class="task-icon status-pending">✕</span>
                  <span>Set inspection date range</span>
                </li>
                <li class="task-item" data-task="scope">
                  <span class="task-icon status-pending">✕</span>
                  <span>Choose data categories / fields</span>
                </li>
                <li class="task-item" data-task="team">
                  <span class="task-icon status-pending">✕</span>
                  <span>Assign inspection team</span>
                </li>
                <li class="task-item" data-task="create">
                  <span class="task-icon status-pending">✕</span>
                  <span>Click "Create Inspection"</span>
                </li>
              </ul>
            </aside>
          </div>
        </div>

        <!-- Step 2: Data Fetch -->
        <div class="card" id="step-2" style="display:none; margin-top:var(--spacing-xl);">
          <h3 style="color:var(--color-primary); margin-bottom:var(--spacing-md);">Data Fetch (Status) <span class="chip stage-chip" data-step="2" style="display:none;">Stage completed</span></h3>
          
          <div class="step-layout">
            <div class="step-main">
              
              <!-- 1️⃣ Summary Card -->
              <div class="card" id="data-fetch-summary-card" style="background:var(--color-primary-bg); border:2px solid var(--color-primary); padding:var(--spacing-xl); margin-bottom:var(--spacing-xl);">
                <h4 style="margin:0 0 var(--spacing-sm) 0; color:var(--color-primary);">Data Fetch Summary</h4>
                <p class="muted" style="margin-bottom:var(--spacing-lg);">Check whether all requested datasets, periods and submissions have been received before proceeding to validation.</p>
                
                <div style="display:flex; gap:var(--spacing-2xl); flex-wrap:wrap; margin-bottom:var(--spacing-xl);">
                  <div>
                    <div style="font-weight:600; font-size:0.875rem; color:var(--color-text-muted); margin-bottom:var(--spacing-xs);">Datasets received:</div>
                    <div id="summary-datasets" style="font-size:1.5rem; font-weight:700; color:var(--color-primary);">1 / 4</div>
                  </div>
                  <div>
                    <div style="font-weight:600; font-size:0.875rem; color:var(--color-text-muted); margin-bottom:var(--spacing-xs);">Insurer submissions:</div>
                    <div id="summary-submissions" style="font-size:1.5rem; font-weight:700; color:var(--color-primary);">1 / 4</div>
                  </div>
                  <div>
                    <div style="font-weight:600; font-size:0.875rem; color:var(--color-text-muted); margin-bottom:var(--spacing-xs);">Period status:</div>
                    <div id="summary-periods" style="font-size:1.125rem; font-weight:700; color:var(--color-accent-warning);">1 issue found</div>
                  </div>
                </div>
                
                <div style="display:flex; gap:var(--spacing-md); flex-wrap:wrap; align-items:center;">
                  <button id="btn-resolve-pending" type="button">Resolve Pending Items</button>
                  <button id="btn-proceed-validation" type="button" class="secondary" disabled>Proceed to Validation</button>
                  <div id="proceed-help-text" class="muted" style="font-size:0.8125rem; font-style:italic;">Complete all datasets and submissions before proceeding to Validation.</div>
                </div>
              </div>
              
              <!-- 2️⃣ Unified Dataset + Submissions Table -->
              <div style="margin-bottom:var(--spacing-xl);">
                <h4 style="margin:0 0 var(--spacing-md) 0; color:var(--color-text-main);">Dataset & Submission Status</h4>
                <table id="unified-data-table">
                  <thead>
                    <tr>
                      <th>Dataset</th>
                      <th>Required</th>
                      <th>DSF Status</th>
                      <th>Period</th>
                      <th>Insurer Submission</th>
                      <th>Last Updated</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="unified-data-tbody">
                    <!-- Row 1: Claims - Complete -->
                    <tr data-required="true" data-dsf-status="fetched" data-submission-status="received" data-period-ok="true" data-dataset="Claims">
                      <td><strong>Claims</strong></td>
                      <td>Yes</td>
                      <td><span class="chip ok">✓ Fetched</span></td>
                      <td>2025-Q3</td>
                      <td>
                        <span class="chip ok">✓ Received</span>
                        <div style="font-size:0.75rem; color:var(--color-text-muted); margin-top:0.25rem;">claims_2025_q3.xlsx</div>
                      </td>
                      <td>12-Nov-2025 10:05</td>
                      <td><button class="btn small link" type="button" onclick="alert('View details for Claims')">View details</button></td>
                    </tr>
                    
                    <!-- Row 2: Underwriting - Missing -->
                    <tr data-required="true" data-dsf-status="missing" data-submission-status="not-received" data-period-ok="false" data-dataset="Underwriting">
                      <td><strong>Underwriting</strong></td>
                      <td>Yes</td>
                      <td><span class="chip miss">✗ Missing</span></td>
                      <td>—</td>
                      <td><span class="chip miss">✗ Not received</span></td>
                      <td>—</td>
                      <td><button class="btn small request-again-btn" type="button" data-dataset="Underwriting">Request again</button></td>
                    </tr>
                    
                    <!-- Row 3: Grievances - Missing -->
                    <tr data-required="true" data-dsf-status="missing" data-submission-status="not-received" data-period-ok="false" data-dataset="Grievances">
                      <td><strong>Grievances</strong></td>
                      <td>Yes</td>
                      <td><span class="chip miss">✗ Missing</span></td>
                      <td>—</td>
                      <td><span class="chip miss">✗ Not received</span></td>
                      <td>—</td>
                      <td><button class="btn small request-again-btn" type="button" data-dataset="Grievances">Request again</button></td>
                    </tr>
                    
                    <!-- Row 4: Sales/Agents - Missing -->
                    <tr data-required="true" data-dsf-status="missing" data-submission-status="not-received" data-period-ok="false" data-dataset="Sales/Agents">
                      <td><strong>Sales/Agents</strong></td>
                      <td>Yes</td>
                      <td><span class="chip miss">✗ Missing</span></td>
                      <td>—</td>
                      <td><span class="chip miss">✗ Not received</span></td>
                      <td>—</td>
                      <td><button class="btn small request-again-btn" type="button" data-dataset="Sales/Agents">Request again</button></td>
                    </tr>
                  </tbody>
                </table>
              </div>
              
            </div>
            
            <!-- 3️⃣ Gaps & Required Actions Panel (Sidebar) -->
            <aside id="gaps-panel" class="step-tasks" data-step="2">
              <h4>Gaps & Required Actions</h4>
              
              <div style="margin-bottom:var(--spacing-lg);">
                <div style="font-weight:600; font-size:0.875rem; margin-bottom:var(--spacing-sm); color:var(--color-accent-error-text);">Missing datasets:</div>
                <ul id="gaps-missing-datasets" style="list-style:none; padding-left:0; margin:0; font-size:0.875rem;">
                  <li style="margin-bottom:var(--spacing-xs);">• Underwriting</li>
                  <li style="margin-bottom:var(--spacing-xs);">• Grievances</li>
                  <li style="margin-bottom:var(--spacing-xs);">• Sales/Agents</li>
                </ul>
              </div>
              
              <div style="margin-bottom:var(--spacing-lg);">
                <div style="font-weight:600; font-size:0.875rem; margin-bottom:var(--spacing-sm); color:var(--color-accent-error-text);">Missing submissions:</div>
                <ul id="gaps-missing-submissions" style="list-style:none; padding-left:0; margin:0; font-size:0.875rem;">
                  <li style="margin-bottom:var(--spacing-xs);">• Underwriting</li>
                  <li style="margin-bottom:var(--spacing-xs);">• Grievances</li>
                  <li style="margin-bottom:var(--spacing-xs);">• Sales/Agents</li>
                </ul>
              </div>
              
              <div style="margin-bottom:var(--spacing-lg);">
                <div style="font-weight:600; font-size:0.875rem; margin-bottom:var(--spacing-sm); color:var(--color-accent-warning-text);">Period issues:</div>
                <ul id="gaps-period-issues" style="list-style:none; padding-left:0; margin:0; font-size:0.875rem;">
                  <li style="margin-bottom:var(--spacing-xs);">• Underwriting</li>
                  <li style="margin-bottom:var(--spacing-xs);">• Grievances</li>
                  <li style="margin-bottom:var(--spacing-xs);">• Sales/Agents</li>
                </ul>
              </div>
              
              <button id="btn-trigger-all-reminders" type="button" style="width:100%; padding:0.625rem; font-size:0.875rem;">Trigger All Reminders</button>
            </aside>
          </div>
        </div>

        <!-- Step 3: Data Validation -->
        <div class="card" id="step-3" style="display:none; margin-top:var(--spacing-xl);">
          <h3 style="color:var(--color-primary); margin-bottom:var(--spacing-md);">Data Validation <span class="chip stage-chip" data-step="3" style="display:none;">Stage completed</span></h3>
          <div class="step-layout">
            <div class="step-main">
              <div class="muted">Automatic checks for structure, completeness, mandatory fields, and formats.</div>
              <div class="row" style="margin-top:var(--spacing-lg); gap:var(--spacing-xl);">
                <div class="col">
                  <div class="card" style="padding:var(--spacing-xl); background:var(--color-surface);">
                    <h4 style="margin:0 0 var(--spacing-lg) 0; color:var(--color-text-main);">Validation Results</h4>
                    <div style="display:grid; gap:var(--spacing-md); margin-bottom:var(--spacing-lg);">
                      <div><b>Records processed:</b> <span id="val-rows">12,432</span></div>
                      <div><b>Exceptions:</b> <span id="val-exc">27</span></div>
                      <div><b>High severity:</b> <span id="val-high">5</span> <span class="chip miss">High</span></div>
                    </div>
                    <div style="padding:var(--spacing-md); background:var(--color-primary-bg); border-radius:var(--radius-md); margin-bottom:var(--spacing-lg);">
                      <p id="validationStatusText" class="muted" style="font-size:0.875rem; margin:0 0 var(--spacing-xs) 0;">Validation not run yet.</p>
                      <p id="validationLastRunText" class="muted" style="font-size:0.875rem; margin:0;">Last run: –</p>
                    </div>
                    <div style="display:flex; flex-direction:column; gap:var(--spacing-md);">
                      <button id="runValidationBtn" type="button" style="width:100%;">Run Validation</button>
                      <button id="downloadExceptionBtn" type="button" style="width:100%;">Download Exception Report</button>
                      <button id="requestCorrectedDataBtn" type="button" class="secondary" style="width:100%;">Request Corrected Data</button>
                    </div>
                  </div>
                </div>
                <div class="col">
                  <div class="card" style="padding:var(--spacing-xl); background:var(--color-surface); display:flex; flex-direction:column; height:100%;">
                    <h4 style="margin:0 0 var(--spacing-md) 0; color:var(--color-text-main);">Sample Issues</h4>
                    <ul style="flex:1; margin:0; padding-left:var(--spacing-xl);">
                      <li style="margin-bottom:var(--spacing-sm);">Missing Policy ID (9)</li>
                      <li style="margin-bottom:var(--spacing-sm);">Invalid Date Format (6)</li>
                      <li style="margin-bottom:var(--spacing-sm);">Claim TAT value out of range (12)</li>
                    </ul>
                    <button id="proceedToRegChecksBtn" type="button" disabled style="width:100%; margin-top:var(--spacing-xl);">Proceed to Regulatory Checks</button>
                  </div>
                </div>
              </div>
            </div>
            <aside class="step-tasks" data-step="3">
              <h4>Tasks in this stage</h4>
              <div class="task-item" id="task-run-validation" data-task="runValidation" data-task-id="runValidationTask">
                <span class="task-icon status-pending task-status-icon">✕</span>
                <span>Run validation rules on all datasets</span>
              </div>
              <div class="task-item" id="task-review-errors" data-task="reviewErrors" data-task-id="reviewErrorsTask">
                <span class="task-icon status-pending task-status-icon">✕</span>
                <span>Review failed records and error counts</span>
              </div>
              <div class="task-item" id="task-send-to-insurer" data-task="sendToInsurer" data-task-id="sendToInsurerTask">
                <span class="task-icon status-pending task-status-icon">✕</span>
                <span>Send validation issues to insurer</span>
              </div>
              <div class="task-item" id="task-finalize-dataset" data-task="finalizeDataset" data-task-id="finalizeDatasetTask">
                <span class="task-icon status-pending task-status-icon">✕</span>
                <span>Finalize cleaned dataset for analysis</span>
              </div>
            </aside>
          </div>
        </div>

        <!-- Step 4: Regulatory Check -->
        <div class="card" id="step-4" style="display:none; margin-top:var(--spacing-xl);">
          <h3 style="color:var(--color-primary); margin-bottom:var(--spacing-md);">Regulatory Checklist & Automated Checks <span class="chip stage-chip" data-step="4" style="display:none;">Stage completed</span></h3>
          <div class="step-layout">
            <div class="step-main">
              <div class="row" style="margin-top:8px; align-items:center;">
                <div class="muted">Filter:</div>
                <button class="link" type="button" data-sev="All">All</button>
                <button class="link" type="button" data-sev="High">High</button>
                <button class="link" type="button" data-sev="Medium">Medium</button>
                <button class="link" type="button" data-sev="Low">Low</button>
              </div>
              <table style="margin-top:8px;">
                <thead><tr><th>Rule</th><th>Breach</th><th>Severity</th><th>Count</th></tr></thead>
                <tbody id="reg-table">
                  <tr data-sev="High"><td>Claims TAT &gt; SLA</td><td>Exceeded 30 days</td><td><span class="chip miss">High</span></td><td>12</td></tr>
                  <tr data-sev="High"><td>Repudiation cluster</td><td>Above baseline in region</td><td><span class="chip miss">High</span></td><td>6</td></tr>
                  <tr data-sev="Medium"><td>Grievance closure time</td><td>&gt; 15 days</td><td><span class="chip warn">Medium</span></td><td>9</td></tr>
                  <tr data-sev="Low"><td>Commission variance</td><td>&gt; 2σ of product</td><td><span class="chip info">Low</span></td><td>18</td></tr>
                </tbody>
              </table>
              <div style="margin-top:10px;">
                <button id="btn4-run-reg-checks" type="button">Run Regulatory Checks</button>
                <button id="btn4-review-breaches" type="button" class="secondary">Review Breaches</button>
                <button id="btn4-tag-for-observations" type="button" class="secondary">Tag for Observations</button>
                <button id="btn4-proceed-analytics" type="button">Proceed to Analytics & Sampling</button>
              </div>
            </div>
            <aside class="step-tasks" data-step="4">
              <h4>Tasks in this stage</h4>
              <div class="task-item" id="task4-run-reg-checks" data-task="runRegChecks">
                <span class="task-icon status-pending">✕</span>
                <span>Run regulatory checklist rules</span>
              </div>
              <div class="task-item" id="task4-review-high-severity" data-task="reviewHighSeverity">
                <span class="task-icon status-pending">✕</span>
                <span>Review HIGH severity breaches</span>
              </div>
              <div class="task-item" id="task4-tag-breaches" data-task="tagBreaches">
                <span class="task-icon status-pending">✕</span>
                <span>Tag breaches for observation drafting</span>
              </div>
              <div class="task-item" id="task4-park-items" data-task="parkItems">
                <span class="task-icon status-pending">✕</span>
                <span>Park items needing more data or clarification</span>
              </div>
            </aside>
          </div>
        </div>

        <!-- Step 5: Analytics & Sampling -->
        <div class="card" id="step-5" style="display:none; margin-top:var(--spacing-xl);">
          <h3 style="color:var(--color-primary); margin-bottom:var(--spacing-md);">Analytics & Risk-Based Sampling <span class="chip stage-chip" data-step="5" style="display:none;">Stage completed</span></h3>
          <div class="step-layout">
            <div class="step-main">
              <div class="row" style="margin-top:8px;">
                <div class="col">
                  <div class="muted">Risk Scores</div>
                  <div style="margin-top:6px;">
                    <div class="row" style="align-items:center;"><div style="width:160px;">ICICI Lombard</div><div class="bar" style="flex:1;"><i style="width:85%"></i></div><div style="width:40px; text-align:right;">85</div></div>
                    <div class="row" style="align-items:center; margin-top:8px;"><div style="width:160px;">SBI Life</div><div class="bar" style="flex:1;"><i style="width:60%"></i></div><div style="width:40px; text-align:right;">60</div></div>
                    <div class="row" style="align-items:center; margin-top:8px;"><div style="width:160px;">LIC</div><div class="bar" style="flex:1;"><i style="width:40%"></i></div><div style="width:40px; text-align:right;">40</div></div>
                  </div>
                  <div class="card" style="margin-top:10px; padding:12px;">
                    <b>Insights</b>
                    <ul style="margin-top:6px;">
                      <li>Uptrend in claim repudiations in Q3</li>
                      <li>Anomaly: High refunds in branch #441</li>
                      <li>Early warning: Rising complaint rate in motor TP</li>
                    </ul>
                  </div>
                </div>
                <div class="col">
                  <div class="muted">Suggested Sample (editable)</div>
                  <table style="margin-top:6px;">
                    <thead><tr><th>Case ID</th><th>Reason</th><th></th></tr></thead>
                    <tbody id="sample-table">
                      <tr><td>CL-2115</td><td>High repudiation</td><td><button class="link del" type="button">Remove</button></td></tr>
                      <tr><td>CL-2100</td><td>Long TAT</td><td><button class="link del" type="button">Remove</button></td></tr>
                      <tr><td>CL-2091</td><td>Missing policy ID</td><td><button class="link del" type="button">Remove</button></td></tr>
                    </tbody>
                  </table>
                  <div class="row" style="margin-top:8px;">
                    <input id="add-id" placeholder="Add Case ID" style="flex:1;">
                    <button id="add-case" type="button">Add</button>
                  </div>
                </div>
              </div>
              <div class="card" style="margin-top:12px; padding:12px;">
                <h4 style="margin:0 0 6px 0;">Additional Documents / Clarification Requests</h4>
                <table>
                  <thead><tr><th>Case ID</th><th>Request</th><th>Status</th><th>Action</th></tr></thead>
                  <tbody id="clarify-table">
                    <tr><td>CL-2100</td><td>Discharge summary & hospital bill copy</td><td><span class="chip warn">Pending</span></td><td><button class="link mark-rec" type="button">Mark Received</button></td></tr>
                    <tr><td>CL-2115</td><td>Underwriting notes & agent memo</td><td><span class="chip warn">Pending</span></td><td><button class="link mark-rec" type="button">Mark Received</button></td></tr>
                  </tbody>
                </table>
                <div class="row" style="margin-top:8px;">
                  <input id="clarify-id" placeholder="Case ID">
                  <input id="clarify-text" placeholder="Request details" style="flex:1;">
                  <button id="clarify-add" type="button">Add Request</button>
                </div>
              </div>
              <div class="row" style="margin-top:10px;">
                <button id="btn5-run-analytics" type="button">Run Analytics</button>
                <button id="btn5-generate-risk-scores" type="button" class="secondary">Generate Risk Scores</button>
                <button id="btn5-create-sample" type="button" class="secondary">Create Sample</button>
                <button id="btn5-finalize-sample" type="button">Finalize Sample (for Onsite)</button>
              </div>
            </div>
            <aside class="step-tasks" data-step="5">
              <h4>Tasks in this stage</h4>
              <div class="task-item" id="task5-run-analytics" data-task="runAnalytics">
                <span class="task-icon status-pending">✕</span>
                <span>Review analytics results and risk scores</span>
              </div>
              <div class="task-item" id="task5-adjust-sampling" data-task="adjustSampling">
                <span class="task-icon status-pending">✕</span>
                <span>Adjust sampling logic if required</span>
              </div>
              <div class="task-item" id="task5-generate-sample" data-task="generateSample">
                <span class="task-icon status-pending">✕</span>
                <span>Generate recommended sample list</span>
              </div>
              <div class="task-item" id="task5-finalize-sample" data-task="finalizeSample">
                <span class="task-icon status-pending">✕</span>
                <span>Finalize sample set for onsite inspection</span>
              </div>
            </aside>
          </div>
        </div>

        <!-- Step 6: Onsite -->
        <div class="card" id="step-6" style="display:none; margin-top:var(--spacing-xl);">
          <h3 style="color:var(--color-primary); margin-bottom:var(--spacing-md);">Onsite Inspection Support <span class="chip stage-chip" data-step="6" style="display:none;">Stage completed</span></h3>
          <div class="step-layout">
            <div class="step-main">
              <div class="row" style="margin-top:8px;">
                <div class="col">
                  <div class="muted">Case Files</div>
                  <table style="margin-top:6px;">
                    <thead><tr><th>Case ID</th><th>Open</th></tr></thead>
                    <tbody id="onsite-cases">
                      <tr><td>CL-2100</td><td><button class="link" type="button">Open file</button></td></tr>
                      <tr><td>CL-2115</td><td><button class="link" type="button">Open file</button></td></tr>
                      <tr><td>CL-2091</td><td><button class="link" type="button">Open file</button></td></tr>
                    </tbody>
                  </table>
                </div>
                <div class="col">
                  <div class="muted">Notes / Evidence</div>
                  <textarea id="onsite-notes" placeholder="Record interviews, walkthroughs, findings..." style="width:100%; height:120px; margin-top:6px;"></textarea>
                  <div class="row" style="margin-top:6px; align-items:center;">
                    <button id="btn6-download-sample-file" type="button" class="btn small">Download Sample</button>
                    <button id="btn6-save-notes" type="button" class="btn small">Save Notes</button>
                    <button id="btn6-upload-evidence" type="button" class="btn small">Upload Evidence</button>
                    <button id="btn6-proceed-report" type="button">Proceed to Report</button>
                  </div>
                </div>
              </div>
            </div>

            <aside class="step-tasks" data-step="6">
              <h4>Tasks in this stage</h4>
              <div class="task-item" id="task6-download-sample" data-task="downloadSample">
                <span class="task-icon status-pending">✕</span>
                <span>Download final sample file for fieldwork</span>
              </div>
              <div class="task-item" id="task6-capture-notes" data-task="captureNotes">
                <span class="task-icon status-pending">✕</span>
                <span>Capture onsite notes / interviews in the portal</span>
              </div>
              <div class="task-item" id="task6-upload-evidence" data-task="uploadEvidence">
                <span class="task-icon status-pending">✕</span>
                <span>Upload evidence (documents / screenshots)</span>
              </div>
              <div class="task-item" id="task6-flag-issues" data-task="flagIssues">
                <span class="task-icon status-pending">✕</span>
                <span>Flag high-risk issues found onsite</span>
              </div>
            </aside>
          </div>
        </div>

        <!-- Step 7: Observations & Report -->
        <div class="card" id="step-7" style="display:none; margin-top:var(--spacing-xl);">
          <h3 style="color:var(--color-primary); margin-bottom:var(--spacing-md);">Observations & Report <span class="chip stage-chip" data-step="7" style="display:none;">Stage completed</span></h3>
          <div class="step-layout">
            <div class="step-main">
              <!-- Observations Table -->
              <table>
                <thead>
                  <tr>
                    <th>Observation</th>
                    <th>Severity</th>
                    <th>Evidence Count</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="obs-table-step7">
                  <tr>
                    <td>Delayed claim TAT beyond SLA in 12 cases</td>
                    <td><span class="chip miss">High</span></td>
                    <td>3</td>
                    <td>Draft</td>
                  </tr>
                  <tr>
                    <td>Missing policy IDs in claims</td>
                    <td><span class="chip warn">Medium</span></td>
                    <td>2</td>
                    <td>Draft</td>
                  </tr>
                </tbody>
              </table>

              <!-- Add Observation Form -->
              <div class="row" style="margin-top:var(--spacing-lg);">
                <input id="obs-text-step7" placeholder="Issue, rule breached, evidence, impact..." style="flex:2;">
                <select id="obs-sev-step7" style="flex:0 0 140px;">
                  <option>High</option>
                  <option>Medium</option>
                  <option>Low</option>
                </select>
                <button id="btn7-add-observation" type="button">Add Observation</button>
              </div>

              <!-- Inspection Report -->
              <div class="card" style="margin-top:var(--spacing-2xl); padding:var(--spacing-xl); background:var(--color-bg);">
                <h4 style="margin:0 0 var(--spacing-lg) 0; color:var(--color-primary);">Inspection Report</h4>
                <div class="row">
                  <div class="col">
                    <label>Executive Summary</label>
                    <textarea id="exec-step7" style="width:100%; height:140px; margin-top:var(--spacing-sm);" placeholder="Draft executive summary..."></textarea>
                  </div>
                  <div class="col">
                    <label>Recommendations</label>
                    <textarea id="reco-step7" style="width:100%; height:140px; margin-top:var(--spacing-sm);" placeholder="Key recommendations..."></textarea>
                  </div>
                </div>
                <div class="row" style="margin-top:var(--spacing-lg); gap:var(--spacing-md);">
                  <button id="btn7-draft-report" type="button" class="secondary">Draft Report</button>
                  <button id="btn7-generate-pdf" type="button">Generate Report (PDF)</button>
                  <button id="btn7-finalize-report" type="button">Finalize & Lock Report</button>
                  <button id="btn7-share-report" type="button" class="secondary">Share with Insurer</button>
                </div>
              </div>
            </div>

            <!-- Right Sidebar Tasks -->
            <aside class="step-tasks" data-step="7">
              <h4>Tasks in this stage</h4>
              <div class="task-item" id="task7-draft-observations" data-task="draftObservations">
                <span class="task-icon status-pending">✕</span>
                <span>Draft observations for key issues</span>
              </div>
              <div class="task-item" id="task7-attach-evidence" data-task="attachEvidence">
                <span class="task-icon status-pending">✕</span>
                <span>Attach evidence to each observation</span>
              </div>
              <div class="task-item" id="task7-review-observations" data-task="reviewObservations">
                <span class="task-icon status-pending">✕</span>
                <span>Review & refine observations</span>
              </div>
              <div class="task-item" id="task7-generate-report" data-task="generateReport">
                <span class="task-icon status-pending">✕</span>
                <span>Generate draft inspection report</span>
              </div>
              <div class="task-item" id="task7-finalize-report" data-task="finalizeReport">
                <span class="task-icon status-pending">✕</span>
                <span>Mark report ready for management review</span>
              </div>
            </aside>
          </div>
        </div>

      </div>
    </div>

    <!-- ========== COMPANY DASHBOARD ========== -->
    <div id="company-dashboard" style="display:none;">
      <div style="margin-bottom:var(--spacing-xl); display:flex; align-items:center; gap:var(--spacing-lg); flex-wrap:wrap;">
        <button id="btn-back-to-inspections" type="button" class="btn secondary">← Back to Inspections List</button>
        <div style="display:flex; align-items:center; gap:var(--spacing-md);">
          <label for="company-selector" style="font-weight:600; color:var(--color-text-main); margin:0; white-space:nowrap;">Select Insurer:</label>
          <select id="company-selector" style="min-width:280px; padding:0.625rem 0.875rem; border:2px solid var(--color-primary); border-radius:var(--radius-md); font-weight:600; color:var(--color-primary); background:white;">
            <option value="">-- Select Insurer --</option>
            <option value="LIC">LIC</option>
            <option value="ICICI Lombard">ICICI Lombard</option>
            <option value="SBI Life">SBI Life</option>
            <option value="HDFC Ergo">HDFC Ergo</option>
            <option value="Wisdom General Insurance Co. Ltd." selected>Wisdom General Insurance Co. Ltd.</option>
          </select>
        </div>
        <button type="button" class="btn" onclick="console.log('View all inspections for this insurer')">View All Inspections for This Insurer</button>
      </div>

      <!-- Row 1: Company Header & Snapshot -->
      <div class="company-header">
        <h1>
          <span id="company-name">Wisdom General Insurance Company Ltd.</span>
          <span class="company-type-badge">General Insurance</span>
        </h1>
        
        <div class="company-meta">
          <div class="company-meta-item">
            <div class="company-meta-label">Total Inspections (Last 3 Years)</div>
            <div class="company-meta-value" id="meta-total-inspections">7</div>
          </div>
          <div class="company-meta-item">
            <div class="company-meta-label">Data Quality Score</div>
            <div class="company-meta-value" id="meta-data-quality">72/100</div>
          </div>
          <div class="company-meta-item">
            <div class="company-meta-label">Regulatory Compliance Score</div>
            <div class="company-meta-value" id="meta-compliance-score">68/100</div>
          </div>
          <div class="company-meta-item">
            <div class="company-meta-label">Overall Risk Rating</div>
            <div class="company-meta-value" id="meta-risk-rating" style="color:#ef4444; font-weight:700;">High <span class="trend-arrow trend-up" style="font-size:1.25rem;">↑</span></div>
          </div>
        </div>
      </div>

      <!-- Row 2: Inspection History Timeline + Stats -->
      <div class="dashboard-section">
        <h3 class="section-title" onclick="toggleSection('section-1')">
          <span class="section-toggle-icon" id="toggle-icon-1">▼</span>
          <span>Inspection History & Statistics</span>
        </h3>
        <div class="dashboard-row section-content" id="section-1">
          <!-- Left: Timeline -->
          <div class="card">
            <h4 style="color:var(--color-primary); margin-bottom:var(--spacing-lg);">Inspection Timeline</h4>
            <div class="timeline">
              <div class="timeline-item">
                <div class="timeline-date">Nov 2024</div>
                <div class="timeline-type">On-site Inspection</div>
              </div>
              <div class="timeline-item">
                <div class="timeline-date">Jun 2024</div>
                <div class="timeline-type">Thematic Review – Health Claims</div>
              </div>
              <div class="timeline-item">
                <div class="timeline-date">Feb 2024</div>
                <div class="timeline-type">Off-site Inspection</div>
              </div>
              <div class="timeline-item">
                <div class="timeline-date">Sep 2023</div>
                <div class="timeline-type">On-site Inspection</div>
              </div>
              <div class="timeline-item">
                <div class="timeline-date">Apr 2023</div>
                <div class="timeline-type">Off-site Inspection</div>
              </div>
              <div class="timeline-item">
                <div class="timeline-date">Nov 2022</div>
                <div class="timeline-type">Thematic Review – Motor OD</div>
              </div>
              <div class="timeline-item">
                <div class="timeline-date">Mar 2022</div>
                <div class="timeline-type">On-site Inspection</div>
              </div>
            </div>
          </div>

          <!-- Right: Stats -->
          <div class="card">
            <h4 style="color:var(--color-primary); margin-bottom:var(--spacing-lg);">Inspection Statistics</h4>
            
            <div class="mini-stats">
              <div class="mini-stat">
                <div class="mini-stat-label">Total (5 Years)</div>
                <div class="mini-stat-value">12</div>
              </div>
              <div class="mini-stat">
                <div class="mini-stat-label">Avg. Gap (Months)</div>
                <div class="mini-stat-value">5.2</div>
              </div>
            </div>

            <div style="margin-top:var(--spacing-2xl);">
              <h5 style="margin-bottom:var(--spacing-lg); color:var(--color-text-main);">Breakdown by Type</h5>
              <table style="font-size:0.9375rem;">
                <thead>
                  <tr>
                    <th>Type</th>
                    <th>Count</th>
                    <th>Last Conducted</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>On-site</td>
                    <td><strong>4</strong></td>
                    <td>Nov 2024</td>
                  </tr>
                  <tr>
                    <td>Off-site</td>
                    <td><strong>5</strong></td>
                    <td>Feb 2024</td>
                  </tr>
                  <tr>
                    <td>Thematic</td>
                    <td><strong>3</strong></td>
                    <td>Jun 2024</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div style="margin-top:var(--spacing-2xl); padding:var(--spacing-lg); background:var(--color-primary-bg); border-radius:var(--radius-md);">
              <div style="display:flex; justify-content:space-between; margin-bottom:var(--spacing-sm);">
                <span style="font-weight:600; font-size:0.875rem;">Last Inspection:</span>
                <span style="color:var(--color-primary); font-weight:700;">15-Nov-2024</span>
              </div>
              <div style="display:flex; justify-content:space-between;">
                <span style="font-weight:600; font-size:0.875rem;">Next Inspection Planned:</span>
                <span style="color:var(--color-primary); font-weight:700;">Q2 FY 2025–26</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Row 3: Recurring Issues & Risk Drivers -->
      <div class="dashboard-section">
        <h3 class="section-title" onclick="toggleSection('section-2')">
          <span class="section-toggle-icon" id="toggle-icon-2">▼</span>
          <span>Recurring Issues & Risk Profile</span>
        </h3>
        <div class="dashboard-row section-content" id="section-2">
          <!-- Left: Recurring Issues -->
          <div class="card">
            <h4 style="color:var(--color-primary); margin-bottom:var(--spacing-lg);">Recurring Supervisory Issues</h4>
            <table>
              <thead>
                <tr>
                  <th>Issue</th>
                  <th>Times Observed</th>
                  <th>Last Observed</th>
                  <th>Trend</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td style="font-weight:600;">Delayed claim settlement in motor OD</td>
                  <td><strong>4</strong></td>
                  <td>Nov 2024</td>
                  <td><span class="trend-arrow trend-up">↑</span> <span style="color:var(--color-accent-error); font-weight:600;">Worsening</span></td>
                </tr>
                <tr>
                  <td style="font-weight:600;">High grievance ratio in health products</td>
                  <td><strong>3</strong></td>
                  <td>Sep 2024</td>
                  <td><span class="trend-arrow trend-stable">→</span> <span style="color:var(--color-accent-warning); font-weight:600;">Stable</span></td>
                </tr>
                <tr>
                  <td style="font-weight:600;">Inadequate board oversight on risk management</td>
                  <td><strong>3</strong></td>
                  <td>Jun 2024</td>
                  <td><span class="trend-arrow trend-down">↓</span> <span style="color:var(--color-accent-success); font-weight:600;">Improving</span></td>
                </tr>
                <tr>
                  <td style="font-weight:600;">Data quality issues in policy master</td>
                  <td><strong>5</strong></td>
                  <td>Nov 2024</td>
                  <td><span class="trend-arrow trend-up">↑</span> <span style="color:var(--color-accent-error); font-weight:600;">Worsening</span></td>
                </tr>
                <tr>
                  <td style="font-weight:600;">Mis-selling through bancassurance channel</td>
                  <td><strong>2</strong></td>
                  <td>Apr 2024</td>
                  <td><span class="trend-arrow trend-stable">→</span> <span style="color:var(--color-accent-warning); font-weight:600;">Stable</span></td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Right: Risk Heatmap -->
          <div class="card">
            <h4 style="color:var(--color-primary); margin-bottom:var(--spacing-lg);">Entity Risk Heatmap</h4>
            <table class="risk-heatmap">
              <thead>
                <tr>
                  <th>Risk Area</th>
                  <th>Current Rating</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td style="font-weight:600; text-align:left; padding-left:var(--spacing-lg);">Underwriting</td>
                  <td class="risk-medium">Medium</td>
                </tr>
                <tr>
                  <td style="font-weight:600; text-align:left; padding-left:var(--spacing-lg);">Claims</td>
                  <td class="risk-high">High</td>
                </tr>
                <tr>
                  <td style="font-weight:600; text-align:left; padding-left:var(--spacing-lg);">Operations</td>
                  <td class="risk-medium">Medium</td>
                </tr>
                <tr>
                  <td style="font-weight:600; text-align:left; padding-left:var(--spacing-lg);">Sales & Distribution</td>
                  <td class="risk-high">High</td>
                </tr>
                <tr>
                  <td style="font-weight:600; text-align:left; padding-left:var(--spacing-lg);">Governance & Compliance</td>
                  <td class="risk-medium">Medium</td>
                </tr>
              </tbody>
            </table>

            <div style="margin-top:var(--spacing-2xl); padding:var(--spacing-lg); background:#fff3cd; border:2px solid #f59e0b; border-radius:var(--radius-md);">
              <strong style="color:#92400e; display:block; margin-bottom:var(--spacing-sm);">Key Risk Drivers:</strong>
              <ul style="margin:0; padding-left:var(--spacing-xl); color:var(--color-text-main);">
                <li>Persistent claim settlement delays (Claims)</li>
                <li>Elevated mis-selling incidents (Distribution)</li>
                <li>Data quality gaps impacting regulatory reporting</li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <!-- Row 4: Data Quality Profile + Regulatory Compliance -->
      <div class="dashboard-section">
        <h3 class="section-title" onclick="toggleSection('section-3')">
          <span class="section-toggle-icon" id="toggle-icon-3">▼</span>
          <span>Data Quality & Regulatory Compliance</span>
        </h3>
        <div class="dashboard-row section-content" id="section-3">
          <!-- Left: Data Quality -->
          <div class="card">
            <h4 style="color:var(--color-primary); margin-bottom:var(--spacing-lg);">Data Quality Profile</h4>
            
            <div class="quality-score">
              <div class="quality-score-label">Data Quality Score</div>
              <div class="quality-score-value">72<span style="font-size:1.5rem; color:var(--color-text-muted);">/100</span></div>
            </div>

            <div class="mini-stats">
              <div class="mini-stat">
                <div class="mini-stat-label">Avg. Validation Exceptions</div>
                <div class="mini-stat-value">48</div>
              </div>
              <div class="mini-stat">
                <div class="mini-stat-label">Clean Data Inspections</div>
                <div class="mini-stat-value">2/7</div>
              </div>
              <div class="mini-stat">
                <div class="mini-stat-label">Avg. Submission Delay</div>
                <div class="mini-stat-value">3 days</div>
              </div>
            </div>

            <h5 style="margin:var(--spacing-xl) 0 var(--spacing-lg) 0; color:var(--color-text-main);">Top Validation Breaches</h5>
            <table style="font-size:0.875rem;">
              <thead>
                <tr>
                  <th>Validation Rule</th>
                  <th>Breaches</th>
                  <th>Inspections</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Sum of portfolio premiums ≠ total premium</td>
                  <td><span class="chip miss">3</span></td>
                  <td>2</td>
                </tr>
                <tr>
                  <td>Missing mandatory fields in policy master</td>
                  <td><span class="chip miss">5</span></td>
                  <td>3</td>
                </tr>
                <tr>
                  <td>Negative claim amounts / invalid dates</td>
                  <td><span class="chip warn">2</span></td>
                  <td>2</td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Right: Regulatory Compliance -->
          <div class="card">
            <h4 style="color:var(--color-primary); margin-bottom:var(--spacing-lg);">Regulatory Compliance Behaviour</h4>
            
            <div class="compliance-score">
              <div class="quality-score-label">Regulatory Compliance Score</div>
              <div class="compliance-score-value">68<span style="font-size:1.5rem; color:var(--color-text-muted);">/100</span></div>
            </div>

            <div class="severity-chips">
              <div class="severity-chip severity-critical">
                <strong>3</strong> Critical Breaches
              </div>
              <div class="severity-chip severity-moderate">
                <strong>7</strong> Moderate Breaches
              </div>
              <div class="severity-chip severity-minor">
                <strong>15</strong> Minor Observations
              </div>
            </div>

            <h5 style="margin:var(--spacing-xl) 0 var(--spacing-lg) 0; color:var(--color-text-main);">Top Failed Regulations</h5>
            <table style="font-size:0.875rem;">
              <thead>
                <tr>
                  <th>Regulation / Guideline</th>
                  <th>Breaches</th>
                  <th>Last Observed</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td style="font-weight:600;">Health Regulations 2016 – TPA management</td>
                  <td><span class="chip miss">4</span></td>
                  <td>Nov 2024</td>
                </tr>
                <tr>
                  <td style="font-weight:600;">Protection of Policyholders' Interests – Sec 6 (Claims)</td>
                  <td><span class="chip miss">3</span></td>
                  <td>Sep 2024</td>
                </tr>
                <tr>
                  <td style="font-weight:600;">IRDAI Circular IRDA/F&I/CIR/INV/042/03/2016 – Investments</td>
                  <td><span class="chip warn">2</span></td>
                  <td>Jun 2024</td>
                </tr>
                <tr>
                  <td style="font-weight:600;">Corporate Governance Guidelines – Board Oversight</td>
                  <td><span class="chip warn">3</span></td>
                  <td>Jun 2024</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Row 5: Supervisory Scorecard & Forward Actions -->
      <div class="dashboard-section">
        <h3 class="section-title" onclick="toggleSection('section-4')">
          <span class="section-toggle-icon" id="toggle-icon-4">▼</span>
          <span>Supervisory Focus & Forward Actions</span>
        </h3>
        <div class="dashboard-row section-content" id="section-4">
          <!-- Left: Scorecard -->
          <div class="card">
            <h4 style="color:var(--color-primary); margin-bottom:var(--spacing-lg);">Supervisory Focus</h4>
            <table class="Focus-table">
              <thead>
                <tr>
                  <th>Area</th>
                  <th>Status</th>
                  <th>Comment</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td style="font-weight:600;">Claims</td>
                  <td><span class="chip badge-red">Red</span></td>
                  <td style="font-size:0.875rem;">Persistent delays in settlement for motor & health</td>
                </tr>
                <tr>
                  <td style="font-weight:600;">Data Quality</td>
                  <td><span class="chip badge-amber">Amber</span></td>
                  <td style="font-size:0.875rem;">Improving, but recurring validation failures</td>
                </tr>
                <tr>
                  <td style="font-weight:600;">Governance</td>
                  <td><span class="chip badge-amber">Amber</span></td>
                  <td style="font-size:0.875rem;">Board oversight adequate; follow-up on previous directions pending</td>
                </tr>
                <tr>
                  <td style="font-weight:600;">Distribution</td>
                  <td><span class="chip badge-red">Red</span></td>
                  <td style="font-size:0.875rem;">Mis-selling complaints in bancassurance channels</td>
                </tr>
                <tr>
                  <td style="font-weight:600;">Product Filing</td>
                  <td><span class="chip badge-green">Green</span></td>
                  <td style="font-size:0.875rem;">No major recent issues</td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Right: Forward Actions -->
          <div class="card">
            <div class="action-list">
              <h4>
                <span style="font-size:1.5rem;">📋</span>
                Forward Supervisory Actions (Next 12–24 months)
              </h4>
              <ol>
                <li><strong>Thematic review of health claims processing</strong> – Scheduled for Q3 FY 2025–26</li>
                <li><strong>Focused inspection on motor OD underwriting quality</strong> – To assess pricing adequacy and risk selection</li>
                <li><strong>Review of grievance redressal framework and escalation matrix</strong> – Follow-up from Sec 34 direction</li>
                <li><strong>Follow-up on compliance with Sec 34 directions issued in Nov 2024</strong> – Pending resolution</li>
                <li><strong>Data quality enhancement program</strong> – Monitoring improvement in validation exception rates</li>
              </ol>
            </div>

            <div style="margin-top:var(--spacing-2xl); padding:var(--spacing-xl); background:var(--color-primary-bg); border-radius:var(--radius-lg); border:2px solid var(--color-primary);">
              <h5 style="color:var(--color-primary); margin:0 0 var(--spacing-lg) 0;">📊 Recommended Supervision Intensity</h5>
              <div style="display:flex; align-items:center; gap:var(--spacing-lg); margin-bottom:var(--spacing-md);">
                <div style="flex:1;">
                  <div style="font-weight:600; font-size:0.875rem; color:var(--color-text-muted); margin-bottom:0.25rem;">Current Rating:</div>
                  <div style="font-size:1.5rem; font-weight:700; color:#ef4444;">HIGH</div>
                </div>
                <div style="flex:1;">
                  <div style="font-weight:600; font-size:0.875rem; color:var(--color-text-muted); margin-bottom:0.25rem;">Recommended Frequency:</div>
                  <div style="font-size:1.25rem; font-weight:700; color:var(--color-primary);">Quarterly</div>
                </div>
              </div>
              <div class="muted" style="font-size:0.8125rem; font-style:italic;">Based on risk profile, compliance history, and open issues</div>
            </div>
          </div>
        </div>
      </div>

    </div>
    <!-- ========== END COMPANY DASHBOARD ========== -->

    <!-- footer: single copy for all tabs (keeps visual style and appears on every view) -->
   </div> <!-- end regulator-admin-view -->

    <!-- Regulator - User View (hidden by default) -->
    <div id="regulator-user-view" style="display:none;">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title" style="color:var(--color-primary);">Regulator - User Workspace</h3>
          <div class="muted">Manage your assigned inspections</div>
        </div>

        <!-- Regulator User Navigation Tabs -->
        <div class="tabs">
          <div class="tab active" data-user-target="assigned">Assigned Inspections</div>
          <div class="tab" data-user-target="ongoing">View Ongoing</div>
          <div class="tab" data-user-target="completed">View Completed</div>
          <div class="tab" data-user-target="config">Configure</div>
        </div>

        <!-- TAB 1: ASSIGNED INSPECTIONS -->
        <div id="user-assigned" class="user-content-panel" style="display:block; margin-top:var(--spacing-xl);">
          <div class="page-header">
            <h2>Assigned Inspections</h2>
            <div class="muted">Inspections assigned to you - click Open to start working</div>
          </div>

          <!-- Current Inspection Summary (shown after selecting) -->
          <div id="user-current-inspection-summary" class="card" style="display:none; background:var(--color-primary-bg); padding:var(--spacing-lg); margin-top:var(--spacing-xl); border:2px solid var(--color-primary);">
            <h4 style="margin:0 0 var(--spacing-md) 0; color:var(--color-primary);">Current Inspection</h4>
            <div class="row" style="gap:var(--spacing-xl);">
              <div><strong>Inspection ID:</strong> <span id="user-current-insp-id">-</span></div>
              <div><strong>Entity:</strong> <span id="user-current-insp-entity">-</span></div>
              <div><strong>Status:</strong> <span id="user-current-insp-status">-</span></div>
              <div><strong>Due Date:</strong> <span id="user-current-insp-due">-</span></div>
            </div>
            <div style="margin-top:var(--spacing-md);">
              <button id="user-btn-open-workflow" type="button" class="btn">Open Workflow (Steps 2-7)</button>
              <button id="user-btn-clear-selection" type="button" class="btn secondary" style="margin-left:var(--spacing-md);">Back to List</button>
            </div>
          </div>

          <!-- Assigned Inspections Table -->
          <div style="overflow-x:auto; margin-top:var(--spacing-xl);">
            <table>
              <thead>
                <tr>
                  <th>Inspection ID</th>
                  <th>Entity Name</th>
                  <th>Inspection Type</th>
                  <th>Assigned Date</th>
                  <th>Due Date</th>
                  <th>Status</th>
                  <th style="text-align:center;">Action</th>
                </tr>
              </thead>
              <tbody id="user-assigned-table">
                <tr data-insp-id="INSP-2025-001" data-entity="ABC Insurance Company Ltd." data-type="Routine" data-assigned="2025-11-01" data-due="2025-11-30" data-status="In Progress">
                  <td><strong>INSP-2025-001</strong></td>
                  <td>ABC Insurance Company Ltd.</td>
                  <td>Routine</td>
                  <td>2025-11-01</td>
                  <td>2025-11-30</td>
                  <td><span class="chip warn">In Progress</span></td>
                  <td style="text-align:center;"><button class="btn small user-btn-open">Open</button></td>
                </tr>
                <tr data-insp-id="INSP-2025-002" data-entity="XYZ General Insurance" data-type="Thematic" data-assigned="2025-10-15" data-due="2025-12-15" data-status="Not Started">
                  <td><strong>INSP-2025-002</strong></td>
                  <td>XYZ General Insurance</td>
                  <td>Thematic</td>
                  <td>2025-10-15</td>
                  <td>2025-12-15</td>
                  <td><span class="chip info">Not Started</span></td>
                  <td style="text-align:center;"><button class="btn small user-btn-open">Open</button></td>
                </tr>
                <tr data-insp-id="INSP-2025-003" data-entity="PQR Life Insurance Ltd." data-type="Trigger-based" data-assigned="2025-11-10" data-due="2025-12-20" data-status="In Progress">
                  <td><strong>INSP-2025-003</strong></td>
                  <td>PQR Life Insurance Ltd.</td>
                  <td>Trigger-based</td>
                  <td>2025-11-10</td>
                  <td>2025-12-20</td>
                  <td><span class="chip warn">In Progress</span></td>
                  <td style="text-align:center;"><button class="btn small user-btn-open">Open</button></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- TAB 2: VIEW ONGOING -->
        <div id="user-ongoing" class="user-content-panel" style="display:none; margin-top:var(--spacing-xl);">
          <div class="page-header">
            <h2>Ongoing Inspections</h2>
            <div class="muted">Inspections currently in progress</div>
          </div>

          <div style="overflow-x:auto; margin-top:var(--spacing-xl);">
            <table>
              <thead>
                <tr>
                  <th>Inspection ID</th>
                  <th>Entity Name</th>
                  <th>Inspection Type</th>
                  <th>Assigned Date</th>
                  <th>Due Date</th>
                  <th>Status</th>
                  <th style="text-align:center;">Action</th>
                </tr>
              </thead>
              <tbody id="user-ongoing-table">
                <tr data-insp-id="INSP-2025-001" data-entity="ABC Insurance Company Ltd." data-type="Routine" data-assigned="2025-11-01" data-due="2025-11-30" data-status="In Progress">
                  <td><strong>INSP-2025-001</strong></td>
                  <td>ABC Insurance Company Ltd.</td>
                  <td>Routine</td>
                  <td>2025-11-01</td>
                  <td>2025-11-30</td>
                  <td><span class="chip warn">In Progress</span></td>
                  <td style="text-align:center;"><button class="btn small user-btn-open">Open</button></td>
                </tr>
                <tr data-insp-id="INSP-2025-003" data-entity="PQR Life Insurance Ltd." data-type="Trigger-based" data-assigned="2025-11-10" data-due="2025-12-20" data-status="In Progress">
                  <td><strong>INSP-2025-003</strong></td>
                  <td>PQR Life Insurance Ltd.</td>
                  <td>Trigger-based</td>
                  <td>2025-11-10</td>
                  <td>2025-12-20</td>
                  <td><span class="chip warn">In Progress</span></td>
                  <td style="text-align:center;"><button class="btn small user-btn-open">Open</button></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- TAB 3: VIEW COMPLETED -->
        <div id="user-completed" class="user-content-panel" style="display:none; margin-top:var(--spacing-xl);">
          <div class="page-header">
            <h2>Completed Inspections</h2>
            <div class="muted">Inspections you have completed</div>
          </div>

          <div style="overflow-x:auto; margin-top:var(--spacing-xl);">
            <table>
              <thead>
                <tr>
                  <th>Inspection ID</th>
                  <th>Entity Name</th>
                  <th>Inspection Type</th>
                  <th>Assigned Date</th>
                  <th>Completion Date</th>
                  <th>Status</th>
                  <th style="text-align:center;">Action</th>
                </tr>
              </thead>
              <tbody id="user-completed-table">
                <tr data-insp-id="INSP-2024-045" data-entity="DEF Reinsurance Corp." data-type="Routine" data-assigned="2025-09-20" data-due="2025-11-20" data-status="Completed">
                  <td><strong>INSP-2024-045</strong></td>
                  <td>DEF Reinsurance Corp.</td>
                  <td>Routine</td>
                  <td>2025-09-20</td>
                  <td>2025-11-20</td>
                  <td><span class="chip ok">Completed</span></td>
                  <td style="text-align:center;"><button class="btn small user-btn-open">Open</button></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- TAB 4: CONFIGURE -->
        <div id="user-config" class="user-content-panel" style="display:none; margin-top:var(--spacing-xl);">
          <div class="page-header">
            <h2>User Configuration</h2>
            <div class="muted">Customize your workspace preferences</div>
          </div>

          <div class="card" style="margin-top:var(--spacing-xl); padding:var(--spacing-xl);">
            <h4 style="margin:0 0 var(--spacing-lg) 0; color:var(--color-primary);">Workspace Preferences</h4>
            
            <div style="margin-bottom:var(--spacing-lg);">
              <label style="display:block; font-weight:600; margin-bottom:var(--spacing-xs);">Default Landing Tab</label>
              <select style="width:100%; max-width:400px; padding:0.625rem 0.75rem; border-radius:var(--radius-md); border:1.5px solid var(--color-border);">
                <option>Assigned Inspections</option>
                <option>View Ongoing</option>
                <option>View Completed</option>
              </select>
            </div>

            <div style="margin-bottom:var(--spacing-lg);">
              <label style="display:block; font-weight:600; margin-bottom:var(--spacing-xs);">Default Sorting</label>
              <select style="width:100%; max-width:400px; padding:0.625rem 0.75rem; border-radius:var(--radius-md); border:1.5px solid var(--color-border);">
                <option>By Due Date (Ascending)</option>
                <option>By Due Date (Descending)</option>
                <option>By Status</option>
                <option>By Entity Name</option>
              </select>
            </div>

            <div style="margin-bottom:var(--spacing-lg);">
              <label style="display:block; font-weight:600; margin-bottom:var(--spacing-xs);">Items Per Page</label>
              <select style="width:100%; max-width:400px; padding:0.625rem 0.75rem; border-radius:var(--radius-md); border:1.5px solid var(--color-border);">
                <option>10</option>
                <option>25</option>
                <option selected>50</option>
                <option>100</option>
              </select>
            </div>

            <div style="margin-top:var(--spacing-xl);">
              <button type="button" class="btn">Save Preferences</button>
              <button type="button" class="btn secondary" style="margin-left:var(--spacing-md);">Reset to Defaults</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Regulator User - Workflow Area (Steps 2-7 only) -->
      <div id="user-workflow" style="display:none; margin-top:var(--spacing-2xl);">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title" style="color:var(--color-primary);">Inspection Workflow</h3>
            <div class="muted">Working on: <span id="user-workflow-insp-id">-</span></div>
          </div>

          <!-- Step indicators (2-7 only for user) -->
          <div class="steps" id="user-steps" style="margin-top:var(--spacing-xl);">
            <div class="step" data-step="2">2. Data Fetch (Status)</div>
            <div class="step" data-step="3">3. Data Validation</div>
            <div class="step" data-step="4">4. Regulatory Check</div>
            <div class="step" data-step="5">5. Analytics & Risk-Based Sampling</div>
            <div class="step" data-step="6">6. Onsite Inspection Support</div>
            <div class="step" data-step="7">7. Observations & Report</div>
          </div>

          <div id="user-workflow-content" style="margin-top:var(--spacing-xl);">
            <!-- Steps 2-7 content will be dynamically shown here (reuse admin step content) -->
            <div class="muted" style="text-align:center; padding:var(--spacing-2xl);">Select a step from above to view workflow details</div>
          </div>

          <div style="margin-top:var(--spacing-xl);">
            <button id="user-btn-back-to-list" type="button" class="btn secondary">← Back to Inspections List</button>
          </div>
        </div>
      </div>
    </div> <!-- end regulator-user-view -->

    <!-- Insurer view (hidden by default) -->
    <div id="insurer-view" style="display:none;">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title" style="color:var(--color-primary);">Insurer Portal</h3>
          <div class="muted">Inspection Management Dashboard</div>
        </div>

        <!-- Insurer Navigation Tabs -->
        <div class="tabs">
          <div class="tab active" data-insurer-target="overview">Overview</div>
          <div class="tab" data-insurer-target="requirements">Requirements & Uploads</div>
          <div class="tab" data-insurer-target="observations">Responses to Observations</div>
          <div class="tab" data-insurer-target="reports">Reports</div>
          <div class="tab" data-insurer-target="history">History</div>
        </div>

        <!-- TAB 1: OVERVIEW -->
        <div id="insurer-overview" class="insurer-content-panel" style="display:block;">
          <div class="page-header">
            <h2>Current Inspection</h2>
            <div class="muted">Inspection details and status</div>
          </div>

          <!-- Inspection Details Card -->
          <div class="card" style="margin-top:var(--spacing-xl);">
            <h4 style="margin:0 0 var(--spacing-lg) 0; color:var(--color-primary);">Inspection Details</h4>
            <div class="row">
              <div class="col">
                <div style="margin-bottom:var(--spacing-md);"><strong>Inspection ID:</strong> INSP-2025-001</div>
                <div style="margin-bottom:var(--spacing-md);"><strong>Entity Name:</strong> ABC Insurance Company Ltd.</div>
              </div>
              <div class="col">
                <div style="margin-bottom:var(--spacing-md);"><strong>Status:</strong> <span class="chip warn">In Progress</span></div>
                <div style="margin-bottom:var(--spacing-md);"><strong>Next Deadline:</strong> 2025-11-30</div>
              </div>
            </div>
          </div>

          <!-- Summary Cards -->
          <div class="grid" style="margin-top:var(--spacing-xl);">
            <div class="card">
              <h4 style="margin:0 0 var(--spacing-sm) 0;">Pre-inspection Data</h4>
              <div class="big" style="color:var(--color-accent-success);">Complete</div>
              <div class="muted" style="margin-top:var(--spacing-xs);">All data submitted</div>
            </div>
            <div class="card">
              <h4 style="margin:0 0 var(--spacing-sm) 0;">Requirements Status</h4>
              <div class="big" style="color:var(--color-accent-warning);">3 Pending</div>
              <div class="muted" style="margin-top:var(--spacing-xs);">2 Submitted, 1 Overdue</div>
            </div>
            <div class="card">
              <h4 style="margin:0 0 var(--spacing-sm) 0;">Final Report</h4>
              <div class="big" style="color:var(--color-text-muted);">Not Available</div>
              <div class="muted" style="margin-top:var(--spacing-xs);">Inspection ongoing</div>
            </div>
          </div>

          <!-- Inspection Timeline -->
          <div class="card" style="margin-top:var(--spacing-xl);">
            <h4 style="margin:0 0 var(--spacing-lg) 0; color:var(--color-primary);">Inspection Timeline</h4>
            <div style="display:flex; flex-direction:column; gap:var(--spacing-md);">
              <div class="row" style="align-items:center; padding:var(--spacing-md); background:var(--color-accent-success-bg); border-radius:var(--radius-md);">
                <span class="chip ok" style="margin-right:var(--spacing-md);">✓</span>
                <div style="flex:1;">
                  <strong>Pre-inspection Data Submission</strong>
                  <div class="muted">Completed on 2025-10-15</div>
                </div>
              </div>
              <div class="row" style="align-items:center; padding:var(--spacing-md); background:var(--color-accent-warning-bg); border-radius:var(--radius-md);">
                <span class="chip warn" style="margin-right:var(--spacing-md);">⟳</span>
                <div style="flex:1;">
                  <strong>Onsite Inspection</strong>
                  <div class="muted">In Progress - Started 2025-11-05</div>
                </div>
              </div>
              <div class="row" style="align-items:center; padding:var(--spacing-md); background:var(--color-bg); border-radius:var(--radius-md);">
                <span class="chip info" style="margin-right:var(--spacing-md);">◯</span>
                <div style="flex:1;">
                  <strong>Final Report</strong>
                  <div class="muted">Pending</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- TAB 2: REQUIREMENTS & UPLOADS -->
        <div id="insurer-requirements" class="insurer-content-panel" style="display:none;">
          <div class="page-header">
            <h2>Requirements & Uploads</h2>
            <div class="muted">Manage pre-inspection and during-inspection requirements</div>
          </div>

          <!-- Pre-inspection Requirements -->
          <div class="card" style="margin-top:var(--spacing-xl);">
            <h4 style="margin:0 0 var(--spacing-lg) 0; color:var(--color-primary);">A. Pre-inspection Requirements</h4>
            <table>
              <thead>
                <tr>
                  <th>Requirement ID</th>
                  <th>Description</th>
                  <th>Deadline</th>
                  <th>Status</th>
                  <th>Download Format</th>
                  <th>Upload Response</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>REQ-PRE-001</td>
                  <td>Financial Statements (Last 3 years)</td>
                  <td>2025-10-10</td>
                  <td><span class="chip ok">Submitted</span></td>
                  <td><button class="btn small link" type="button">Download Template</button></td>
                  <td><button class="btn small" type="button" onclick="document.getElementById('upload-pre-001').click()">Upload</button><input type="file" id="upload-pre-001" style="display:none;"></td>
                </tr>
                <tr>
                  <td>REQ-PRE-002</td>
                  <td>Claims Data (DSF Format)</td>
                  <td>2025-10-10</td>
                  <td><span class="chip ok">Submitted</span></td>
                  <td><button class="btn small link" type="button">Download Template</button></td>
                  <td><button class="btn small" type="button" onclick="document.getElementById('upload-pre-002').click()">Upload</button><input type="file" id="upload-pre-002" style="display:none;"></td>
                </tr>
                <tr>
                  <td>REQ-PRE-003</td>
                  <td>Grievance Register</td>
                  <td>2025-10-10</td>
                  <td><span class="chip ok">Submitted</span></td>
                  <td><button class="btn small link" type="button">Download Template</button></td>
                  <td><button class="btn small" type="button" onclick="document.getElementById('upload-pre-003').click()">Upload</button><input type="file" id="upload-pre-003" style="display:none;"></td>
                </tr>
              </tbody>
            </table>

            <!-- Upload Section -->
            <div style="margin-top:var(--spacing-xl); padding:var(--spacing-lg); background:var(--color-bg); border-radius:var(--radius-md);">
              <h5 style="margin:0 0 var(--spacing-md) 0;">Upload New Document</h5>
              <div class="row">
                <div class="col">
                  <label>Select Requirement</label>
                  <select id="pre-req-select" style="width:100%;">
                    <option>REQ-PRE-001</option>
                    <option>REQ-PRE-002</option>
                    <option>REQ-PRE-003</option>
                  </select>
                </div>
                <div class="col">
                  <label>File</label>
                  <input type="file" id="pre-file-upload" style="width:100%;">
                </div>
              </div>
              <div style="margin-top:var(--spacing-md);">
                <label>Comment (Optional)</label>
                <textarea id="pre-comment" placeholder="Add any relevant comments..." style="width:100%; height:80px;"></textarea>
              </div>
              <div style="margin-top:var(--spacing-md);">
                <button type="button" class="btn">Submit Document</button>
                <span class="muted" style="margin-left:var(--spacing-md);">Last upload: 2025-10-09 14:32</span>
              </div>
            </div>
          </div>

          <!-- Requirements During Inspection -->
          <div class="card" style="margin-top:var(--spacing-xl);">
            <h4 style="margin:0 0 var(--spacing-lg) 0; color:var(--color-primary);">B. Requirements During Inspection</h4>
            <table>
              <thead>
                <tr>
                  <th>Requirement ID</th>
                  <th>Description</th>
                  <th>Raised On</th>
                  <th>Deadline</th>
                  <th>Status</th>
                  <th>Response Upload</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>REQ-DUR-001</td>
                  <td>Additional Claims Details for Policy IDs 1001-1050</td>
                  <td>2025-11-08</td>
                  <td>2025-11-18</td>
                  <td><span class="chip warn">Pending</span></td>
                  <td><button class="btn small" type="button" onclick="document.getElementById('upload-dur-001').click()">Upload</button><input type="file" id="upload-dur-001" style="display:none;"></td>
                </tr>
                <tr>
                  <td>REQ-DUR-002</td>
                  <td>Underwriting Guidelines Documentation</td>
                  <td>2025-11-10</td>
                  <td>2025-11-20</td>
                  <td><span class="chip warn">Pending</span></td>
                  <td><button class="btn small" type="button" onclick="document.getElementById('upload-dur-002').click()">Upload</button><input type="file" id="upload-dur-002" style="display:none;"></td>
                </tr>
                <tr>
                  <td>REQ-DUR-003</td>
                  <td>Agent Commission Structure Details</td>
                  <td>2025-11-06</td>
                  <td>2025-11-15</td>
                  <td><span class="chip miss">Overdue</span></td>
                  <td><button class="btn small" type="button" onclick="document.getElementById('upload-dur-003').click()">Upload</button><input type="file" id="upload-dur-003" style="display:none;"></td>
                </tr>
              </tbody>
            </table>

            <!-- Upload History -->
            <div style="margin-top:var(--spacing-xl);">
              <h5 style="margin:0 0 var(--spacing-md) 0;">Upload History</h5>
              <ul style="list-style:none; padding:0;">
                <li style="padding:var(--spacing-sm); border-bottom:1px solid var(--color-border);">
                  <strong>REQ-DUR-001</strong> - claims_additional_data.xlsx
                  <span class="muted" style="margin-left:var(--spacing-md);">Uploaded: 2025-11-12 10:45</span>
                  <span class="chip ok" style="margin-left:var(--spacing-sm);">Accepted</span>
                </li>
                <li style="padding:var(--spacing-sm); border-bottom:1px solid var(--color-border);">
                  <strong>REQ-DUR-002</strong> - underwriting_guidelines_v2.pdf
                  <span class="muted" style="margin-left:var(--spacing-md);">Uploaded: 2025-11-13 15:20</span>
                  <span class="chip warn" style="margin-left:var(--spacing-sm);">Under Review</span>
                </li>
              </ul>
            </div>
          </div>
        </div>

        <!-- TAB 3: REPORTS -->
        <div id="insurer-reports" class="insurer-content-panel" style="display:none;">
          <div class="page-header">
            <h2>Reports</h2>
            <div class="muted">Download inspection reports and documents</div>
          </div>

          <div class="row" style="margin-top:var(--spacing-xl);">
            <div class="col">
              <!-- Pending Requirements -->
              <div class="card">
                <h4 style="margin:0 0 var(--spacing-md) 0; color:var(--color-primary);">Pending Requirements List</h4>
                <div class="muted">Summary of outstanding requirements</div>
                <div style="margin-top:var(--spacing-lg);">
                  <button type="button" class="btn">Download Pending List</button>
                  <div class="muted" style="margin-top:var(--spacing-sm);">Last updated: 2025-11-15</div>
                </div>
              </div>
            </div>

            <div class="col">
              <!-- Final Report -->
              <div class="card">
                <h4 style="margin:0 0 var(--spacing-md) 0; color:var(--color-primary);">Final Inspection Report</h4>
                <div class="muted">Complete inspection report with findings</div>
                <div style="margin-top:var(--spacing-lg);">
                  <button type="button" class="btn" disabled>Download Final Report</button>
                  <div class="muted" style="margin-top:var(--spacing-sm);">Not yet available</div>
                </div>
              </div>

              <!-- Annexures -->
              <div class="card" style="margin-top:var(--spacing-xl);">
                <h4 style="margin:0 0 var(--spacing-md) 0; color:var(--color-primary);">Report Annexures</h4>
                <div class="muted">Supporting documents and annexures</div>
                <div style="margin-top:var(--spacing-lg);">
                  <button type="button" class="btn" disabled>Download Annexures</button>
                  <div class="muted" style="margin-top:var(--spacing-sm);">Available after final report</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Downloaded Reports History -->
          <div class="card" style="margin-top:var(--spacing-xl);">
            <h4 style="margin:0 0 var(--spacing-lg) 0; color:var(--color-primary);">Download History</h4>
            <table>
              <thead>
                <tr>
                  <th>Document</th>
                  <th>Downloaded On</th>
                  <th>Downloaded By</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Pending Requirements List</td>
                  <td>2025-11-15 09:30</td>
                  <td>admin@abcinsurance.com</td>
                  <td><button class="btn small link" type="button">Download Again</button></td>
                </tr>
                <tr>
                  <td>Pre-inspection Data Template</td>
                  <td>2025-10-01 14:15</td>
                  <td>data@abcinsurance.com</td>
                  <td><button class="btn small link" type="button">Download Again</button></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- TAB 4: RESPONSES TO OBSERVATIONS -->
        <div id="insurer-observations" class="insurer-content-panel" style="display:none;">
          <div class="page-header">
            <h2>Responses to Observations</h2>
            <div class="muted">Respond to inspection observations and findings</div>
          </div>

          <div class="card" style="margin-top:var(--spacing-xl);">
            <table>
              <thead>
                <tr>
                  <th>Observation ID</th>
                  <th>Title</th>
                  <th>Severity</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>OBS-001</td>
                  <td>Delayed Claims Settlement beyond SLA</td>
                  <td><span class="chip miss">High</span></td>
                  <td><span class="chip warn">Response Required</span></td>
                  <td><button class="btn small" type="button" onclick="openObservationResponse('OBS-001')">Respond</button></td>
                </tr>
                <tr>
                  <td>OBS-002</td>
                  <td>Incomplete Grievance Register Data</td>
                  <td><span class="chip warn">Medium</span></td>
                  <td><span class="chip warn">Response Required</span></td>
                  <td><button class="btn small" type="button" onclick="openObservationResponse('OBS-002')">Respond</button></td>
                </tr>
                <tr>
                  <td>OBS-003</td>
                  <td>Commission Payment Variance</td>
                  <td><span class="chip info">Low</span></td>
                  <td><span class="chip ok">Response Submitted</span></td>
                  <td><button class="btn small link" type="button" onclick="viewObservationResponse('OBS-003')">View Response</button></td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Response Panel (Initially Hidden) -->
          <div id="observation-response-panel" class="card" style="display:none; margin-top:var(--spacing-xl); border:2px solid var(--color-primary);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:var(--spacing-lg);">
              <h4 style="margin:0; color:var(--color-primary);">Response to <span id="obs-response-id">OBS-001</span></h4>
              <button type="button" class="btn small secondary" onclick="closeObservationResponse()">Close</button>
            </div>
            
            <div style="margin-bottom:var(--spacing-lg);">
              <label>Response Details</label>
              <textarea id="obs-response-text" placeholder="Provide detailed response to the observation..." style="width:100%; height:150px; margin-top:var(--spacing-xs);"></textarea>
            </div>

            <div style="margin-bottom:var(--spacing-lg);">
              <label>Attach Supporting Documents</label>
              <input type="file" id="obs-response-file" multiple style="width:100%; margin-top:var(--spacing-xs);">
              <div class="muted" style="margin-top:var(--spacing-xs);">You can attach multiple files</div>
            </div>

            <div style="display:flex; gap:var(--spacing-md);">
              <button type="button" class="btn" onclick="submitObservationResponse()">Submit Response</button>
              <button type="button" class="btn secondary" onclick="saveObservationDraft()">Save as Draft</button>
            </div>
          </div>
        </div>

        <!-- TAB 5: HISTORY -->
        <div id="insurer-history" class="insurer-content-panel" style="display:none;">
          <div class="page-header">
            <h2>Activity History</h2>
            <div class="muted">Complete log of all uploads, downloads, and actions</div>
          </div>

          <div class="card" style="margin-top:var(--spacing-xl);">
            <h4 style="margin:0 0 var(--spacing-lg) 0; color:var(--color-primary);">All Activities</h4>
            <table>
              <thead>
                <tr>
                  <th>Timestamp</th>
                  <th>Activity Type</th>
                  <th>Description</th>
                  <th>Requirement/Document</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>2025-11-15 09:30</td>
                  <td><span class="chip info">Download</span></td>
                  <td>Downloaded Pending Requirements List</td>
                  <td>pending_requirements_2025-11-15.pdf</td>
                  <td><span class="chip ok">Success</span></td>
                </tr>
                <tr>
                  <td>2025-11-13 15:20</td>
                  <td><span class="chip warn">Upload</span></td>
                  <td>Uploaded Underwriting Guidelines</td>
                  <td>REQ-DUR-002</td>
                  <td><span class="chip warn">Under Review</span></td>
                </tr>
                <tr>
                  <td>2025-11-12 10:45</td>
                  <td><span class="chip warn">Upload</span></td>
                  <td>Uploaded Additional Claims Data</td>
                  <td>REQ-DUR-001</td>
                  <td><span class="chip ok">Accepted</span></td>
                </tr>
                <tr>
                  <td>2025-10-09 14:32</td>
                  <td><span class="chip warn">Upload</span></td>
                  <td>Submitted Grievance Register</td>
                  <td>REQ-PRE-003</td>
                  <td><span class="chip ok">Accepted</span></td>
                </tr>
                <tr>
                  <td>2025-10-09 14:20</td>
                  <td><span class="chip warn">Upload</span></td>
                  <td>Submitted Claims Data (DSF Format)</td>
                  <td>REQ-PRE-002</td>
                  <td><span class="chip ok">Accepted</span></td>
                </tr>
                <tr>
                  <td>2025-10-09 14:10</td>
                  <td><span class="chip warn">Upload</span></td>
                  <td>Submitted Financial Statements</td>
                  <td>REQ-PRE-001</td>
                  <td><span class="chip ok">Accepted</span></td>
                </tr>
                <tr>
                  <td>2025-10-01 14:15</td>
                  <td><span class="chip info">Download</span></td>
                  <td>Downloaded Pre-inspection Data Template</td>
                  <td>pre_inspection_template.xlsx</td>
                  <td><span class="chip ok">Success</span></td>
                </tr>
                <tr>
                  <td>2025-09-28 11:00</td>
                  <td><span class="chip">Action</span></td>
                  <td>Inspection Initiated</td>
                  <td>INSP-2025-001</td>
                  <td><span class="chip ok">Confirmed</span></td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Export Options -->
          <div style="margin-top:var(--spacing-xl); text-align:right;">
            <button type="button" class="btn secondary">Export History (CSV)</button>
            <button type="button" class="btn secondary" style="margin-left:var(--spacing-md);">Export History (PDF)</button>
          </div>
        </div>
      </div>
    </div> <!-- end insurer-view -->
  </main>
  
  <!-- ====================== CONFIGURATION DASHBOARD ====================== -->
  <section id="config-root" class="app-shell" style="display:none;">
  <div class="card" style="margin-bottom:var(--spacing-xl);">
    <h2 style="margin:0; color:var(--color-primary);">System Configuration Dashboard</h2>
    <div class="muted" style="margin-top:var(--spacing-sm);">Define rules, thresholds, weights, and templates that power Prototype</div>
  </div>
  <!-- Back to Dashboard button removed as requested -->

  <div class="tabs">
    <div class="tab active" data-target="data-validation">Data Validation Rules</div>
    <div class="tab" data-target="reg-rules">Regulatory Check</div>
    <div class="tab" data-target="analytics">Analytics</div>
    <div class="tab" data-target="insp-templates">Inspection Templates</div>
    <div class="tab" data-target="integrations">Integrations</div>
  </div>

  <section id="reg-rules" class="card">
    <h3 style="color:var(--color-primary); margin-bottom:var(--spacing-sm);">Regulatory Check</h3>
    <div class="muted" style="margin-bottom:var(--spacing-xl);">Configure regulatory checks that will be run after data validation is complete. These checks map regulatory clauses to automated tests.</div>
    
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:var(--spacing-lg);">
      <h4 style="margin:0; font-size:1rem;">Sample Regulatory Checks</h4>
      <button id="btnAddRegCheck" type="button" class="btn small">+ Add Regulatory Check</button>
    </div>
    
    <table style="width:100%; border-collapse:collapse;">
      <thead>
        <tr style="border-bottom:2px solid var(--color-border); text-align:left;">
          <th style="padding:var(--spacing-md); font-weight:600; color:var(--color-text-main);">Check Name</th>
          <th style="padding:var(--spacing-md); font-weight:600; color:var(--color-text-main);">Regulation / Clause Reference</th>
          <th style="padding:var(--spacing-md); font-weight:600; color:var(--color-text-main);">Check Logic</th>
          <th style="padding:var(--spacing-md); font-weight:600; color:var(--color-text-main);">Severity</th>
          <th style="padding:var(--spacing-md); font-weight:600; color:var(--color-text-main);">Status</th>
          <th style="padding:var(--spacing-md); font-weight:600; color:var(--color-text-main); text-align:right;">Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr style="border-bottom:1px solid var(--color-border);">
          <td style="padding:var(--spacing-md); font-weight:600;">Solvency Margin Check</td>
          <td style="padding:var(--spacing-md); color:var(--color-text-muted); font-size:0.875rem;">IRDAI (Assets, Liabilities & Solvency Margin) Regulations – Reg. 7</td>
          <td style="padding:var(--spacing-md); font-family:monospace; font-size:0.8125rem;">Solvency ratio ≥ 150%</td>
          <td style="padding:var(--spacing-md);"><span class="chip miss">High</span></td>
          <td style="padding:var(--spacing-md);"><span class="chip ok">Active</span></td>
          <td style="padding:var(--spacing-md); text-align:right;">
            <button type="button" class="btn small" style="padding:0.25rem 0.5rem; margin-right:0.25rem; background:transparent; color:var(--color-primary); box-shadow:none;" title="Edit">✏️</button>
            <button type="button" class="btn small" style="padding:0.25rem 0.5rem; background:transparent; color:var(--color-text-muted); box-shadow:none;" title="Disable">⏸️</button>
          </td>
        </tr>
        <tr style="border-bottom:1px solid var(--color-border);">
          <td style="padding:var(--spacing-md); font-weight:600;">Claims Turnaround Time</td>
          <td style="padding:var(--spacing-md); color:var(--color-text-muted); font-size:0.875rem;">Protection of Policyholders' Interests – Reg. 15</td>
          <td style="padding:var(--spacing-md); font-family:monospace; font-size:0.8125rem;">&gt; 95% claims settled within 30 days</td>
          <td style="padding:var(--spacing-md);"><span class="chip warn">Medium</span></td>
          <td style="padding:var(--spacing-md);"><span class="chip ok">Active</span></td>
          <td style="padding:var(--spacing-md); text-align:right;">
            <button type="button" class="btn small" style="padding:0.25rem 0.5rem; margin-right:0.25rem; background:transparent; color:var(--color-primary); box-shadow:none;" title="Edit">✏️</button>
            <button type="button" class="btn small" style="padding:0.25rem 0.5rem; background:transparent; color:var(--color-text-muted); box-shadow:none;" title="Disable">⏸️</button>
          </td>
        </tr>
        <tr style="border-bottom:1px solid var(--color-border);">
          <td style="padding:var(--spacing-md); font-weight:600;">Unclaimed Amount Ageing</td>
          <td style="padding:var(--spacing-md); color:var(--color-text-muted); font-size:0.875rem;">Circular on Unclaimed Amounts</td>
          <td style="padding:var(--spacing-md); font-family:monospace; font-size:0.8125rem;">All amounts &gt; 10 years flagged</td>
          <td style="padding:var(--spacing-md);"><span class="chip miss">High</span></td>
          <td style="padding:var(--spacing-md);"><span class="chip ok">Active</span></td>
          <td style="padding:var(--spacing-md); text-align:right;">
            <button type="button" class="btn small" style="padding:0.25rem 0.5rem; margin-right:0.25rem; background:transparent; color:var(--color-primary); box-shadow:none;" title="Edit">✏️</button>
            <button type="button" class="btn small" style="padding:0.25rem 0.5rem; background:transparent; color:var(--color-text-muted); box-shadow:none;" title="Disable">⏸️</button>
          </td>
        </tr>
      </tbody>
    </table>
  </section>

  <section id="analytics" class="card" style="margin-top:var(--spacing-xl); display:none;">
    <h3 style="color:var(--color-primary); margin-bottom:var(--spacing-sm);">Analytics</h3>
    <div class="muted" style="margin-bottom:var(--spacing-lg);">Configure analytics thresholds and KPIs used for dashboards and early insights.</div>
    
    <!-- Analytics Sub-tabs -->
    <div class="nav-pills" style="margin-bottom:var(--spacing-xl);">
      <div class="nav-pill active analytics-subtab" data-subtarget="analytics-thresholds">Thresholds</div>
      <div class="nav-pill analytics-subtab" data-subtarget="analytics-kpis">KPIs</div>
      <div class="nav-pill analytics-subtab" data-subtarget="analytics-alerts">Alerts</div>
    </div>
    
    <!-- Thresholds Subtab -->
    <div id="analytics-thresholds" class="analytics-subtab-content">
      <div class="muted" style="margin-bottom:var(--spacing-lg); font-size:0.875rem;">Set global thresholds used for dashboards and automated alerts.</div>
      
      <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(320px, 1fr)); gap:var(--spacing-lg); margin-bottom:var(--spacing-xl);">
        <!-- KPI Card 1 -->
        <div style="border:1px solid var(--color-border); border-radius:var(--radius-md); padding:var(--spacing-lg); background:white;">
          <h4 style="margin:0 0 var(--spacing-sm) 0; font-size:1rem; color:var(--color-primary);">Exception Rate Threshold</h4>
          <p class="muted" style="margin:0 0 var(--spacing-md) 0; font-size:0.875rem;">Maximum allowed data exception rate before flagging an inspection.</p>
          <div style="display:flex; align-items:center; gap:var(--spacing-sm);">
            <input type="number" value="5" style="flex:1; padding:0.5rem; border:1.5px solid var(--color-border); border-radius:var(--radius-sm);" />
            <span style="font-weight:600; color:var(--color-text-main);">%</span>
          </div>
        </div>
        
        <!-- KPI Card 2 -->
        <div style="border:1px solid var(--color-border); border-radius:var(--radius-md); padding:var(--spacing-lg); background:white;">
          <h4 style="margin:0 0 var(--spacing-sm) 0; font-size:1rem; color:var(--color-primary);">High Severity Rule Breach Count</h4>
          <p class="muted" style="margin:0 0 var(--spacing-md) 0; font-size:0.875rem;">Number of high severity rule breaches that trigger a red alert.</p>
          <div style="display:flex; align-items:center; gap:var(--spacing-sm);">
            <span style="font-weight:600; color:var(--color-text-main);">&gt;</span>
            <input type="number" value="10" style="flex:1; padding:0.5rem; border:1.5px solid var(--color-border); border-radius:var(--radius-sm);" />
          </div>
        </div>
        
        <!-- KPI Card 3 -->
        <div style="border:1px solid var(--color-border); border-radius:var(--radius-md); padding:var(--spacing-lg); background:white;">
          <h4 style="margin:0 0 var(--spacing-sm) 0; font-size:1rem; color:var(--color-primary);">Claim TAT Breach Threshold</h4>
          <p class="muted" style="margin:0 0 var(--spacing-md) 0; font-size:0.875rem;">Percentage of claims breaching TAT limit that triggers enhanced supervision.</p>
          <div style="display:flex; align-items:center; gap:var(--spacing-sm);">
            <span style="font-weight:600; color:var(--color-text-main);">&gt;</span>
            <input type="number" value="15" style="flex:1; padding:0.5rem; border:1.5px solid var(--color-border); border-radius:var(--radius-sm);" />
            <span style="font-weight:600; color:var(--color-text-main);">%</span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- KPIs Subtab -->
    <div id="analytics-kpis" class="analytics-subtab-content" style="display:none;">
      <table style="width:100%; border-collapse:collapse;">
        <thead>
          <tr style="border-bottom:2px solid var(--color-border); text-align:left;">
            <th style="padding:var(--spacing-md); font-weight:600; color:var(--color-text-main);">KPI Name</th>
            <th style="padding:var(--spacing-md); font-weight:600; color:var(--color-text-main);">Description</th>
            <th style="padding:var(--spacing-md); font-weight:600; color:var(--color-text-main); width:120px;">Target Value</th>
            <th style="padding:var(--spacing-md); font-weight:600; color:var(--color-text-main); width:80px;">Unit</th>
          </tr>
        </thead>
        <tbody>
          <tr style="border-bottom:1px solid var(--color-border);">
            <td style="padding:var(--spacing-md); font-weight:600;">Data Exception Rate</td>
            <td style="padding:var(--spacing-md); color:var(--color-text-muted); font-size:0.875rem;">Exceptions as % of records processed</td>
            <td style="padding:var(--spacing-md);"><input type="number" value="5" style="width:100%; padding:0.375rem; border:1.5px solid var(--color-border); border-radius:var(--radius-sm);" /></td>
            <td style="padding:var(--spacing-md); text-align:center; font-weight:600;">%</td>
          </tr>
          <tr style="border-bottom:1px solid var(--color-border);">
            <td style="padding:var(--spacing-md); font-weight:600;">Claims Settled Within TAT</td>
            <td style="padding:var(--spacing-md); color:var(--color-text-muted); font-size:0.875rem;">% of claims settled within agreed TAT</td>
            <td style="padding:var(--spacing-md);"><input type="number" value="95" style="width:100%; padding:0.375rem; border:1.5px solid var(--color-border); border-radius:var(--radius-sm);" /></td>
            <td style="padding:var(--spacing-md); text-align:center; font-weight:600;">%</td>
          </tr>
          <tr style="border-bottom:1px solid var(--color-border);">
            <td style="padding:var(--spacing-md); font-weight:600;">High Severity Breaches Resolved</td>
            <td style="padding:var(--spacing-md); color:var(--color-text-muted); font-size:0.875rem;">% of high severity breaches resolved within 15 days</td>
            <td style="padding:var(--spacing-md);"><input type="number" value="90" style="width:100%; padding:0.375rem; border:1.5px solid var(--color-border); border-radius:var(--radius-sm);" /></td>
            <td style="padding:var(--spacing-md); text-align:center; font-weight:600;">%</td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <!-- Alerts Subtab -->
    <div id="analytics-alerts" class="analytics-subtab-content" style="display:none;">
      <div class="muted" style="margin-bottom:var(--spacing-lg); font-size:0.875rem;">Configure automatic alerts based on threshold breaches and system events.</div>
      
      <div style="background:white; border:1px solid var(--color-border); border-radius:var(--radius-md); padding:var(--spacing-lg); margin-bottom:var(--spacing-lg);">
        <div style="margin-bottom:var(--spacing-md);">
          <label style="display:flex; align-items:center; gap:var(--spacing-sm); cursor:pointer;">
            <input type="checkbox" checked />
            <span style="font-weight:600;">Email alert when Exception Rate > Threshold</span>
          </label>
        </div>
        <div style="margin-left:1.75rem;">
          <label style="display:block; margin-bottom:var(--spacing-sm); font-size:0.875rem;">Escalation Email List (comma-separated):</label>
          <input type="text" placeholder="admin@example.com, supervisor@example.com" style="width:100%; padding:0.5rem; border:1.5px solid var(--color-border); border-radius:var(--radius-sm);" />
        </div>
      </div>
      
      <div style="background:white; border:1px solid var(--color-border); border-radius:var(--radius-md); padding:var(--spacing-lg); margin-bottom:var(--spacing-lg);">
        <div style="margin-bottom:var(--spacing-md);">
          <label style="display:flex; align-items:center; gap:var(--spacing-sm); cursor:pointer;">
            <input type="checkbox" checked />
            <span style="font-weight:600;">Dashboard red flag when High Severity Breach Count > threshold</span>
          </label>
        </div>
        <div style="margin-left:1.75rem;">
          <label style="display:block; margin-bottom:var(--spacing-sm); font-size:0.875rem;">Minimum days before repeating same alert:</label>
          <input type="number" value="7" style="width:200px; padding:0.5rem; border:1.5px solid var(--color-border); border-radius:var(--radius-sm);" />
        </div>
      </div>
    </div>
    
    <div style="text-align:right; margin-top:var(--spacing-xl);">
      <button type="button" class="btn" onclick="alert('Analytics configuration saved!');">Save Analytics Configuration</button>
    </div>
  </section>



  <section id="data-validation" class="card" style="margin-top:var(--spacing-xl); display:none;">
    <h3 style="color:var(--color-primary); margin-bottom:var(--spacing-sm);">Data Validation Rules</h3>
    <div class="muted" style="margin-bottom:var(--spacing-xl);">Create and maintain structural and business rule checks for incoming datasets.</div>
    
    <div style="background:var(--color-primary-bg); border-radius:var(--radius-md); padding:var(--spacing-lg); margin-bottom:var(--spacing-xl);">
      <h4 style="margin:0 0 var(--spacing-md) 0; font-size:0.9375rem;">Add New Rule</h4>
      <div class="row" style="gap:var(--spacing-md);">
        <div class="col"><input placeholder="Rule name (e.g., Policy ID rule)" style="width:100%;"></div>
        <div class="col"><input placeholder="Expression (e.g., NOT ISNULL(Policy_ID) AND LENGTH(Policy_ID) = 10)" style="width:100%;"></div>
        <div class="col" style="flex:0 0 140px;"><select style="width:100%;"><option>High</option><option>Medium</option><option>Low</option></select></div>
        <div class="col" style="flex:0 0 120px;"><button id="btnAddRule" class="btn" type="button" style="width:100%;">Add Rule</button></div>
      </div>
    </div>
    
    <div class="muted" style="margin-bottom:var(--spacing-md); font-size:0.875rem;">Below are sample system-level data validation rules. Use the form above to add more or edit existing ones.</div>
    
    <table style="width:100%; border-collapse:collapse;">
      <thead>
        <tr style="border-bottom:2px solid var(--color-border); text-align:left;">
          <th style="padding:var(--spacing-md); font-weight:600; color:var(--color-text-main);">Rule Name</th>
          <th style="padding:var(--spacing-md); font-weight:600; color:var(--color-text-main);">Expression</th>
          <th style="padding:var(--spacing-md); font-weight:600; color:var(--color-text-main);">Severity</th>
          <th style="padding:var(--spacing-md); font-weight:600; color:var(--color-text-main);">Applies To</th>
          <th style="padding:var(--spacing-md); font-weight:600; color:var(--color-text-main);">Status</th>
          <th style="padding:var(--spacing-md); font-weight:600; color:var(--color-text-main);">Last Updated</th>
          <th style="padding:var(--spacing-md); font-weight:600; color:var(--color-text-main); text-align:right;">Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr style="border-bottom:1px solid var(--color-border);">
          <td style="padding:var(--spacing-md); font-weight:600;">Policy ID Not Null</td>
          <td style="padding:var(--spacing-md); font-family:monospace; font-size:0.8125rem; color:var(--color-text-muted);">NOT ISNULL(Policy_ID)</td>
          <td style="padding:var(--spacing-md);"><span class="chip miss">High</span></td>
          <td style="padding:var(--spacing-md); color:var(--color-text-muted); font-size:0.875rem;">Policy Master</td>
          <td style="padding:var(--spacing-md);"><span class="chip ok">Active</span></td>
          <td style="padding:var(--spacing-md); color:var(--color-text-muted); font-size:0.875rem;">12-Nov-2025</td>
          <td style="padding:var(--spacing-md); text-align:right;">
            <button type="button" class="btn small" style="padding:0.25rem 0.5rem; margin-right:0.25rem; background:transparent; color:var(--color-primary); box-shadow:none;" title="Edit">✏️</button>
            <button type="button" class="btn small" style="padding:0.25rem 0.5rem; margin-right:0.25rem; background:transparent; color:var(--color-text-muted); box-shadow:none;" title="Disable">⏸️</button>
            <button type="button" class="btn small" style="padding:0.25rem 0.5rem; background:transparent; color:var(--color-accent-error); box-shadow:none;" title="Delete">🗑️</button>
          </td>
        </tr>
        <tr style="border-bottom:1px solid var(--color-border);">
          <td style="padding:var(--spacing-md); font-weight:600;">Premium > 0</td>
          <td style="padding:var(--spacing-md); font-family:monospace; font-size:0.8125rem; color:var(--color-text-muted);">Premium_Amount > 0</td>
          <td style="padding:var(--spacing-md);"><span class="chip miss">High</span></td>
          <td style="padding:var(--spacing-md); color:var(--color-text-muted); font-size:0.875rem;">Policy Master</td>
          <td style="padding:var(--spacing-md);"><span class="chip ok">Active</span></td>
          <td style="padding:var(--spacing-md); color:var(--color-text-muted); font-size:0.875rem;">12-Nov-2025</td>
          <td style="padding:var(--spacing-md); text-align:right;">
            <button type="button" class="btn small" style="padding:0.25rem 0.5rem; margin-right:0.25rem; background:transparent; color:var(--color-primary); box-shadow:none;" title="Edit">✏️</button>
            <button type="button" class="btn small" style="padding:0.25rem 0.5rem; margin-right:0.25rem; background:transparent; color:var(--color-text-muted); box-shadow:none;" title="Disable">⏸️</button>
            <button type="button" class="btn small" style="padding:0.25rem 0.5rem; background:transparent; color:var(--color-accent-error); box-shadow:none;" title="Delete">🗑️</button>
          </td>
        </tr>
        <tr style="border-bottom:1px solid var(--color-border);">
          <td style="padding:var(--spacing-md); font-weight:600;">Claim Date After Policy Start</td>
          <td style="padding:var(--spacing-md); font-family:monospace; font-size:0.8125rem; color:var(--color-text-muted);">Claim_Date >= Policy_Start_Date</td>
          <td style="padding:var(--spacing-md);"><span class="chip warn">Medium</span></td>
          <td style="padding:var(--spacing-md); color:var(--color-text-muted); font-size:0.875rem;">Claims</td>
          <td style="padding:var(--spacing-md);"><span class="chip ok">Active</span></td>
          <td style="padding:var(--spacing-md); color:var(--color-text-muted); font-size:0.875rem;">10-Nov-2025</td>
          <td style="padding:var(--spacing-md); text-align:right;">
            <button type="button" class="btn small" style="padding:0.25rem 0.5rem; margin-right:0.25rem; background:transparent; color:var(--color-primary); box-shadow:none;" title="Edit">✏️</button>
            <button type="button" class="btn small" style="padding:0.25rem 0.5rem; margin-right:0.25rem; background:transparent; color:var(--color-text-muted); box-shadow:none;" title="Disable">⏸️</button>
            <button type="button" class="btn small" style="padding:0.25rem 0.5rem; background:transparent; color:var(--color-accent-error); box-shadow:none;" title="Delete">🗑️</button>
          </td>
        </tr>
        <tr style="border-bottom:1px solid var(--color-border);">
          <td style="padding:var(--spacing-md); font-weight:600;">Valid Product Code</td>
          <td style="padding:var(--spacing-md); font-family:monospace; font-size:0.8125rem; color:var(--color-text-muted);">Product_Code IN ('MOTOR01','HEALTH02','LIFE03')</td>
          <td style="padding:var(--spacing-md);"><span class="chip warn">Medium</span></td>
          <td style="padding:var(--spacing-md); color:var(--color-text-muted); font-size:0.875rem;">Policy Master</td>
          <td style="padding:var(--spacing-md);"><span class="chip ok">Active</span></td>
          <td style="padding:var(--spacing-md); color:var(--color-text-muted); font-size:0.875rem;">08-Nov-2025</td>
          <td style="padding:var(--spacing-md); text-align:right;">
            <button type="button" class="btn small" style="padding:0.25rem 0.5rem; margin-right:0.25rem; background:transparent; color:var(--color-primary); box-shadow:none;" title="Edit">✏️</button>
            <button type="button" class="btn small" style="padding:0.25rem 0.5rem; margin-right:0.25rem; background:transparent; color:var(--color-text-muted); box-shadow:none;" title="Disable">⏸️</button>
            <button type="button" class="btn small" style="padding:0.25rem 0.5rem; background:transparent; color:var(--color-accent-error); box-shadow:none;" title="Delete">🗑️</button>
          </td>
        </tr>
        <tr style="border-bottom:1px solid var(--color-border);">
          <td style="padding:var(--spacing-md); font-weight:600;">Age at Entry ≤ 70</td>
          <td style="padding:var(--spacing-md); font-family:monospace; font-size:0.8125rem; color:var(--color-text-muted);">Age_At_Entry <= 70</td>
          <td style="padding:var(--spacing-md);"><span class="chip" style="background:var(--color-text-light); color:white;">Low</span></td>
          <td style="padding:var(--spacing-md); color:var(--color-text-muted); font-size:0.875rem;">Policy Master</td>
          <td style="padding:var(--spacing-md);"><span class="chip" style="background:var(--color-text-light); color:white;">Inactive</span></td>
          <td style="padding:var(--spacing-md); color:var(--color-text-muted); font-size:0.875rem;">05-Nov-2025</td>
          <td style="padding:var(--spacing-md); text-align:right;">
            <button type="button" class="btn small" style="padding:0.25rem 0.5rem; margin-right:0.25rem; background:transparent; color:var(--color-primary); box-shadow:none;" title="Edit">✏️</button>
            <button type="button" class="btn small" style="padding:0.25rem 0.5rem; margin-right:0.25rem; background:transparent; color:var(--color-accent-success); box-shadow:none;" title="Activate">▶️</button>
            <button type="button" class="btn small" style="padding:0.25rem 0.5rem; background:transparent; color:var(--color-accent-error); box-shadow:none;" title="Delete">🗑️</button>
          </td>
        </tr>
      </tbody>
    </table>
  </section>



  <section id="dash-kpis" class="card" style="margin-top:18px; display:none;">
    <h3>Dashboard & KPIs</h3>
    <div class="muted">Choose KPI cards and layouts for the supervisory dashboard.</div>
    <div class="row" style="margin-top:10px;">
      <label><input type="checkbox" checked> Active Inspections</label>
      <label><input type="checkbox" checked> Pending Fetches</label>
      <label><input type="checkbox" checked> High-risk Alerts</label>
    </div>
  </section>

  <section id="insp-templates" class="card" style="margin-top:var(--spacing-xl); display:none;">
    <h3 style="color:var(--color-primary); margin-bottom:var(--spacing-sm);">Inspection Templates</h3>
    <div class="muted" style="margin-bottom:var(--spacing-xl);">Maintain reusable templates for different types of inspections.</div>
    
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:var(--spacing-xl);">
      <!-- Left: Template List -->
      <div>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:var(--spacing-md);">
          <h4 style="margin:0; font-size:0.9375rem;">Template Library</h4>
          <button id="btnAddTemplate" type="button" class="btn small">+ Add New Template</button>
        </div>
        <table style="width:100%; border-collapse:collapse;">
          <thead>
            <tr style="border-bottom:2px solid var(--color-border); text-align:left;">
              <th style="padding:var(--spacing-md); font-weight:600; color:var(--color-text-main); font-size:0.875rem;">Template Name</th>
              <th style="padding:var(--spacing-md); font-weight:600; color:var(--color-text-main); font-size:0.875rem; width:100px;">Type</th>
              <th style="padding:var(--spacing-md); font-weight:600; color:var(--color-text-main); font-size:0.875rem; width:120px;">Last Updated</th>
            </tr>
          </thead>
          <tbody>
            <tr style="border-bottom:1px solid var(--color-border); cursor:pointer;" onclick="document.getElementById('template-detail-1').style.display='block'; document.getElementById('template-detail-2').style.display='none'; document.getElementById('template-detail-3').style.display='none';">
              <td style="padding:var(--spacing-md); font-weight:600; color:var(--color-primary);">Comprehensive Onsite Inspection</td>
              <td style="padding:var(--spacing-md); color:var(--color-text-muted); font-size:0.875rem;">Onsite</td>
              <td style="padding:var(--spacing-md); color:var(--color-text-muted); font-size:0.875rem;">10-Oct-2025</td>
            </tr>
            <tr style="border-bottom:1px solid var(--color-border); cursor:pointer;" onclick="document.getElementById('template-detail-1').style.display='none'; document.getElementById('template-detail-2').style.display='block'; document.getElementById('template-detail-3').style.display='none';">
              <td style="padding:var(--spacing-md); font-weight:600; color:var(--color-primary);">Thematic Review – Motor Claims</td>
              <td style="padding:var(--spacing-md); color:var(--color-text-muted); font-size:0.875rem;">Thematic</td>
              <td style="padding:var(--spacing-md); color:var(--color-text-muted); font-size:0.875rem;">05-Sep-2025</td>
            </tr>
            <tr style="border-bottom:1px solid var(--color-border); cursor:pointer;" onclick="document.getElementById('template-detail-1').style.display='none'; document.getElementById('template-detail-2').style.display='none'; document.getElementById('template-detail-3').style.display='block';">
              <td style="padding:var(--spacing-md); font-weight:600; color:var(--color-primary);">Remote Offsite Monitoring – Life</td>
              <td style="padding:var(--spacing-md); color:var(--color-text-muted); font-size:0.875rem;">Offsite</td>
              <td style="padding:var(--spacing-md); color:var(--color-text-muted); font-size:0.875rem;">21-Aug-2025</td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <!-- Right: Template Details -->
      <div>
        <h4 style="margin:0 0 var(--spacing-md) 0; font-size:0.9375rem;">Template Details</h4>
        
        <!-- Template 1 Details -->
        <div id="template-detail-1" style="border:1px solid var(--color-border); border-radius:var(--radius-md); padding:var(--spacing-lg); background:var(--color-primary-bg);">
          <h4 style="margin:0 0 var(--spacing-sm) 0; color:var(--color-primary);">Comprehensive Onsite Inspection</h4>
          <p class="muted" style="margin:0 0 var(--spacing-md) 0; font-size:0.875rem;"><strong>Applicable Entities:</strong> General Insurers</p>
          <p class="muted" style="margin:0 0 var(--spacing-md) 0; font-size:0.875rem;"><strong>Purpose:</strong> Full-scale onsite inspection covering all functional areas including governance, operations, compliance, and risk management.</p>
          
          <div style="margin-bottom:var(--spacing-md);">
            <strong style="font-size:0.875rem; color:var(--color-text-main);">Sections:</strong>
            <ul style="margin:var(--spacing-sm) 0; padding-left:1.25rem; font-size:0.875rem; color:var(--color-text-muted);">
              <li>1. Governance & Board Oversight</li>
              <li>2. Product & Pricing</li>
              <li>3. Claims Management</li>
              <li>4. Policyholder Servicing</li>
              <li>5. Risk Management & Reinsurance</li>
            </ul>
          </div>
          
          <button type="button" class="btn small" style="width:100%;">View / Edit Template</button>
        </div>
        
        <!-- Template 2 Details -->
        <div id="template-detail-2" style="display:none; border:1px solid var(--color-border); border-radius:var(--radius-md); padding:var(--spacing-lg); background:var(--color-primary-bg);">
          <h4 style="margin:0 0 var(--spacing-sm) 0; color:var(--color-primary);">Thematic Review – Motor Claims</h4>
          <p class="muted" style="margin:0 0 var(--spacing-md) 0; font-size:0.875rem;"><strong>Applicable Entities:</strong> General Insurers</p>
          <p class="muted" style="margin:0 0 var(--spacing-md) 0; font-size:0.875rem;"><strong>Purpose:</strong> Focused review of motor claims processing, settlement patterns, and TAT compliance.</p>
          
          <div style="margin-bottom:var(--spacing-md);">
            <strong style="font-size:0.875rem; color:var(--color-text-main);">Sections:</strong>
            <ul style="margin:var(--spacing-sm) 0; padding-left:1.25rem; font-size:0.875rem; color:var(--color-text-muted);">
              <li>1. Claims Registration Process</li>
              <li>2. Settlement Patterns & TAT</li>
              <li>3. Repudiation Analysis</li>
              <li>4. Customer Complaints</li>
            </ul>
          </div>
          
          <button type="button" class="btn small" style="width:100%;">View / Edit Template</button>
        </div>
        
        <!-- Template 3 Details -->
        <div id="template-detail-3" style="display:none; border:1px solid var(--color-border); border-radius:var(--radius-md); padding:var(--spacing-lg); background:var(--color-primary-bg);">
          <h4 style="margin:0 0 var(--spacing-sm) 0; color:var(--color-primary);">Remote Offsite Monitoring – Life</h4>
          <p class="muted" style="margin:0 0 var(--spacing-md) 0; font-size:0.875rem;"><strong>Applicable Entities:</strong> Life Insurers</p>
          <p class="muted" style="margin:0 0 var(--spacing-md) 0; font-size:0.875rem;"><strong>Purpose:</strong> Remote monitoring of key operational and financial metrics for life insurance entities.</p>
          
          <div style="margin-bottom:var(--spacing-md);">
            <strong style="font-size:0.875rem; color:var(--color-text-main);">Sections:</strong>
            <ul style="margin:var(--spacing-sm) 0; padding-left:1.25rem; font-size:0.875rem; color:var(--color-text-muted);">
              <li>1. Solvency & Financial Health</li>
              <li>2. Persistency Ratios</li>
              <li>3. Product Mix Analysis</li>
              <li>4. Grievance Trends</li>
              <li>5. Regulatory Compliance</li>
            </ul>
          </div>
          
          <button type="button" class="btn small" style="width:100%;">View / Edit Template</button>
        </div>
      </div>
    </div>
  </section>

  <section id="notifications" class="card" style="margin-top:18px; display:none;">
    <h3>Notifications</h3>
    <div class="muted">Define email/SMS alerts for events like data receipt, validation failures, and high-risk flags.</div>
    <div class="row" style="margin-top:10px;">
      <label><input type="checkbox" checked> Data receipt summary</label>
      <label><input type="checkbox" checked> Validation failure</label>
      <label><input type="checkbox"> High-risk alert</label>
    </div>
  </section>

  <section id="user-roles" class="card" style="margin-top:18px; display:none;">
    <h3>User Roles</h3>
    <div class="muted">Manage access roles (Inspector, Admin, Viewer) and permissions.</div>
    <table style="margin-top:8px;">
      <thead><tr><th>Role</th><th>Permissions</th><th>Action</th></tr></thead>
      <tbody>
        <tr><td>Inspector</td><td>Create, Validate, Onsite, Observations</td><td><button class="btn" type="button" style="background:#fff;color:#0f172a;">Edit</button></td></tr>
        <tr><td>Admin</td><td>All modules + Configuration</td><td><button class="btn" type="button" style="background:#fff;color:#0f172a;">Edit</button></td></tr>
      </tbody>
    </table>
  </section>

  <section id="integrations" class="card" style="margin-top:var(--spacing-xl); display:none;">
    <h3 style="color:var(--color-primary); margin-bottom:var(--spacing-sm);">Integrations</h3>
    <div class="muted" style="margin-bottom:var(--spacing-xl);">Configure integrations with external systems and data sources.</div>
    
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:var(--spacing-lg);">
      <h4 style="margin:0; font-size:1rem;">Connected Systems</h4>
      <button type="button" class="btn small">+ Add Integration</button>
    </div>
    
    <table style="width:100%; border-collapse:collapse;">
      <thead>
        <tr style="border-bottom:2px solid var(--color-border); text-align:left;">
          <th style="padding:var(--spacing-md); font-weight:600; color:var(--color-text-main);">Integration Name</th>
          <th style="padding:var(--spacing-md); font-weight:600; color:var(--color-text-main);">Type</th>
          <th style="padding:var(--spacing-md); font-weight:600; color:var(--color-text-main);">Status</th>
          <th style="padding:var(--spacing-md); font-weight:600; color:var(--color-text-main);">Last Sync</th>
          <th style="padding:var(--spacing-md); font-weight:600; color:var(--color-text-main); text-align:right;">Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr style="border-bottom:1px solid var(--color-border);">
          <td style="padding:var(--spacing-md); font-weight:600;">IIB System</td>
          <td style="padding:var(--spacing-md); color:var(--color-text-muted); font-size:0.875rem;">API</td>
          <td style="padding:var(--spacing-md);"><span class="chip ok">Connected</span></td>
          <td style="padding:var(--spacing-md); color:var(--color-text-muted); font-size:0.875rem;">Synced 10 mins ago</td>
          <td style="padding:var(--spacing-md); text-align:right;">
            <button type="button" class="btn small" style="padding:0.25rem 0.75rem; margin-right:0.25rem; background:transparent; color:var(--color-primary); box-shadow:none; border:1px solid var(--color-primary);">Configure</button>
            <button type="button" class="btn small" style="padding:0.25rem 0.5rem; background:transparent; color:var(--color-text-muted); box-shadow:none;" title="Disable">⏸️</button>
          </td>
        </tr>
        <tr style="border-bottom:1px solid var(--color-border);">
          <td style="padding:var(--spacing-md); font-weight:600;">Grievance Redressal Portal</td>
          <td style="padding:var(--spacing-md); color:var(--color-text-muted); font-size:0.875rem;">API</td>
          <td style="padding:var(--spacing-md);"><span class="chip ok">Connected</span></td>
          <td style="padding:var(--spacing-md); color:var(--color-text-muted); font-size:0.875rem;">Synced 1 hr ago</td>
          <td style="padding:var(--spacing-md); text-align:right;">
            <button type="button" class="btn small" style="padding:0.25rem 0.75rem; margin-right:0.25rem; background:transparent; color:var(--color-primary); box-shadow:none; border:1px solid var(--color-primary);">Configure</button>
            <button type="button" class="btn small" style="padding:0.25rem 0.5rem; background:transparent; color:var(--color-text-muted); box-shadow:none;" title="Disable">⏸️</button>
          </td>
        </tr>
        <tr style="border-bottom:1px solid var(--color-border);">
          <td style="padding:var(--spacing-md); font-weight:600;">External Data Source</td>
          <td style="padding:var(--spacing-md); color:var(--color-text-muted); font-size:0.875rem;">SFTP</td>
          <td style="padding:var(--spacing-md);"><span class="chip miss">Not Connected</span></td>
          <td style="padding:var(--spacing-md); color:var(--color-text-muted); font-size:0.875rem;">No recent sync</td>
          <td style="padding:var(--spacing-md); text-align:right;">
            <button type="button" class="btn small" style="padding:0.25rem 0.75rem; margin-right:0.25rem; background:transparent; color:var(--color-primary); box-shadow:none; border:1px solid var(--color-primary);">Configure</button>
            <button type="button" class="btn small" style="padding:0.25rem 0.5rem; background:transparent; color:var(--color-text-muted); box-shadow:none;" title="Disable">⏸️</button>
          </td>
        </tr>
      </tbody>
    </table>
  </section> <!-- end config-root -->
</section> <!-- end app-root -->

<!-- global footer (moved to page end so it does not sit between KPI cards and config) -->
<div class="footer">Prototype - Developed by InsurTech Team</div>

<!-- Dummy final-report modal -->
<div id="report-modal" class="modal" aria-hidden="true">
  <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="report-title">
    <header>
      <h3 id="report-title" style="margin:0;">Final Inspection Report</h3>
      <div><button class="close" id="report-close" aria-label="Close">✕</button></div>
    </header>
    <div class="content" id="report-content">
      <!-- dummy content -->
      <h4 style="margin-top:0;">Report preview (dummy)</h4>
      <p>This is a placeholder for the final inspection report. When integrated, the PDF or report viewer will render here.</p>
      <p><b>Report ID:</b> <span id="report-id">—</span></p>
      <hr/>
      <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Suspendisse potenti. Nulla facilisi. (Dummy preview)</p>
    </div>
    <div style="margin-top:12px; text-align:right;">
      <button id="report-download" class="btn">Download (dummy)</button>
      <button id="report-close-2" class="btn small" style="background:#0f172a; margin-left:8px;">Close</button>
    </div>
  </div>
</div>

<!-- Communication modal (for ongoing -> message insurer) -->
<div id="comm-modal" class="modal" aria-hidden="true" style="display:none;">
  <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="comm-title">
    <header>
      <h3 id="comm-title" style="margin:0;">Communication — <span id="comm-ins-id">—</span></h3>
      <div><button class="close" id="comm-close" aria-label="Close">✕</button></div>
    </header>
    <div class="content" id="comm-content" style="display:flex; flex-direction:column; gap:12px;">
      <div id="comm-thread" style="flex:1; overflow:auto; padding:8px; border:1px solid var(--color-border); border-radius:6px; background:white;">
        <div class="muted">Conversation will appear here (dummy).</div>
      </div>
      <div style="display:flex; gap:8px; align-items:center;">
        <input id="comm-input" placeholder="Type a message to insurer..." style="flex:1; padding:0.6rem; border-radius:6px; border:1.5px solid var(--color-border);">
        <button id="comm-send" class="btn">Send</button>
        <button id="comm-close-2" class="btn small" style="background:#0f172a; color:white;">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Add Rule Modal (Data Validation) -->
<div id="modalAddRule" class="modal" aria-hidden="true">
  <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="modal-add-rule-title" style="max-width:720px;">
    <header>
      <h3 id="modal-add-rule-title" style="margin:0;">Create Data Validation Rule</h3>
      <div><button class="close" onclick="closeModal('modalAddRule')" aria-label="Close">✕</button></div>
    </header>
    <div style="padding:var(--spacing-lg) 0;">
      <p class="muted" style="margin:0 0 var(--spacing-lg) 0;">Use this form to define a structural or business rule check for incoming datasets.</p>
      
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:var(--spacing-lg); margin-bottom:var(--spacing-lg);">
        <div>
          <label>Rule Name</label>
          <input id="rule-name" type="text" placeholder="e.g., Policy ID Not Null" style="width:100%;" />
        </div>
        <div>
          <label>Dataset / Applies To</label>
          <select id="rule-dataset" style="width:100%;">
            <option>Policy Master</option>
            <option>Claims</option>
            <option>Endorsements</option>
            <option>Grievances</option>
            <option>Finance</option>
          </select>
        </div>
      </div>
      
      <div style="margin-bottom:var(--spacing-lg);">
        <label>Severity</label>
        <select id="rule-severity" style="width:100%;">
          <option>High</option>
          <option>Medium</option>
          <option>Low</option>
        </select>
      </div>
      
      <div style="margin-bottom:var(--spacing-lg);">
        <label>Rule Description</label>
        <textarea id="rule-description" rows="3" placeholder="Brief description of what this rule validates..." style="width:100%; font-family:inherit; resize:vertical;"></textarea>
      </div>
      
      <div style="margin-bottom:var(--spacing-lg);">
        <label>Rule Expression</label>
        <input id="rule-expression" type="text" placeholder="e.g., NOT ISNULL(Policy_ID) AND LENGTH(Policy_ID) = 10" style="width:100%; font-family:monospace;" />
      </div>
      
      <div style="background:var(--color-primary-bg); padding:var(--spacing-md); border-radius:var(--radius-md); border-left:3px solid var(--color-primary);">
        <strong style="font-size:0.875rem; color:var(--color-primary);">Example</strong>
        <p class="muted" style="margin:var(--spacing-sm) 0 0 0; font-size:0.875rem;">Policy ID Not Null – Applies to Policy Master, Severity: High, Expression: NOT ISNULL(Policy_ID)</p>
      </div>
    </div>
    <div style="display:flex; gap:var(--spacing-md); justify-content:flex-end; padding-top:var(--spacing-lg); border-top:1px solid var(--color-border);">
      <button type="button" class="btn secondary" onclick="closeModal('modalAddRule')">Cancel</button>
      <button type="button" class="btn" onclick="saveRule()">Save Rule</button>
    </div>
  </div>
</div>

<!-- Add Regulatory Check Modal -->
<div id="modalAddRegCheck" class="modal" aria-hidden="true">
  <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="modal-add-reg-title" style="max-width:720px;">
    <header>
      <h3 id="modal-add-reg-title" style="margin:0;">Create Regulatory Check</h3>
      <div><button class="close" onclick="closeModal('modalAddRegCheck')" aria-label="Close">✕</button></div>
    </header>
    <div style="padding:var(--spacing-lg) 0;">
      <p class="muted" style="margin:0 0 var(--spacing-lg) 0;">Link a regulatory clause to an automated check that will be run after data validation.</p>
      
      <div style="margin-bottom:var(--spacing-lg);">
        <label>Regulation</label>
        <select id="reg-regulation" style="width:100%;">
          <option>IRDAI (Assets, Liabilities & Solvency Margin) Regulations</option>
          <option>Protection of Policyholders' Interests Regulations</option>
          <option>Circular on Unclaimed Amounts</option>
          <option>IRDAI (Registration of Indian Insurance Companies) Regulations</option>
          <option>IRDAI (Appointed Actuary) Regulations</option>
        </select>
      </div>
      
      <div style="display:grid; grid-template-columns:2fr 1fr; gap:var(--spacing-lg); margin-bottom:var(--spacing-lg);">
        <div>
          <label>Check Name</label>
          <input id="reg-check-name" type="text" placeholder="e.g., Solvency Margin Check" style="width:100%;" />
        </div>
        <div>
          <label>Clause / Reference</label>
          <input id="reg-clause" type="text" placeholder="e.g., Reg. 7" style="width:100%;" />
        </div>
      </div>
      
      <div style="margin-bottom:var(--spacing-lg);">
        <label>Check Logic</label>
        <textarea id="reg-logic" rows="3" placeholder="Describe the automated check logic..." style="width:100%; font-family:inherit; resize:vertical;"></textarea>
      </div>
      
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:var(--spacing-lg); margin-bottom:var(--spacing-lg);">
        <div>
          <label>Severity</label>
          <select id="reg-severity" style="width:100%;">
            <option>High</option>
            <option>Medium</option>
            <option>Low</option>
          </select>
        </div>
        <div>
          <label>Applies To</label>
          <select id="reg-applies-to" style="width:100%;">
            <option>All</option>
            <option>Life Insurers</option>
            <option>General Insurers</option>
            <option>Health Insurers</option>
          </select>
        </div>
      </div>
      
      <div style="background:var(--color-primary-bg); padding:var(--spacing-md); border-radius:var(--radius-md); border-left:3px solid var(--color-primary);">
        <strong style="font-size:0.875rem; color:var(--color-primary);">How this works</strong>
        <ul style="margin:var(--spacing-sm) 0 0 0; padding-left:1.25rem; font-size:0.875rem; color:var(--color-text-muted);">
          <li>Select a regulation and clause reference</li>
          <li>Define the name and logic for the automated check</li>
          <li>Map its severity and applicable entity type</li>
        </ul>
      </div>
    </div>
    <div style="display:flex; gap:var(--spacing-md); justify-content:flex-end; padding-top:var(--spacing-lg); border-top:1px solid var(--color-border);">
      <button type="button" class="btn secondary" onclick="closeModal('modalAddRegCheck')">Cancel</button>
      <button type="button" class="btn" onclick="saveRegCheck()">Save Check</button>
    </div>
  </div>
</div>

<!-- Add Template Modal -->
<div id="modalAddTemplate" class="modal" aria-hidden="true">
  <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="modal-add-template-title" style="max-width:800px;">
    <header>
      <h3 id="modal-add-template-title" style="margin:0;">Create Inspection Template</h3>
      <div><button class="close" onclick="closeModal('modalAddTemplate')" aria-label="Close">✕</button></div>
    </header>
    <div style="padding:var(--spacing-lg) 0; max-height:70vh; overflow-y:auto;">
      <p class="muted" style="margin:0 0 var(--spacing-xl) 0;">Define a reusable inspection template by selecting data categories and key fields.</p>
      
      <!-- Section 1: Basic Details -->
      <div style="background:white; border:1px solid var(--color-border); border-radius:var(--radius-md); padding:var(--spacing-lg); margin-bottom:var(--spacing-lg);">
        <h4 style="margin:0 0 var(--spacing-md) 0; color:var(--color-primary); font-size:1rem;">Section 1 – Basic Details</h4>
        
        <div style="margin-bottom:var(--spacing-lg);">
          <label>Template Name</label>
          <input id="template-name" type="text" placeholder="e.g., Comprehensive Onsite Inspection" style="width:100%;" />
        </div>
        
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:var(--spacing-lg);">
          <div>
            <label>Inspection Type</label>
            <select id="template-type" style="width:100%;">
              <option>Onsite</option>
              <option>Offsite</option>
              <option>Thematic</option>
            </select>
          </div>
          <div>
            <label>Applicable Entities</label>
            <select id="template-entities" style="width:100%;">
              <option>All</option>
              <option>Life Insurers</option>
              <option>General Insurers</option>
              <option>Health Insurers</option>
            </select>
          </div>
        </div>
      </div>
      
      <!-- Section 2: Data Category -->
      <div style="background:white; border:1px solid var(--color-border); border-radius:var(--radius-md); padding:var(--spacing-lg); margin-bottom:var(--spacing-lg);">
        <h4 style="margin:0 0 var(--spacing-md) 0; color:var(--color-primary); font-size:1rem;">Section 2 – Data Category</h4>
        
        <div style="margin-bottom:var(--spacing-md);">
          <label>Data Category</label>
          <select id="template-category" style="width:100%;" onchange="updateCategoryHelper()">
            <option value="">Select a category...</option>
            <option value="policy">Policy Data</option>
            <option value="claims">Claims Data</option>
            <option value="finance">Finance</option>
            <option value="reinsurance">Reinsurance</option>
            <option value="governance">Governance & Board</option>
            <option value="grievance">Grievance Data</option>
          </select>
        </div>
        
        <div id="category-helper" class="muted" style="font-size:0.875rem; padding:var(--spacing-sm); background:var(--color-bg); border-radius:var(--radius-sm); display:none;">
          <!-- Dynamic helper text -->
        </div>
      </div>
      
      <!-- Section 3: Data Fields -->
      <div style="background:white; border:1px solid var(--color-border); border-radius:var(--radius-md); padding:var(--spacing-lg); margin-bottom:var(--spacing-lg);">
        <h4 style="margin:0 0 var(--spacing-sm) 0; color:var(--color-primary); font-size:1rem;">Section 3 – Data Fields</h4>
        <p class="muted" style="margin:0 0 var(--spacing-md) 0; font-size:0.875rem;">These fields will be pre-loaded into the inspection data request and analytics views.</p>
        
        <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:var(--spacing-sm);">
          <label style="display:flex; align-items:center; gap:var(--spacing-sm); font-weight:400; cursor:pointer;">
            <input type="checkbox" value="policy_number" /> Policy Number
          </label>
          <label style="display:flex; align-items:center; gap:var(--spacing-sm); font-weight:400; cursor:pointer;">
            <input type="checkbox" value="policy_start_date" /> Policy Start Date
          </label>
          <label style="display:flex; align-items:center; gap:var(--spacing-sm); font-weight:400; cursor:pointer;">
            <input type="checkbox" value="policy_end_date" /> Policy End Date
          </label>
          <label style="display:flex; align-items:center; gap:var(--spacing-sm); font-weight:400; cursor:pointer;">
            <input type="checkbox" value="product_code" /> Product Code
          </label>
          <label style="display:flex; align-items:center; gap:var(--spacing-sm); font-weight:400; cursor:pointer;">
            <input type="checkbox" value="premium_amount" /> Premium Amount
          </label>
          <label style="display:flex; align-items:center; gap:var(--spacing-sm); font-weight:400; cursor:pointer;">
            <input type="checkbox" value="sum_insured" /> Sum Insured
          </label>
          <label style="display:flex; align-items:center; gap:var(--spacing-sm); font-weight:400; cursor:pointer;">
            <input type="checkbox" value="channel" /> Channel
          </label>
          <label style="display:flex; align-items:center; gap:var(--spacing-sm); font-weight:400; cursor:pointer;">
            <input type="checkbox" value="agent_code" /> Agent Code
          </label>
        </div>
      </div>
      
      <!-- Section 4: Options -->
      <div style="background:white; border:1px solid var(--color-border); border-radius:var(--radius-md); padding:var(--spacing-lg);">
        <h4 style="margin:0 0 var(--spacing-md) 0; color:var(--color-primary); font-size:1rem;">Section 4 – Options</h4>
        
        <div style="display:flex; flex-direction:column; gap:var(--spacing-sm);">
          <label style="display:flex; align-items:center; gap:var(--spacing-sm); font-weight:400; cursor:pointer;">
            <input type="checkbox" checked /> Include standard governance & compliance checks
          </label>
          <label style="display:flex; align-items:center; gap:var(--spacing-sm); font-weight:400; cursor:pointer;">
            <input type="checkbox" checked /> Include data quality summary section
          </label>
          <label style="display:flex; align-items:center; gap:var(--spacing-sm); font-weight:400; cursor:pointer;">
            <input type="checkbox" /> Enable custom question set when inspection is created
          </label>
        </div>
      </div>
    </div>
    <div style="display:flex; gap:var(--spacing-md); justify-content:flex-end; padding-top:var(--spacing-lg); border-top:1px solid var(--color-border);">
      <button type="button" class="btn secondary" onclick="closeModal('modalAddTemplate')">Cancel</button>
      <button type="button" class="btn" onclick="saveTemplate()">Create Template</button>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function(){
  // Simple helpers
  const $  = (sel, ctx=document) => ctx.querySelector(sel);
  const $$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));

  const login   = $('#login');
  const appRoot = $('#app-root');
  const config  = $('#config-root');

  // Login toggle
  $('#login-btn')?.addEventListener('click', ()=>{
    const email = $('#email')?.value.trim();
    const password = $('#password')?.value.trim();
    
    
    if(login) login.style.display = 'none';
    if(appRoot){ appRoot.style.display = ''; window.scrollTo({top:0, behavior:'smooth'}); }
    showOnly('home');
  });

  // Logout handler
  $('#logout-btn')?.addEventListener('click', ()=>{
    if(appRoot) appRoot.style.display = 'none';
    if(config) config.style.display = 'none';
    if(login) login.style.display = 'block';

    // Clear form fields
    const emailInput = $('#email');
    const passwordInput = $('#password');
    if(emailInput) emailInput.value = '';
    if(passwordInput) passwordInput.value = '';
    // Scroll to top and reload
    window.scrollTo({top:0, behavior:'smooth'});
    setTimeout(()=>{ location.reload(); }, 300);
  });

  // Template vs Manual toggle: show/hide sections
  (function(){
    const tplRadio   = document.getElementById('mode-template');
    const manualRadio= document.getElementById('mode-manual');
    const tplSection = document.getElementById('templateSection');
    const manualSection = document.getElementById('manualSection');

    function setModeTemplate(isTemplate){
      if(tplSection) tplSection.style.display = isTemplate ? '' : 'none';
      if(manualSection) manualSection.style.display = isTemplate ? 'none' : '';
    }

    // wire radios
    tplRadio?.addEventListener('change', ()=> setModeTemplate(true));
    manualRadio?.addEventListener('change', ()=> setModeTemplate(false));

    // initialize (default = template)
    setModeTemplate(true);
  })();

  // Show default list
  function showList(kind){
    const lists = $('#lists');
    const flow  = $('#flow');
    if(lists) lists.style.display = 'block';
    if(flow)  flow.style.display  = 'none';

    const SAMPLE = {
      ongoing: [
        {id:'INSP-1101', insurer:'ICICI Lombard', period:'2025-07-01 → 2025-09-30', status:'Data Fetch', owner:'A. Kumar'},
        {id:'INSP-1102', insurer:'SBI Life',       period:'2025-06-01 → 2025-06-30', status:'Validation', owner:'R. Singh'},
        {id:'INSP-1103', insurer:'LIC',            period:'2025-05-01 → 2025-05-31', status:'Regulatory', owner:'P. Rao'},
        {id:'INSP-1104', insurer:'HDFC Ergo',      period:'2025-04-01 → 2025-04-30', status:'Analytics', owner:'M. Iyer'},
        {id:'INSP-1105', insurer:'Bajaj Allianz',  period:'2025-03-01 → 2025-03-31', status:'Onsite', owner:'S. Iyer'},
        {id:'INSP-1106', insurer:'Tata AIG',       period:'2025-02-01 → 2025-02-28', status:'Observations', owner:'P. Rao'}
      ],
      completed: [
        {id:'INSP-0999', insurer:'HDFC Ergo', period:'2024-10-01 → 2024-12-31', status:'Closed', owner:'A. Kumar'},
        {id:'INSP-0992', insurer:'LIC',       period:'2024-07-01 → 2024-09-30', status:'Closed', owner:'M. Iyer'}
      ]
    };

    // update table header according to list kind
    const headEl = $('#lists thead');
    if(headEl){
      const headHtml = (kind === 'ongoing')
        ? `<tr><th>ID</th><th>Insurer</th><th>Period</th><th>Status</th><th>Owner</th><th>Communication</th><th>Modify</th></tr>`
        : `<tr><th>ID</th><th>Insurer</th><th>Period</th><th>Status</th><th>Owner</th><th>Final Report</th></tr>`;
      headEl.innerHTML = headHtml;
    }

    const rows = (SAMPLE[kind]||[]).map(r => {
      if(kind === 'completed'){
        const reportBtn = `<button class="btn small view-report" data-id="${r.id}" title="View final report">View</button>`;
        return `<tr data-inspection='${JSON.stringify(r).replace(/'/g, "&apos;")}' data-status="${r.status}">
                  <td>${r.id}</td>
                  <td><a href="#" class="insurer-link" data-insurer="${r.insurer}" style="color:var(--color-primary); font-weight:600; text-decoration:none;" title="View Company Dashboard">${r.insurer}</a></td>
                  <td>${r.period}</td>
                  <td><span class="${r.status==='Closed'?'chip ok':'chip info'}">${r.status.toUpperCase()}</span></td>
                  <td>${r.owner}</td>
                  <td style="width:140px; text-align:right;">${reportBtn}</td>
                </tr>`;
      } else {
        const commBtn = `<button class="btn small comm-btn" data-id="${r.id}" title="Message insurer">Message</button>`;
        const isClosed = r.status === 'Closed';
        const editBtn = isClosed 
          ? `<div class="edit-btn-wrapper" data-tooltip="Inspection closed – modification not allowed">
               <button class="btn small edit-btn" disabled>Edit</button>
             </div>`
          : `<button class="btn small edit-btn" data-id="${r.id}" title="Edit inspection">Edit</button>`;
        
        return `<tr data-inspection='${JSON.stringify(r).replace(/'/g, "&apos;")}' data-status="${r.status}">
                  <td>${r.id}</td>
                  <td><a href="#" class="insurer-link" data-insurer="${r.insurer}" style="color:var(--color-primary); font-weight:600; text-decoration:none;" title="View Company Dashboard">${r.insurer}</a></td>
                  <td>${r.period}</td>
                  <td><span class="${r.status==='Closed'?'chip ok':'chip info'}">${r.status.toUpperCase()}</span></td>
                  <td>${r.owner}</td>
                  <td style="width:140px; text-align:right;">${commBtn}</td>
                  <td style="width:140px; text-align:right;">${editBtn}</td>
                </tr>`;
      }
    }).join('');

    const body  = $('#list-body'); if(body) body.innerHTML = rows;
    const title = $('#list-title'); if(title) title.textContent = (kind==='ongoing')?'Ongoing Inspections':'Completed Inspections';
  }
  //showList('completed');  // don't show completed by default

  // Show/hide main sections (home, flow, lists, config)
  function showOnly(section){
    const lists = $('#lists');
    const flow  = $('#flow');
    const home = $('#home');
    const companyDashboard = $('#company-dashboard');
    const supToolbar = $('#supervision-toolbar');
    const homeBtn = $('#btn-home');
    
    // hide everything by default, then show the requested section
    if(lists) lists.style.display='none';
    if(flow)  flow.style.display='none';
    if(config) config.style.display='none';
    if(home) home.style.display='none';
    if(companyDashboard) companyDashboard.style.display='none';

    // Update Home button active state
    if(homeBtn) {
      if(section === 'home') {
        homeBtn.classList.add('active');
      } else {
        homeBtn.classList.remove('active');
      }
    }

    if(section === 'home'){ 
      if(home) home.style.display='block'; 
      if(supToolbar) supToolbar.style.display='none'; // Hide toolbar on home
    }
    if(section === 'flow'){ 
      if(flow) flow.style.display='block'; 
      if(supToolbar) supToolbar.style.display='flex'; // Show toolbar in inspection flow
    }
    if(section === 'ongoing'){ 
      if(lists) { lists.style.display='block'; showList('ongoing'); } 
      if(supToolbar) supToolbar.style.display='flex'; // Show toolbar
    }
    if(section === 'completed'){ 
      if(lists) { lists.style.display='block'; showList('completed'); } 
      if(supToolbar) supToolbar.style.display='flex'; // Show toolbar
    }
    if(section === 'config'){ 
      if(config){ config.style.display=''; config.scrollIntoView({behavior:'smooth', block:'start'}); } 
      if(supToolbar) supToolbar.style.display='flex'; // Show toolbar
    }
  }

  // Show Company Dashboard
  function showCompanyDashboard(insurerName){
    const lists = $('#lists');
    const flow = $('#flow');
    const home = $('#home');
    const companyDashboard = $('#company-dashboard');
    const supToolbar = $('#supervision-toolbar');
    const homeBtn = $('#btn-home');

    // Hide all main sections
    if(lists) lists.style.display='none';
    if(flow) flow.style.display='none';
    if(home) home.style.display='none';
    if(config) config.style.display='none';
    if(supToolbar) supToolbar.style.display='none';
    
    // Show company dashboard
    if(companyDashboard) {
      companyDashboard.style.display='block';
      // Update company name if provided
      if(insurerName) {
        const companyNameEl = $('#company-name');
        if(companyNameEl) companyNameEl.textContent = insurerName;
      }
    }

    // Update Home button active state
    if(homeBtn) homeBtn.classList.remove('active');

    // Scroll to top
    window.scrollTo({top:0, behavior:'smooth'});
  }
  window.showCompanyDashboard = showCompanyDashboard;

  // Go to a specific step section and show flow
  function gotoStep(n){
    console.log('gotoStep called with n=', n);
    // First ensure we're showing the flow view
    showOnly('flow');
    
    const flow  = $('#flow');
    if(flow) {
      flow.style.display = 'block';
      console.log('Flow display set to block');
    } else {
      console.error('Flow element not found!');
    }
    
    // toggle active chip + panels
    $$('.step').forEach(s => s.classList.toggle('active', s.dataset.step == String(n)));
    
    // Show/hide step content by directly setting display style
    for(let i=1;i<=7;i++){
      const stepDiv = $('#step-'+i);
      if(stepDiv) {
        stepDiv.style.display = (i===n) ? 'block' : 'none';
        if(i===n) console.log(`Step ${i} display set to block`);
      } else {
        console.error(`step-${i} not found!`);
      }
    }
    flow?.scrollIntoView({behavior:'smooth', block:'start'});
  }
  window.gotoStep = gotoStep;

  // Toolbar actions
  // === Config Tabs behavior ===
  function initConfigTabs(){
    const root = document.getElementById('config-root');
    if(!root) return;
    const tabs = root.querySelectorAll('.tab');
    // Updated list of sections (removed risk-matrix and early-warning)
    const sectionIds = ['data-validation','reg-rules','analytics','insp-templates','integrations'];
    const sections = sectionIds.map(id => document.getElementById(id)).filter(Boolean);
    function activate(target){
      tabs.forEach(t => t.classList.toggle('active', t.getAttribute('data-target')===target));
      sections.forEach(sec => { sec.style.display = (sec.id === target) ? 'block' : 'none'; });
    }
    tabs.forEach(t => t.addEventListener('click', ()=> activate(t.getAttribute('data-target'))));
    const first = tabs[0];
    const defaultTarget = (root.querySelector('.tab.active') || first)?.getAttribute('data-target') || 'data-validation';
    activate(defaultTarget);
  }

  // Button click handlers
  $('#btn-home')?.addEventListener('click', ()=> {
    showOnly('home');
    // ensure the home tabs reset to the default (first) tab (Risk Based Supervision)
    const firstTab = document.querySelector('#home .tabs .tab');
    if(firstTab) firstTab.click();
    // scroll to top of app for good measure
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });
  $('#btn-start')?.addEventListener('click', ()=> { showOnly('flow'); gotoStep(1); });
  $('#btn-view-ongoing')?.addEventListener('click', ()=> showOnly('ongoing'));
  $('#btn-view-completed')?.addEventListener('click', ()=> showOnly('completed'));
  $('#btn-config')?.addEventListener('click', ()=> { showOnly('config'); initConfigTabs(); });
  
  // Company Dashboard navigation
  $('#btn-back-to-inspections')?.addEventListener('click', ()=> {
    showOnly('completed'); // Return to completed inspections list by default
  });

  // Toggle section visibility in company dashboard
  window.toggleSection = function(sectionId) {
    const section = document.getElementById(sectionId);
    const iconId = 'toggle-icon-' + sectionId.split('-')[1];
    const icon = document.getElementById(iconId);
    
    if(section && icon) {
      section.classList.toggle('collapsed');
      icon.classList.toggle('collapsed');
    }
  };

  // Company selector dropdown handler
  $('#company-selector')?.addEventListener('change', function(){
    const selectedInsurer = this.value;
    if(!selectedInsurer) return;
    
    // Update company name in dashboard
    const companyNameEl = $('#company-name');
    if(companyNameEl) companyNameEl.textContent = selectedInsurer;
    
    // Update dashboard data based on selection
    updateDashboardData(selectedInsurer);
  });

  // Function to update dashboard data based on selected insurer
  function updateDashboardData(insurerName){
    // Sample data for different insurers
    const insurerData = {
      'LIC': {
        type: 'Life Insurance',
        totalInspections: 12,
        dataQuality: '89/100',
        complianceScore: '92/100',
        riskRating: 'Low',
        riskTrend: '↓',
        riskColor: '#10b981'
      },
      'ICICI Lombard': {
        type: 'General Insurance',
        totalInspections: 8,
        dataQuality: '78/100',
        complianceScore: '75/100',
        riskRating: 'Medium',
        riskTrend: '→',
        riskColor: '#f59e0b'
      },
      'SBI Life': {
        type: 'Life Insurance',
        totalInspections: 9,
        dataQuality: '85/100',
        complianceScore: '88/100',
        riskRating: 'Medium',
        riskTrend: '↓',
        riskColor: '#f59e0b'
      },
      'HDFC Ergo': {
        type: 'General Insurance',
        totalInspections: 6,
        dataQuality: '91/100',
        complianceScore: '94/100',
        riskRating: 'Low',
        riskTrend: '→',
        riskColor: '#10b981'
      },
      'Wisdom General Insurance Co. Ltd.': {
        type: 'General Insurance',
        totalInspections: 7,
        dataQuality: '72/100',
        complianceScore: '68/100',
        riskRating: 'High',
        riskTrend: '↑',
        riskColor: '#ef4444'
      }
    };

    const data = insurerData[insurerName] || insurerData['Wisdom General Insurance Co. Ltd.'];

    // Update company type badge
    const typeBadge = document.querySelector('.company-type-badge');
    if(typeBadge) typeBadge.textContent = data.type;

    // Update header meta values
    const totalInspEl = $('#meta-total-inspections');
    const dataQualityEl = $('#meta-data-quality');
    const complianceEl = $('#meta-compliance-score');
    const riskRatingEl = $('#meta-risk-rating');

    if(totalInspEl) totalInspEl.textContent = data.totalInspections;
    if(dataQualityEl) dataQualityEl.textContent = data.dataQuality;
    if(complianceEl) complianceEl.textContent = data.complianceScore;
    if(riskRatingEl) {
      riskRatingEl.innerHTML = `${data.riskRating} <span class="trend-arrow ${data.riskTrend === '↑' ? 'trend-up' : data.riskTrend === '↓' ? 'trend-down' : 'trend-stable'}" style="font-size:1.25rem;">${data.riskTrend}</span>`;
      riskRatingEl.style.color = data.riskColor;
    }

    // Scroll to top of dashboard
    window.scrollTo({top:0, behavior:'smooth'});
  }

  // Home tabs behavior: switch panels inside #home
  (function(){
    const homeRoot = document.getElementById('home');
    if(!homeRoot) return;
    const tabs = Array.from(homeRoot.querySelectorAll('.tabs .tab'));
    const panels = ['rbs','supervision','enforcement','grievance'];

    // show the selected home panel; when `collapse` is true hide other main tabs (show only active)
    function activateHome(target, collapse=false){
      // mark active tab
      tabs.forEach(t => t.classList.toggle('active', t.getAttribute('data-home')===target));
      // show only the selected panel
      panels.forEach(p => {
        const el = document.getElementById('home-' + p);
        if(el) el.style.display = (p === target) ? 'block' : 'none';
      });
      // supervision-specific sub-toolbar
      const supToolbar = document.getElementById('supervision-toolbar');
      if(supToolbar) supToolbar.style.display = (target === 'supervision') ? 'flex' : 'none';

      // collapse other main tabs when requested (keeps only the active main tab visible)
      tabs.forEach(t => {
        if(collapse){
          t.style.display = (t.getAttribute('data-home')===target) ? 'inline-flex' : 'none';
        } else {
          t.style.display = ''; // restore default / original display
        }
      });
    }

    // wire up clicks
    tabs.forEach(t => t.addEventListener('click', (ev) => activateHome(t.getAttribute('data-home'), !!ev.isTrusted)));

    // ensure initial panel visible but do NOT collapse other tabs on initial load/programmatic click
    const active = tabs.find(t => t.classList.contains('active')) || tabs[0];
    if(active) activateHome(active.getAttribute('data-home'), false);
  })();

 // Step nav clicks
 
   $$('.step').forEach(s => s.addEventListener('click', ()=> gotoStep(parseInt(s.dataset.step))));
 
  // Team pills
  function renderPills(){
     const sel = $$('.team').filter(b => b.checked).map(b => b.value);
     const pills = $('#team-pills');
     if(pills) pills.innerHTML = sel.map(m => `<span class="pill"><b>${m}</b></span>`).join('');
   }
   $$('.team').forEach(b => b.addEventListener('change', renderPills));
   renderPills();

  // Show only field dropdowns for categories selected in the multi-select (#data-cats)
  (function(){
    const dataCats = document.getElementById('data-cats');
    const cats = ['claims','under','griev','sales'];
    function updateVisible(){
      const selected = dataCats ? Array.from(dataCats.selectedOptions).map(o=>o.value) : [];
      cats.forEach(cat => {
        const el = document.getElementById('fields-' + cat);
        if(!el) return;
        // show details only if category selected; otherwise hide
        el.style.display = selected.includes(cat) ? 'block' : 'none';
        // open the details panel when shown for convenience
        if(el.tagName === 'DETAILS') el.open = selected.includes(cat);
      });
    }
    if(dataCats){
      // initialize according to default selection (none selected by default)
      updateVisible();
      dataCats.addEventListener('change', updateVisible);
    }
  })();

  // Create inspection

  $('#create-inspection')?.addEventListener('click', ()=>{
    const insurer = $('#insurer')?.value;
    const from    = $('#from')?.value;
    const to      = $('#to')?.value;
    const chosen  = $$('.team').filter(b=>b.checked).map(b=>b.value);

    if(!insurer || !from || !to || chosen.length===0){
      alert('Fill insurer, dates, and team.');
      return;
    }
    const active = $('#kpi-active'); if(active) active.textContent = String((+active.textContent||0)+1);
    gotoStep(2);
  });

  // ========== STAGE 2: Data Fetch (Refactored) ==========
  
  // Function to update Stage 2 summary and gaps based on table data
  function updateStage2Summary() {
    const rows = $$('#unified-data-tbody tr[data-required="true"]');
    
    let totalRequired = rows.length;
    let datasetsFetched = 0;
    let submissionsReceived = 0;
    let periodIssues = 0;
    
    const missingDatasets = [];
    const missingSubmissions = [];
    const periodIssuesList = [];
    
    rows.forEach(row => {
      const dataset = row.getAttribute('data-dataset');
      const dsfStatus = row.getAttribute('data-dsf-status');
      const submissionStatus = row.getAttribute('data-submission-status');
      const periodOk = row.getAttribute('data-period-ok') === 'true';
      
      // Count fetched datasets
      if (dsfStatus === 'fetched') {
        datasetsFetched++;
      } else {
        missingDatasets.push(dataset);
      }
      
      // Count received submissions
      if (submissionStatus === 'received') {
        submissionsReceived++;
      } else {
        missingSubmissions.push(dataset);
      }
      
      // Count period issues
      if (!periodOk) {
        periodIssues++;
        periodIssuesList.push(dataset);
      }
    });
    
    // Update summary card
    const summaryDatasets = $('#summary-datasets');
    if (summaryDatasets) {
      summaryDatasets.textContent = `${datasetsFetched} / ${totalRequired}`;
    }
    
    const summarySubmissions = $('#summary-submissions');
    if (summarySubmissions) {
      summarySubmissions.textContent = `${submissionsReceived} / ${totalRequired}`;
    }
    
    const summaryPeriods = $('#summary-periods');
    if (summaryPeriods) {
      if (periodIssues === 0) {
        summaryPeriods.textContent = 'All periods OK';
        summaryPeriods.style.color = 'var(--color-accent-success)';
      } else {
        summaryPeriods.textContent = `${periodIssues} issue${periodIssues > 1 ? 's' : ''} found`;
        summaryPeriods.style.color = 'var(--color-accent-warning)';
      }
    }
    
    // Update Proceed to Validation button state
    const allComplete = (datasetsFetched === totalRequired) && 
                        (submissionsReceived === totalRequired) && 
                        (periodIssues === 0);
    
    const proceedBtn = $('#btn-proceed-validation');
    const helpText = $('#proceed-help-text');
    
    if (proceedBtn) {
      proceedBtn.disabled = !allComplete;
    }
    
    if (helpText) {
      helpText.style.display = allComplete ? 'none' : 'block';
    }
    
    // Update Gaps panel
    const gapsMissingDatasets = $('#gaps-missing-datasets');
    if (gapsMissingDatasets) {
      if (missingDatasets.length === 0) {
        gapsMissingDatasets.innerHTML = '<li style="margin-bottom:var(--spacing-xs); color:var(--color-accent-success-text);">✓ None – all good</li>';
      } else {
        gapsMissingDatasets.innerHTML = missingDatasets.map(ds => 
          `<li style="margin-bottom:var(--spacing-xs);">• ${ds}</li>`
        ).join('');
      }
    }
    
    const gapsMissingSubmissions = $('#gaps-missing-submissions');
    if (gapsMissingSubmissions) {
      if (missingSubmissions.length === 0) {
        gapsMissingSubmissions.innerHTML = '<li style="margin-bottom:var(--spacing-xs); color:var(--color-accent-success-text);">✓ None – all good</li>';
      } else {
        gapsMissingSubmissions.innerHTML = missingSubmissions.map(ds => 
          `<li style="margin-bottom:var(--spacing-xs);">• ${ds}</li>`
        ).join('');
      }
    }
    
    const gapsPeriodIssues = $('#gaps-period-issues');
    if (gapsPeriodIssues) {
      if (periodIssuesList.length === 0) {
        gapsPeriodIssues.innerHTML = '<li style="margin-bottom:var(--spacing-xs); color:var(--color-accent-success-text);">✓ None – all good</li>';
      } else {
        gapsPeriodIssues.innerHTML = periodIssuesList.map(ds => 
          `<li style="margin-bottom:var(--spacing-xs);">• ${ds}</li>`
        ).join('');
      }
    }
  }
  
  // Resolve Pending Items button - scroll to gaps panel
  $('#btn-resolve-pending')?.addEventListener('click', () => {
    const gapsPanel = $('#gaps-panel');
    if (gapsPanel) {
      gapsPanel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      // Highlight effect
      gapsPanel.style.transition = 'background 0.3s ease';
      const originalBg = gapsPanel.style.background;
      gapsPanel.style.background = '#fef3c7';
      setTimeout(() => {
        gapsPanel.style.background = originalBg || '';
      }, 1000);
    }
  });
  
  // Proceed to Validation button
  $('#btn-proceed-validation')?.addEventListener('click', () => {
    gotoStep(3);
  });
  
  // Request again buttons (individual datasets)
  document.body.addEventListener('click', (e) => {
    if (e.target.classList.contains('request-again-btn')) {
      const dataset = e.target.getAttribute('data-dataset');
      alert(`Request sent to insurer for dataset: ${dataset} (simulated)`);
      
      // Simulate data being received after request
      const row = e.target.closest('tr');
      if (row) {
        // Update row attributes
        row.setAttribute('data-dsf-status', 'fetched');
        row.setAttribute('data-submission-status', 'received');
        row.setAttribute('data-period-ok', 'true');
        
        // Update DSF Status cell
        const dsfCell = row.children[2];
        if (dsfCell) {
          dsfCell.innerHTML = '<span class="chip ok">✓ Fetched</span>';
        }
        
        // Update Period cell
        const periodCell = row.children[3];
        if (periodCell) {
          periodCell.textContent = '2025-Q3';
        }
        
        // Update Insurer Submission cell
        const submissionCell = row.children[4];
        if (submissionCell) {
          const filename = `${dataset.toLowerCase().replace(/\//g, '_')}_2025_q3.xlsx`;
          submissionCell.innerHTML = `
            <span class="chip ok">✓ Received</span>
            <div style="font-size:0.75rem; color:var(--color-text-muted); margin-top:0.25rem;">${filename}</div>
          `;
        }
        
        // Update Last Updated cell
        const ts = new Date().toLocaleString('en-GB', {
          hour: '2-digit',
          minute: '2-digit',
          day: '2-digit',
          month: 'short',
          year: 'numeric'
        });
        const lastUpdatedCell = row.children[5];
        if (lastUpdatedCell) {
          lastUpdatedCell.textContent = ts;
        }
        
        // Update Actions cell
        const actionsCell = row.children[6];
        if (actionsCell) {
          actionsCell.innerHTML = '<button class="btn small link" type="button" onclick="alert(\'View details for ' + dataset + '\')">View details</button>';
        }
        
        // Refresh summary
        updateStage2Summary();
      }
    }
  });
  
  // Trigger All Reminders button
  $('#btn-trigger-all-reminders')?.addEventListener('click', () => {
    const rows = $$('#unified-data-tbody tr[data-required="true"]');
    const missingDatasets = [];
    
    rows.forEach(row => {
      const dsfStatus = row.getAttribute('data-dsf-status');
      const submissionStatus = row.getAttribute('data-submission-status');
      
      if (dsfStatus === 'missing' || submissionStatus === 'not-received') {
        missingDatasets.push(row.getAttribute('data-dataset'));
      }
    });
    
    if (missingDatasets.length === 0) {
      alert('All datasets and submissions are complete. No reminders needed.');
    } else {
      alert(`Reminders/re-fetch triggered for: ${missingDatasets.join(', ')} (simulated)`);
    }
  });
  
  // Initialize Stage 2 summary on page load
  updateStage2Summary();

  // Validation -> proceed
  $('#btn-exception')?.addEventListener('click', ()=>{
    const content = 'CaseID,Issue,Severity\nCL-2100,Invalid date,High\nCL-2115,Missing policy ID,Medium';
    const blob = new Blob([content], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'validation_exceptions.csv'; a.click();
    URL.revokeObjectURL(url);
  });
  $('#btn-req-fix')?.addEventListener('click', ()=> alert('Request for corrected data sent to insurer (simulated).'));
  $('#btn-proceed4')?.addEventListener('click', ()=> gotoStep(4));

  // Regulatory filter + proceed
  $$('#step-4 .link[data-sev]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const sev = btn.getAttribute('data-sev');
      $$('#reg-table tr').forEach(tr => tr.style.display = (sev==='All' || tr.getAttribute('data-sev')===sev)?'':'none');
    });
  });
  $('#btn-proceed5')?.addEventListener('click', ()=> gotoStep(5));

  // Sampling add/remove
  function attachDelHandlers(){
    $$('#sample-table .del').forEach(b => b.onclick = (e)=>{ e.target.closest('tr')?.remove(); });
  }
  attachDelHandlers();
  $('#add-case')?.addEventListener('click', ()=>{
    const id = $('#add-id')?.value.trim();
    if(!id) return;
    $('#sample-table')?.insertAdjacentHTML('beforeend', `<tr><td>${id}</td><td>Manual add</td><td><button class="link del" type="button">Remove</button></td></tr>`);
    const addId = $('#add-id'); if(addId) addId.value='';
    attachDelHandlers();
  });

  // Clarifications
  $('#clarify-table')?.addEventListener('click', (e)=>{
    if(e.target.classList.contains('mark-rec')){
      const td = e.target.closest('tr').children[2];
      td.innerHTML = '<span class="chip ok">✓ Received</span>';
    }
  });
  $('#clarify-add')?.addEventListener('click', ()=>{
    const id  = $('#clarify-id')?.value.trim();
    const txt = $('#clarify-text')?.value.trim();
    if(!id || !txt) return;
    $('#clarify-table')?.insertAdjacentHTML('beforeend', `<tr><td>${id}</td><td>${txt}</td><td><span class="chip warn">Pending</span></td><td><button class="link mark-rec" type="button">Mark Received</button></td></tr>`);
    const idEl  = $('#clarify-id');  if(idEl)  idEl.value='';
    const txtEl = $('#clarify-text'); if(txtEl) txtEl.value='';
  });

  // Finalize -> onsite
  $('#finalize-sample')?.addEventListener('click', ()=> gotoStep(6));

  // Onsite -> observations
  $('#flag-risk')?.addEventListener('click', ()=> alert('High-risk issue flagged (simulated).'));
  $('#btn-proceed7')?.addEventListener('click', ()=> gotoStep(7));

  // Observations interactions
  $('#add-obs')?.addEventListener('click', ()=>{
    const text = $('#obs-text')?.value.trim();
    const sev  = $('#obs-sev')?.value;
    if(!text) return;
    $('#obs-table')?.insertAdjacentHTML('beforeend', `<tr><td>${text}</td><td><span class="chip ${sev==='High'?'miss':sev==='Medium'?'warn':'info'}">${sev}</span></td><td>0</td><td>Draft</td></tr>`);
    const t = $('#obs-text'); if(t) t.value='';
  });
  $('#btn-generate')?.addEventListener('click', ()=> alert('PDF generated (simulated).'));
  $('#btn-download')?.addEventListener('click', ()=> alert('Word exported (simulated).'));

  // final report modal handlers
  const modal = document.getElementById('report-modal');
  const reportIdEl = document.getElementById('report-id');
  function openReport(id){
    if(reportIdEl) reportIdEl.textContent = id;
    if(modal){ modal.classList.add('show'); modal.setAttribute('aria-hidden','false'); }
  }
  function closeReport(){
    if(modal){ modal.classList.remove('show'); modal.setAttribute('aria-hidden', 'true'); }
  }
  // delegated click handler for view buttons (report) and comm buttons
  document.body.addEventListener('click', function(e){
    const t = e.target;
    if(!t) return;
    
    // Company dashboard link (insurer name)
    if(t.classList && t.classList.contains('insurer-link')){
      e.preventDefault();
      const insurerName = t.getAttribute('data-insurer') || 'Unknown Insurer';
      showCompanyDashboard(insurerName);
      return;
    }
    
    // final report open
    if(t.classList && t.classList.contains('view-report')){
      const id = t.getAttribute('data-id') || '—';
      const reportIdEl = document.getElementById('report-id');
      const modal = document.getElementById('report-modal');
      if(reportIdEl) reportIdEl.textContent = id;
      if(modal){ modal.classList.add('show'); modal.setAttribute('aria-hidden','false'); }
      return;
    }
    // communication open
    if(t.classList && t.classList.contains('comm-btn')){
      const id = t.getAttribute('data-id') || '—';
      const commModal = document.getElementById('comm-modal');
      const commIdEl = document.getElementById('comm-ins-id');
      const commThread = document.getElementById('comm-thread');
      if(commIdEl) commIdEl.textContent = id;
      if(commThread) commThread.innerHTML = `<div class="muted">Conversation with ${id} (dummy)</div>
        <div style="margin-top:8px;"><b>Regulator:</b> Please provide missing dataset.</div>
        <div style="margin-top:6px;"><b>Insurer:</b> Will upload shortly.</div>`;
      if(commModal){ commModal.classList.add('show'); commModal.setAttribute('aria-hidden','false'); }
      document.getElementById('comm-input')?.focus();
      return;
    }
    // close buttons
    if(t.id === 'report-close' || t.id === 'report-close-2') {
      document.getElementById('report-modal')?.classList.remove('show');
      document.getElementById('report-modal')?.setAttribute('aria-hidden','true');
    }
    if(t.id === 'comm-close' || t.id === 'comm-close-2') {
      document.getElementById('comm-modal')?.classList.remove('show');
      document.getElementById('comm-modal')?.setAttribute('aria-hidden','true');
    }
    if(t.id === 'report-download') {
      const reportId = document.getElementById('report-id')?.textContent || '—';
      alert('Download (dummy) — report for ' + reportId);
    }
  });
  // send message handler (dummy)
  document.getElementById('comm-send')?.addEventListener('click', function(){
    const input = document.getElementById('comm-input');
    const thread = document.getElementById('comm-thread');
    const txt = input?.value?.trim();
    if(!txt) return;
    const div = document.createElement('div');
    div.style.marginTop = '8px';
    div.innerHTML = `<div style="text-align:right;"><b>You:</b> ${escapeHtml(txt)}</div>`;
    thread?.appendChild(div);
    thread.scrollTop = thread.scrollHeight;
    if(input) input.value = '';
    setTimeout(()=> {
      const r = document.createElement('div');
      r.style.marginTop = '6px';
      r.innerHTML = `<div><b>Insurer:</b> (auto reply) Received.</div>`;
      thread?.appendChild(r);
      thread.scrollTop = thread.scrollHeight;
    }, 600);
  });
  function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  // close modal when clicking on overlay
  document.getElementById('report-modal')?.addEventListener('click', function(e){ if(e.target === this) this.classList.remove('show'); });
  document.getElementById('comm-modal')?.addEventListener('click', function(e){ if(e.target === this) this.classList.remove('show'); });
  // --- Task checklist behaviour (added) ---
  (function(){
    function updateStepState(n){
      const boxes = Array.from(document.querySelectorAll('.task-checkbox[data-step="'+n+'"]'));
      if(boxes.length === 0) return;
      const all = boxes.every(b => b.checked);
      const chip = document.querySelector('.stage-chip[data-step="'+n+'"]');
      const navStep = document.querySelector('.steps .step[data-step="'+n+'"]');

      if(all){
        if(chip) chip.style.display = 'inline-block';
        if(navStep) navStep.classList.add('done');
      } else {
        if(chip) chip.style.display = 'none';
        if(navStep) navStep.classList.remove('done');
      }
    }
    // attach listeners
    document.querySelectorAll('.task-checkbox').forEach(cb => {
      cb.addEventListener('change', (e)=>{
        const n = e.target.getAttribute('data-step');
        updateStepState(n);
      });
    });
    // initialize existing state on load (in case some boxes are pre-checked)
    const steps = ['1','2','3','4','5','6','7'];
    steps.forEach(s => updateStepState(s));
  })();

  // Role switch: Regulator-Admin <-> Regulator-User <-> Insurer
  (function(){
    const roleSwitch = document.getElementById('role-switch');
    const regulatorAdminView = document.getElementById('regulator-admin-view');
    const regulatorUserView = document.getElementById('regulator-user-view');
    const insurerView = document.getElementById('insurer-view');
    const config = document.getElementById('config-root');
    const homeBtn = document.getElementById('btn-home');

    function setRole(role){
      if(role === 'insurer'){
        // Show Insurer view only
        if(regulatorAdminView) regulatorAdminView.style.display = 'none';
        if(regulatorUserView) regulatorUserView.style.display = 'none';
        if(insurerView) insurerView.style.display = 'block';
        if(config) config.style.display = 'none';
        if(homeBtn) homeBtn.style.display = 'none';
      } else if(role === 'regulator-user'){
        // Show Regulator-User view only
        if(regulatorAdminView) regulatorAdminView.style.display = 'none';
        if(regulatorUserView) regulatorUserView.style.display = 'block';
        if(insurerView) insurerView.style.display = 'none';
        if(config) config.style.display = 'none';
        if(homeBtn) homeBtn.style.display = 'none'; // User view has its own navigation
      } else {
        // Show Regulator-Admin view (default)
        if(regulatorAdminView) regulatorAdminView.style.display = 'block';
        if(regulatorUserView) regulatorUserView.style.display = 'none';
        if(insurerView) insurerView.style.display = 'none';
        if(config) config.style.display = 'none';
        if(homeBtn) homeBtn.style.display = '';
        // Reset to home view for regulator admin
        showOnly('home');
      }
      // Scroll to top
      window.scrollTo({top:0, behavior:'smooth'});
    }

    roleSwitch?.addEventListener('change', function(){
      setRole(this.value);
    });

    // Insurer tab navigation
    (function(){
      const insurerRoot = document.getElementById('insurer-view');
      if(!insurerRoot) return;
      const tabs = Array.from(insurerRoot.querySelectorAll('.tabs .tab'));
      const panels = ['overview', 'requirements', 'reports', 'observations', 'history'];

      function activateInsurerTab(target){
        // mark active tab
        tabs.forEach(t => t.classList.toggle('active', t.getAttribute('data-insurer-target')===target));
        // show only the selected panel
        panels.forEach(p => {
          const el = document.getElementById('insurer-' + p);
          if(el) el.style.display = (p === target) ? 'block' : 'none';
        });
      }

      // wire up clicks
      tabs.forEach(t => t.addEventListener('click', () => activateInsurerTab(t.getAttribute('data-insurer-target'))));

      // ensure initial panel visible
      const active = tabs.find(t => t.classList.contains('active')) || tabs[0];
      if(active) activateInsurerTab(active.getAttribute('data-insurer-target'));
    })();

    // inspector row click: update details panel
    document.getElementById('insurer-inspections-body')?.addEventListener('click', function(e){
      const tr = e.target.closest('tr[data-inspection]');
      if(!tr) return;
      const id = tr.getAttribute('data-inspection');
      const title = document.getElementById('insurer-work-title');
      const status = document.getElementById('insurer-validation-status');
      if(title) title.textContent = 'Inspection details — ' + id;
      if(status) status.textContent = tr.children[3]?.textContent || 'Data pending';
      // replace messages for demo
      const msgs = document.getElementById('insurer-messages');
      if(msgs){
        msgs.innerHTML = `<li>IRDAI request: Please upload dataset as per DSF.</li>
                          <li>Deadline: ${tr.children[4]?.textContent || '—'}</li>`;
      }
    });

    // demo DSF download (just a small CSV)
    document.getElementById('insurer-download-dsf')?.addEventListener('click', function(){
      const csv = 'case_id,policy_number,claim_date,amount\n';
      const blob = new Blob([csv], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'dsf_template.csv'; a.click();
      URL.revokeObjectURL(url);
    });

    // demo upload behaviour: mark validation status as "Submitted" then "Under validation"
    document.getElementById('insurer-upload-btn')?.addEventListener('click', function(){
      const fileEl = document.getElementById('insurer-upload-file');
      const status = document.getElementById('insurer-validation-status');
      if(!fileEl || !fileEl.files || fileEl.files.length===0){ alert('Choose a file to upload'); return; }
      if(status) status.textContent = 'Submitted — awaiting validation';
      // simulate async validation result
      setTimeout(()=>{
        if(status) status.textContent = 'Under validation';
      }, 800);
    });

    // initialize default role
    setRole(roleSwitch?.value || 'regulator');
  })();

  // === Insurer View Tab Switching (insurer-specific only) ===
  (function(){
    // Only run if insurer view exists
    const insurerView = document.getElementById('insurer-view');
    if(!insurerView) return;

    const insurerTabs = insurerView.querySelectorAll('.insurer-tab');
    const insurerPanels = insurerView.querySelectorAll('.insurer-tab-panel');

    insurerTabs.forEach(tab => {
      tab.addEventListener('click', function(){
        const targetPanel = this.getAttribute('data-insurer-tab');
        
        // Remove active from all tabs and panels
        insurerTabs.forEach(t => t.classList.remove('active'));
        insurerPanels.forEach(p => p.classList.remove('active'));
        
        // Add active to clicked tab
        this.classList.add('active');
        
        // Show corresponding panel
        const panel = insurerView.querySelector(`.insurer-tab-panel[data-panel="${targetPanel}"]`);
        if(panel) panel.classList.add('active');
      });
    });
  })();
  
  // === Step 1: Automatic task status indicators ===
  (function(){
    let step1Created = false;

    // Get form elements
    const insurerSelect = document.getElementById('insurer');
    const fromInput = document.getElementById('from');
    const toInput = document.getElementById('to');
    const templateSelect = document.getElementById('template-select');
    const dataCatsSelect = document.getElementById('data-cats');
    const modeTemplate = document.getElementById('mode-template');
    const modeManual = document.getElementById('mode-manual');
    const teamCheckboxes = document.querySelectorAll('.team');
    const createBtn = document.getElementById('create-inspection');
    const step1TasksList = document.getElementById('step1-tasks');

    function updateStep1Tasks(){
      if(!step1TasksList) return;

      // Evaluate conditions
      const conditions = {
        insurer: insurerSelect?.value !== '',
        dates: !!(fromInput?.value && toInput?.value),
        scope: false,
        team: Array.from(teamCheckboxes).some(cb => cb.checked),
        create: step1Created
      };

      // Check scope: either template selected OR manual categories selected
      if(modeTemplate?.checked){
        conditions.scope = templateSelect?.value !== '';
      } else if(modeManual?.checked){
        const selectedOptions = dataCatsSelect ? Array.from(dataCatsSelect.selectedOptions) : [];
        conditions.scope = selectedOptions.length > 0;
      }

      // Update each task icon
      Object.entries(conditions).forEach(([taskName, isDone]) => {
        const taskEl = step1TasksList.querySelector(`[data-task="${taskName}"]`);
        if(!taskEl) return;
        const icon = taskEl.querySelector('.task-icon');
        if(icon){
          icon.textContent = isDone ? '✓' : '✕';
          icon.classList.remove(isDone ? 'status-pending' : 'status-done');
          icon.classList.add(isDone ? 'status-done' : 'status-pending');
        }
      });

      // Check if all tasks are done
      const allDone = Object.values(conditions).every(v => v === true);
      const chip = document.querySelector('.stage-chip[data-step="1"]');
      const navStep = document.querySelector('.steps .step[data-step="1"]');

      if(allDone){
        if(chip) chip.style.display = 'inline-block';
        if(navStep) navStep.classList.add('done');
      } else {
        if(chip) chip.style.display = 'none';
        if(navStep) navStep.classList.remove('done');
      }
    }

    // Attach change listeners
    insurerSelect?.addEventListener('change', updateStep1Tasks);
    fromInput?.addEventListener('change', updateStep1Tasks);
    toInput?.addEventListener('change', updateStep1Tasks);
    templateSelect?.addEventListener('change', updateStep1Tasks);
    dataCatsSelect?.addEventListener('change', updateStep1Tasks);
    modeTemplate?.addEventListener('change', updateStep1Tasks);
    modeManual?.addEventListener('change', updateStep1Tasks);
    teamCheckboxes.forEach(cb => cb.addEventListener('change', updateStep1Tasks));

    // Create button click
    if(createBtn){
      createBtn.addEventListener('click', function(e){
        const insurer = insurerSelect?.value;
        const from    = fromInput?.value;
        const to      = toInput?.value;
        const chosen  = Array.from(teamCheckboxes).filter(b=>b.checked).map(b=>b.value);

        if(!insurer || !from || !to || chosen.length===0){
          alert('Fill insurer, dates, and team.');
          return;
        }

        // Mark as created and update tasks
        step1Created = true;
        updateStep1Tasks();

        // Original logic
        const active = document.getElementById('kpi-active');
        if(active) active.textContent = String((+active.textContent||0)+1);
        gotoStep(2);
      });
    }

    // Initialize on load (show all as pending initially)
    updateStep1Tasks();
  })();

  // === Shared Helper: Update Stage Completion Status ===
  function updateStageCompletion(stepNumber, isComplete){
    const chip = document.querySelector(`.stage-chip[data-step="${stepNumber}"]`);
    const navStep = document.querySelector(`.steps .step[data-step="${stepNumber}"]`);
    
    if(isComplete){
      if(chip) chip.style.display = 'inline-block';
      if(navStep) navStep.classList.add('done');
    } else {
      if(chip) chip.style.display = 'none';
      if(navStep) navStep.classList.remove('done');
    }
  }

  // === Step 2: Completion Logic (Refactored) ===
  // Step 2 completion is now automatically handled by the updateStage2Summary function
  // which checks if all datasets and submissions are complete

  // ========== STAGE 3: Data Validation (Improved with Auto Task Tracking) ==========
  
  // --- Stage 3: Data Validation state ---
  let stage3State = {
    validationRun: false,
    errorsReviewed: false,
    sentToInsurer: false,
    datasetFinalized: false
  };

  // Function to update Stage 3 task icons based on state
  function updateStage3TasksUI() {
    // Helper to set task status icon
    function setTaskStatus(taskId, done) {
      const taskItem = document.querySelector(`[data-task-id="${taskId}"]`);
      if (!taskItem) return;
      const icon = taskItem.querySelector('.task-status-icon');
      if (!icon) return;

      if (done) {
        icon.textContent = '✓';
        icon.classList.remove('status-pending');
        icon.classList.add('status-done');
      } else {
        icon.textContent = '✕';
        icon.classList.remove('status-done');
        icon.classList.add('status-pending');
      }
    }

    // Update all task icons
    setTaskStatus('runValidationTask', stage3State.validationRun);
    setTaskStatus('reviewErrorsTask', stage3State.errorsReviewed);
    setTaskStatus('sendToInsurerTask', stage3State.sentToInsurer);
    setTaskStatus('finalizeDatasetTask', stage3State.datasetFinalized);

    // Enable Proceed button when first 3 tasks are done (not including finalize)
    const proceedBtn = $('#proceedToRegChecksBtn');
    if (proceedBtn) {
      const first3Done = stage3State.validationRun && stage3State.errorsReviewed && stage3State.sentToInsurer;
      proceedBtn.disabled = !first3Done;
    }

    // Mark Stage 3 as completed when all 4 tasks are done
    const allDone = Object.values(stage3State).every(Boolean);
    updateStageCompletion(3, allDone);
  }

  // Utility to update validation status text
  function setValidationRunStatus(message) {
    const statusText = $('#validationStatusText');
    if (statusText) statusText.textContent = message;

    const lastRunText = $('#validationLastRunText');
    if (lastRunText) {
      const now = new Date();
      lastRunText.textContent = 'Last run: ' + now.toLocaleString('en-GB', {
        hour: '2-digit',
        minute: '2-digit',
        day: '2-digit',
        month: 'short',
        year: 'numeric'
      });
    }
  }

  // Wire up Stage 3 button click events
  const runValidationBtn = $('#runValidationBtn');
  const downloadExceptionBtn = $('#downloadExceptionBtn');
  const requestCorrectedDataBtn = $('#requestCorrectedDataBtn');
  const proceedToRegChecksBtn = $('#proceedToRegChecksBtn');

  if (runValidationBtn) {
    runValidationBtn.addEventListener('click', function() {
      setValidationRunStatus('Running validation on all datasets...');
      
      // Visual feedback on button
      this.style.background = 'var(--color-accent-warning)';
      
      // Simulate validation run
      setTimeout(() => {
        stage3State.validationRun = true;
        setValidationRunStatus('Validation completed. Review exceptions and error counts.');
        updateStage3TasksUI();
        checkStage3DataCleanup();
        
        // Reset button color
        this.style.background = '';
      }, 800);
    });
  }

  if (downloadExceptionBtn) {
    downloadExceptionBtn.addEventListener('click', function() {
      // Mark as reviewed after download
      stage3State.errorsReviewed = true;
      updateStage3TasksUI();
      checkStage3DataCleanup();
      
      // Visual feedback
      this.style.background = 'var(--color-accent-success)';
      setTimeout(() => {
        this.style.background = '';
      }, 800);
      
      // Original download functionality
      const content = 'CaseID,Issue,Severity\nCL-2100,Invalid date,High\nCL-2115,Missing policy ID,Medium';
      const blob = new Blob([content], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; 
      a.download = 'validation_exceptions.csv'; 
      a.click();
      URL.revokeObjectURL(url);
      
      console.log('Exception report downloaded - task marked as reviewed.');
    });
  }

  if (requestCorrectedDataBtn) {
    requestCorrectedDataBtn.addEventListener('click', function() {
      // Mark as sent to insurer
      stage3State.sentToInsurer = true;
      updateStage3TasksUI();
      checkStage3DataCleanup();
      
      // Visual feedback
      this.style.background = 'var(--color-accent-success)';
      setTimeout(() => {
        this.style.background = '';
      }, 800);
      
      // Show alert
      alert('Request for corrected data sent to insurer (simulated).');
      console.log('Validation issues sent to insurer for correction.');
    });
  }

  // Helper function to check if all 3 actions are done and clear exceptions
  function checkStage3DataCleanup() {
    if (stage3State.validationRun && stage3State.errorsReviewed && stage3State.sentToInsurer) {
      // Clear exceptions - set to 0
      const valExc = $('#val-exc');
      const valHigh = $('#val-high');
      
      if (valExc) {
        valExc.textContent = '0';
      }
      
      if (valHigh) {
        valHigh.textContent = '0';
        // Also hide the HIGH chip
        const highChip = valHigh.nextElementSibling;
        if (highChip && highChip.classList.contains('chip')) {
          highChip.style.display = 'none';
        }
      }
      
      // Update status text
      setValidationRunStatus('All exceptions resolved. Data is clean and ready for regulatory checks.');
    }
  }

  if (proceedToRegChecksBtn) {
    proceedToRegChecksBtn.addEventListener('click', function() {
      // Mark dataset as finalized
      if (!stage3State.datasetFinalized) {
        stage3State.datasetFinalized = true;
        updateStage3TasksUI();
      }
      
      // Visual feedback
      this.style.background = 'var(--color-accent-success)';
      setTimeout(() => {
        this.style.background = '';
      }, 500);
      
      // Navigate to Stage 4
      gotoStep(4);
    });
  }

  // Initialize Stage 3 UI on page load
  updateStage3TasksUI();

  // === Step 4: Button-Driven Task Completion Logic (Regulatory Check) ===
  (function(){
    // State object to track Step 4 task completion
    const step4Tasks = {
      runRegChecks: false,
      reviewHighSeverity: false,
      tagBreaches: false,
      parkItems: false
    };

    // Get all buttons that trigger task completion
    const btnRunRegChecks = $('#btn4-run-reg-checks');
    const btnReviewBreaches = $('#btn4-review-breaches');
    const btnTagForObservations = $('#btn4-tag-for-observations');
    const btnProceedAnalytics = $('#btn4-proceed-analytics');

    // Get all task items
    const taskRunRegChecks = $('#task4-run-reg-checks');
    const taskReviewHighSeverity = $('#task4-review-high-severity');
    const taskTagBreaches = $('#task4-tag-breaches');
    const taskParkItems = $('#task4-park-items');

    // Helper: Mark a task as complete
    function markTaskComplete(taskElement, taskKey){
      if(!taskElement) return;
      
      const icon = taskElement.querySelector('.task-icon');
      if(icon){
        icon.textContent = '✓';
        icon.classList.remove('status-pending');
        icon.classList.add('status-done');
      }
      
      step4Tasks[taskKey] = true;
      checkStep4Completion();
    }

    // Check if Step 4 is fully complete
    function checkStep4Completion(){
      const allTasksComplete = Object.values(step4Tasks).every(v => v === true);
      updateStageCompletion(4, allTasksComplete);
    }

    // Button 1: Run Regulatory Checks
    if(btnRunRegChecks){
      btnRunRegChecks.addEventListener('click', function(){
        markTaskComplete(taskRunRegChecks, 'runRegChecks');
        this.style.background = 'var(--color-accent-success)';
        setTimeout(() => { this.style.background = ''; }, 1000);
      });
    }

    // Button 2: Review Breaches (counts as review HIGH severity breaches)
    if(btnReviewBreaches){
      btnReviewBreaches.addEventListener('click', function(){
        markTaskComplete(taskReviewHighSeverity, 'reviewHighSeverity');
        this.style.background = 'var(--color-accent-success)';
        setTimeout(() => { this.style.background = ''; }, 1000);
      });
    }

    // Button 3: Tag for Observations (counts as tag breaches)
    if(btnTagForObservations){
      btnTagForObservations.addEventListener('click', function(){
        markTaskComplete(taskTagBreaches, 'tagBreaches');
        this.style.background = 'var(--color-accent-success)';
        setTimeout(() => { this.style.background = ''; }, 1000);
      });
    }

    // Button 4: Proceed to Analytics (counts as park items needing clarification)
    if(btnProceedAnalytics){
      btnProceedAnalytics.addEventListener('click', function(){
        markTaskComplete(taskParkItems, 'parkItems');
        this.style.background = 'var(--color-accent-success)';
        setTimeout(() => { this.style.background = ''; }, 1000);
        gotoStep(5);
      });
    }

    // Initialize on load
    checkStep4Completion();
  })();

  // === Step 5: Button-Driven Task Completion Logic (Analytics & Risk-Based Sampling) ===
  (function(){
    // State object to track Step 5 task completion
    const step5Tasks = {
      runAnalytics: false,
      adjustSampling: false,
      generateSample: false,
      finalizeSample: false
    };

    // Get all buttons that trigger task completion
    const btnRunAnalytics = $('#btn5-run-analytics');
    const btnGenerateRiskScores = $('#btn5-generate-risk-scores');
    const btnCreateSample = $('#btn5-create-sample');
    const btnFinalizeSample = $('#btn5-finalize-sample');

    // Get all task items
    const taskRunAnalytics = $('#task5-run-analytics');
    const taskAdjustSampling = $('#task5-adjust-sampling');
    const taskGenerateSample = $('#task5-generate-sample');
    const taskFinalizeSample = $('#task5-finalize-sample');

    // Helper: Mark a task as complete
    function markTaskComplete(taskElement, taskKey){
      if(!taskElement) return;
      
      const icon = taskElement.querySelector('.task-icon');
      if(icon){
        icon.textContent = '✓';
        icon.classList.remove('status-pending');
        icon.classList.add('status-done');
      }
      
      step5Tasks[taskKey] = true;
      checkStep5Completion();
    }

    // Check if Step 5 is fully complete
    function checkStep5Completion(){
      const allTasksComplete = Object.values(step5Tasks).every(v => v === true);
      updateStageCompletion(5, allTasksComplete);
    }

    // Button 1: Run Analytics
    if(btnRunAnalytics){
      btnRunAnalytics.addEventListener('click', function(){
        markTaskComplete(taskRunAnalytics, 'runAnalytics');
        this.style.background = 'var(--color-accent-success)';
        setTimeout(() => { this.style.background = ''; }, 1000);
      });
    }

    // Button 2: Generate Risk Scores (counts as adjust sampling logic)
    if(btnGenerateRiskScores){
      btnGenerateRiskScores.addEventListener('click', function(){
        markTaskComplete(taskAdjustSampling, 'adjustSampling');
        this.style.background = 'var(--color-accent-success)';
        setTimeout(() => { this.style.background = ''; }, 1000);
      });
    }

    // Button 3: Create Sample (counts as generate sample list)
    if(btnCreateSample){
      btnCreateSample.addEventListener('click', function(){
        markTaskComplete(taskGenerateSample, 'generateSample');
        this.style.background = 'var(--color-accent-success)';
        setTimeout(() => { this.style.background = ''; }, 1000);
      });
    }

    // Button 4: Finalize Sample
    if(btnFinalizeSample){
      btnFinalizeSample.addEventListener('click', function(){
        markTaskComplete(taskFinalizeSample, 'finalizeSample');
        this.style.background = 'var(--color-accent-success)';
        setTimeout(() => { this.style.background = ''; }, 1000);
        gotoStep(6);
      });
    }

    // Initialize on load
    checkStep5Completion();
  })();

  // === Step 6: Button-Driven Task Completion Logic (Onsite Inspection Support) ===
  (function(){
    // State object to track Step 6 task completion
    const step6Tasks = {
      downloadSample: false,
      captureNotes: false,
      uploadEvidence: false,
      flagIssues: false
    };

    // Get all buttons that trigger task completion
    const btnDownloadSampleFile = $('#btn6-download-sample-file');
    const btnSaveNotes = $('#btn6-save-notes');
    const btnUploadEvidence = $('#btn6-upload-evidence');
    const btnProceedReport = $('#btn6-proceed-report');

    // Get all task items
    const taskDownloadSample = $('#task6-download-sample');
    const taskCaptureNotes = $('#task6-capture-notes');
    const taskUploadEvidence = $('#task6-upload-evidence');
    const taskFlagIssues = $('#task6-flag-issues');

    // Helper: Mark a task as complete
    function markTaskComplete(taskElement, taskKey){
      if(!taskElement) return;
      
      const icon = taskElement.querySelector('.task-icon');
      if(icon){
        icon.textContent = '✓';
        icon.classList.remove('status-pending');
        icon.classList.add('status-done');
      }
      
      step6Tasks[taskKey] = true;
      checkStep6Completion();
    }

    // Check if Step 6 is fully complete
    function checkStep6Completion(){
      const allTasksComplete = Object.values(step6Tasks).every(v => v === true);
      updateStageCompletion(6, allTasksComplete);
    }

    // Button 1: Download Sample File
    if(btnDownloadSampleFile){
      btnDownloadSampleFile.addEventListener('click', function(){
        markTaskComplete(taskDownloadSample, 'downloadSample');
        this.style.background = 'var(--color-accent-success)';
        setTimeout(() => { this.style.background = ''; }, 1000);
      });
    }

    // Button 2: Save Notes (counts as capture onsite notes)
    if(btnSaveNotes){
      btnSaveNotes.addEventListener('click', function(){
        markTaskComplete(taskCaptureNotes, 'captureNotes');
        this.style.background = 'var(--color-accent-success)';
        setTimeout(() => { this.style.background = ''; }, 1000);
      });
    }

    // Button 3: Upload Evidence
    if(btnUploadEvidence){
      btnUploadEvidence.addEventListener('click', function(){
        markTaskComplete(taskUploadEvidence, 'uploadEvidence');
        this.style.background = 'var(--color-accent-success)';
        setTimeout(() => { this.style.background = ''; }, 1000);
      });
    }

    // Button 4: Proceed to Report (counts as flag high-risk issues)
    if(btnProceedReport){
      btnProceedReport.addEventListener('click', function(){
        markTaskComplete(taskFlagIssues, 'flagIssues');
        this.style.background = 'var(--color-accent-success)';
        setTimeout(() => { this.style.background = ''; }, 1000);
        gotoStep(7);
      });
    }

    // Initialize on load
    checkStep6Completion();
  })();

  // === Step 7: Button-Driven Task Completion Logic (Observations & Report) ===
  (function(){
    // State object to track Step 7 task completion
    const step7Tasks = {
      draftObservations: false,
      attachEvidence: false,
      reviewObservations: false,
      generateReport: false,
      finalizeReport: false
    };

    // Get all buttons that trigger task completion
    const btnAddObservation = $('#btn7-add-observation');
    const btnDraftReport = $('#btn7-draft-report');
    const btnGeneratePdf = $('#btn7-generate-pdf');
    const btnFinalizeReport = $('#btn7-finalize-report');
    const btnShareReport = $('#btn7-share-report');

    // Get all task items
    const taskDraftObservations = $('#task7-draft-observations');
    const taskAttachEvidence = $('#task7-attach-evidence');
    const taskReviewObservations = $('#task7-review-observations');
    const taskGenerateReport = $('#task7-generate-report');
    const taskFinalizeReport = $('#task7-finalize-report');

    // Helper: Mark a task as complete
    function markTaskComplete(taskElement, taskKey){
      if(!taskElement) return;
      
      const icon = taskElement.querySelector('.task-icon');
      if(icon){
        icon.textContent = '✓';
        icon.classList.remove('status-pending');
        icon.classList.add('status-done');
      }
      
      step7Tasks[taskKey] = true;
      checkStep7Completion();
    }

    // Check if Step 7 is fully complete
    function checkStep7Completion(){
      const allTasksComplete = Object.values(step7Tasks).every(v => v === true);
      updateStageCompletion(7, allTasksComplete);
    }

    // Button 1: Add Observation (counts as draft observations)
    if(btnAddObservation){
      btnAddObservation.addEventListener('click', function(){
        markTaskComplete(taskDraftObservations, 'draftObservations');
        // Mark attach evidence as well since adding observations includes evidence
        markTaskComplete(taskAttachEvidence, 'attachEvidence');
        this.style.background = 'var(--color-accent-success)';
        setTimeout(() => { this.style.background = ''; }, 1000);
      });
    }

    // Button 2: Draft Report (counts as review observations)
    if(btnDraftReport){
      btnDraftReport.addEventListener('click', function(){
        markTaskComplete(taskReviewObservations, 'reviewObservations');
        this.style.background = 'var(--color-accent-success)';
        setTimeout(() => { this.style.background = ''; }, 1000);
      });
    }

    // Button 3: Generate PDF (counts as generate report)
    if(btnGeneratePdf){
      btnGeneratePdf.addEventListener('click', function(){
        markTaskComplete(taskGenerateReport, 'generateReport');
        this.style.background = 'var(--color-accent-success)';
        setTimeout(() => { this.style.background = ''; }, 1000);
      });
    }

    // Button 4: Finalize Report
    if(btnFinalizeReport){
      btnFinalizeReport.addEventListener('click', function(){
        markTaskComplete(taskFinalizeReport, 'finalizeReport');
        this.style.background = 'var(--color-accent-success)';
        setTimeout(() => { this.style.background = ''; }, 1000);
      });
    }

    // Button 5: Share Report (optional additional action)
    if(btnShareReport){
      btnShareReport.addEventListener('click', function(){
        this.style.background = 'var(--color-accent-success)';
        setTimeout(() => { this.style.background = ''; }, 1000);
        alert('Report shared with insurer and management!');
      });
    }

    // Initialize on load
    checkStep7Completion();
  })();

  // === Regulator User - Tab Navigation ===
  (function(){
    const userView = document.getElementById('regulator-user-view');
    if(!userView) return;
    
    const tabs = Array.from(userView.querySelectorAll('.tabs .tab'));
    const panels = ['assigned', 'ongoing', 'completed', 'config'];

    function activateUserTab(target){
      // Mark active tab
      tabs.forEach(t => t.classList.toggle('active', t.getAttribute('data-user-target') === target));
      
      // Show only the selected panel
      panels.forEach(p => {
        const el = document.getElementById('user-' + p);
        if(el) el.style.display = (p === target) ? 'block' : 'none';
      });
    }

    // Wire up tab clicks
    tabs.forEach(t => t.addEventListener('click', () => activateUserTab(t.getAttribute('data-user-target'))));

    // Ensure initial panel visible
    const activeTab = tabs.find(t => t.classList.contains('active')) || tabs[0];
    if(activeTab) activateUserTab(activeTab.getAttribute('data-user-target'));
  })();

  // === Regulator User - Assigned Inspections Logic ===
  (function(){
    let currentUserInspection = null;

    // Get DOM elements
    const summaryPanel = document.getElementById('user-current-inspection-summary');
    const currentIdEl = document.getElementById('user-current-insp-id');
    const currentEntityEl = document.getElementById('user-current-insp-entity');
    const currentStatusEl = document.getElementById('user-current-insp-status');
    const currentDueEl = document.getElementById('user-current-insp-due');
    const btnOpenWorkflow = document.getElementById('user-btn-open-workflow');
    const btnClearSelection = document.getElementById('user-btn-clear-selection');
    const workflowArea = document.getElementById('user-workflow');
    const workflowInspIdEl = document.getElementById('user-workflow-insp-id');
    const btnBackToList = document.getElementById('user-btn-back-to-list');

    // Handle Open button clicks in all three tables
    function handleOpenInspection(e){
      const openBtn = e.target.closest('.user-btn-open');
      if(!openBtn) return;

      const row = openBtn.closest('tr');
      if(!row) return;

      // Extract inspection data from row
      currentUserInspection = {
        id: row.getAttribute('data-insp-id'),
        entity: row.getAttribute('data-entity'),
        type: row.getAttribute('data-type'),
        assigned: row.getAttribute('data-assigned'),
        due: row.getAttribute('data-due'),
        status: row.getAttribute('data-status')
      };

      // Update summary panel
      if(currentIdEl) currentIdEl.textContent = currentUserInspection.id;
      if(currentEntityEl) currentEntityEl.textContent = currentUserInspection.entity;
      if(currentStatusEl){
        let chipClass = 'chip info';
        if(currentUserInspection.status === 'In Progress') chipClass = 'chip warn';
        else if(currentUserInspection.status === 'Completed') chipClass = 'chip ok';
        currentStatusEl.innerHTML = `<span class="${chipClass}">${currentUserInspection.status}</span>`;
      }
      if(currentDueEl) currentDueEl.textContent = currentUserInspection.due;

      // Show summary panel
      if(summaryPanel){
        summaryPanel.style.display = 'block';
        summaryPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }

    // Attach event listeners to all three tables
    document.getElementById('user-assigned-table')?.addEventListener('click', handleOpenInspection);
    document.getElementById('user-ongoing-table')?.addEventListener('click', handleOpenInspection);
    document.getElementById('user-completed-table')?.addEventListener('click', handleOpenInspection);

    // Handle "Open Workflow" button
    if(btnOpenWorkflow){
      btnOpenWorkflow.addEventListener('click', function(){
        if(!currentUserInspection) return;

        // Hide the list/summary view
        document.querySelectorAll('.user-content-panel').forEach(p => p.style.display = 'none');
        if(summaryPanel) summaryPanel.style.display = 'none';

        // Show workflow area
        if(workflowArea) workflowArea.style.display = 'block';
        if(workflowInspIdEl) workflowInspIdEl.textContent = currentUserInspection.id;

        // Activate first step (Step 2) in user workflow
        const userSteps = document.querySelectorAll('#user-steps .step');
        userSteps.forEach(s => s.classList.remove('active'));
        const firstStep = document.querySelector('#user-steps .step[data-step="2"]');
        if(firstStep) firstStep.classList.add('active');

        // Show actual step content from admin view (reuse Step 2)
        showUserWorkflowStep(2);

        // Scroll to workflow
        workflowArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
      });
    }

    // Handle "Back to List" button from summary
    if(btnClearSelection){
      btnClearSelection.addEventListener('click', function(){
        currentUserInspection = null;
        if(summaryPanel) summaryPanel.style.display = 'none';
        if(currentIdEl) currentIdEl.textContent = '-';
        if(currentEntityEl) currentEntityEl.textContent = '-';
        if(currentStatusEl) currentStatusEl.textContent = '-';
        if(currentDueEl) currentDueEl.textContent = '-';
      });
    }

    // Handle "Back to Inspections List" from workflow
    if(btnBackToList){
      btnBackToList.addEventListener('click', function(){
        // Hide workflow area
        if(workflowArea) workflowArea.style.display = 'none';
        
        // Show the assigned inspections tab
        const assignedPanel = document.getElementById('user-assigned');
        if(assignedPanel) assignedPanel.style.display = 'block';
        
        // Clear current inspection
        currentUserInspection = null;
        if(summaryPanel) summaryPanel.style.display = 'none';
      });
    }

    // Function to show workflow step content (reuse admin steps 2-7)
    function showUserWorkflowStep(stepNum){
      const workflowContent = document.getElementById('user-workflow-content');
      if(!workflowContent) return;

      // Get the actual step content from admin view
      const adminStep = document.getElementById('step-' + stepNum);
      if(adminStep){
        // Clone the content (without modifying original)
        const clonedContent = adminStep.cloneNode(true);
        clonedContent.id = 'user-step-' + stepNum;
        clonedContent.style.display = 'block';
        
        // Clear previous content and show new
        workflowContent.innerHTML = '';
        workflowContent.appendChild(clonedContent);
      } else {
        workflowContent.innerHTML = '<div class="muted" style="text-align:center; padding:var(--spacing-2xl);">Step content not available</div>';
      }
    }

    // Handle step navigation in user workflow
    const userSteps = document.querySelectorAll('#user-steps .step');
    userSteps.forEach(step => {
      step.addEventListener('click', function(){
        const stepNum = parseInt(this.getAttribute('data-step'));
        
        // Update active step indicator
        userSteps.forEach(s => s.classList.remove('active'));
        this.classList.add('active');
        
        // Show step content
        showUserWorkflowStep(stepNum);
      });
    });

    // Public API
    window.getCurrentUserInspection = function(){
      return currentUserInspection;
    };
  })();

  // Edit Inspection Modal Handlers
  (function(){
    const editModal = document.getElementById('edit-modal');
    const editForm = document.getElementById('edit-form');
    const editIdEl = document.getElementById('edit-id');
    const editInspIdEl = document.getElementById('edit-insp-id');
    const editInsurerEl = document.getElementById('edit-insurer');
    const editStartDateEl = document.getElementById('edit-start-date');
    const editEndDateEl = document.getElementById('edit-end-date');
    const editStatusEl = document.getElementById('edit-status');
    const editOwnerEl = document.getElementById('edit-owner');
    const editRemarksEl = document.getElementById('edit-remarks');
    
    let currentRow = null;
    let originalData = null;

    function openEditModal(rowElement, data){
      currentRow = rowElement;
      originalData = JSON.parse(JSON.stringify(data)); // deep clone
      
      // Parse period (format: "2025-07-01 → 2025-09-30")
      const periodParts = data.period.split(' → ');
      const startDate = periodParts[0] || '';
      const endDate = periodParts[1] || '';
      
      // Populate form
      if(editIdEl) editIdEl.value = data.id;
      if(editInspIdEl) editInspIdEl.textContent = data.id;
      if(editInsurerEl) editInsurerEl.value = data.insurer;
      if(editStartDateEl) editStartDateEl.value = startDate;
      if(editEndDateEl) editEndDateEl.value = endDate;
      if(editStatusEl) editStatusEl.value = data.status;
      if(editOwnerEl) editOwnerEl.value = data.owner;
      if(editRemarksEl) editRemarksEl.value = '';
      
      // Show modal
      if(editModal){
        editModal.classList.add('show');
        editModal.setAttribute('aria-hidden', 'false');
      }
    }

    function closeEditModal(){
      if(editModal){
        editModal.classList.remove('show');
        editModal.setAttribute('aria-hidden', 'true');
      }
      currentRow = null;
      originalData = null;
      if(editForm) editForm.reset();
    }

    function updateRowInTable(data){
      if(!currentRow) return;
      
      // Update row data attribute
      currentRow.setAttribute('data-inspection', JSON.stringify(data));
      currentRow.setAttribute('data-status', data.status);
      
      // Update visible cells
      const cells = currentRow.querySelectorAll('td');
      if(cells.length >= 5){
      cells[2].textContent = data.period; // Period
      
      // Update status chip
      const statusChip = cells[3].querySelector('.chip');
      if(statusChip){
        statusChip.className = data.status === 'Closed' ? 'chip ok' : 'chip info';
        statusChip.textContent = data.status.toUpperCase();
      }
      
      cells[4].textContent = data.owner; // Owner
    }
    
    // If status changed to Closed or Dropped, disable edit button
    if(data.status === 'Closed' || data.status === 'Dropped'){
      const editBtnCell = cells[6];
      if(editBtnCell){
        editBtnCell.innerHTML = `<div class="edit-btn-wrapper" data-tooltip="Inspection ${data.status.toLowerCase()} – modification not allowed">
                                   <button class="btn small edit-btn" disabled>Edit</button>
                                 </div>`;
      }
    }
    }

    // Delegated click handler for edit buttons
    document.body.addEventListener('click', function(e){
      const t = e.target;
      
      // Handle edit button click
      if(t && t.classList && t.classList.contains('edit-btn') && !t.disabled){
        const row = t.closest('tr[data-inspection]');
        if(!row) return;
        
        try {
          const dataStr = row.getAttribute('data-inspection');
          const data = JSON.parse(dataStr);
          const status = row.getAttribute('data-status');
          
          // Check if closed (additional safety check)
          if(status === 'Closed'){
            return;
          }
          
          openEditModal(row, data);
        } catch(err){
          console.error('Error opening edit modal:', err);
        }
      }
      
      // Handle close buttons
      if(t && (t.id === 'edit-close-btn' || t.id === 'edit-close-btn-2')){
        closeEditModal();
      }
    });

    // Save Changes button
    document.getElementById('edit-save-btn')?.addEventListener('click', function(){
      if(!currentRow || !originalData) return;
      
      const updatedData = {
        id: editIdEl?.value || originalData.id,
        insurer: editInsurerEl?.value || originalData.insurer,
        period: `${editStartDateEl?.value || ''} → ${editEndDateEl?.value || ''}`,
        status: editStatusEl?.value || originalData.status,
        owner: editOwnerEl?.value || originalData.owner
      };
      
      const remarks = editRemarksEl?.value.trim();
      if(!remarks){
        alert('Please provide a reason for the modification.');
        editRemarksEl?.focus();
        return;
      }
      
      // Validate dates
      if(!editStartDateEl?.value || !editEndDateEl?.value){
        alert('Please provide both start and end dates.');
        return;
      }
      
      updateRowInTable(updatedData);
      alert(`Inspection ${updatedData.id} updated successfully.\nReason: ${remarks}`);
      closeEditModal();
    });

    // Postpone Inspection button
    document.getElementById('edit-postpone-btn')?.addEventListener('click', function(){
      if(!currentRow || !originalData) return;
      
      const newEndDate = editEndDateEl?.value;
      const originalEndDate = originalData.period.split(' → ')[1];
      
      // TODO: Add validation to ensure new end date is after original end date
      if(!newEndDate){
        alert('Please select a new end date to postpone the inspection.');
        editEndDateEl?.focus();
        return;
      }
      
      const remarks = editRemarksEl?.value.trim();
      if(!remarks){
        alert('Please provide a reason for postponing.');
        editRemarksEl?.focus();
        return;
      }
      
      const updatedData = {
        id: editIdEl?.value || originalData.id,
        insurer: editInsurerEl?.value || originalData.insurer,
        period: `${editStartDateEl?.value || originalData.period.split(' → ')[0]} → ${newEndDate}`,
        status: 'Data Fetch', // Reset to initial status
        owner: editOwnerEl?.value || originalData.owner
      };
      
      updateRowInTable(updatedData);
      alert(`Inspection ${updatedData.id} postponed to ${newEndDate}.\nReason: ${remarks}`);
      closeEditModal();
    });

    // Drop Inspection button
    document.getElementById('edit-drop-btn')?.addEventListener('click', function(){
      if(!currentRow || !originalData) return;
      
      const remarks = editRemarksEl?.value.trim();
      if(!remarks){
        alert('Please provide a reason for dropping the inspection.');
        editRemarksEl?.focus();
        return;
      }
      
      if(!confirm(`Are you sure you want to drop inspection ${originalData.id}?\nThis action will mark the inspection as DROPPED.`)){
        return;
      }
      
      const updatedData = {
        id: editIdEl?.value || originalData.id,
        insurer: editInsurerEl?.value || originalData.insurer,
        period: originalData.period,
        status: 'Dropped',
        owner: editOwnerEl?.value || originalData.owner
      };
      
      updateRowInTable(updatedData);
      alert(`Inspection ${updatedData.id} has been dropped.\nReason: ${remarks}`);
      closeEditModal();
    });

    // Close modal when clicking overlay
    editModal?.addEventListener('click', function(e){
      if(e.target === editModal) closeEditModal();
    });
  })();

  // === Observation Response Functions ===
  window.openObservationResponse = function(obsId){
    const panel = document.getElementById('observation-response-panel');
    const obsIdEl = document.getElementById('obs-response-id');
    const textArea = document.getElementById('obs-response-text');
    const fileInput = document.getElementById('obs-response-file');
    
    if(obsIdEl) obsIdEl.textContent = obsId;
    if(textArea) textArea.value = '';
    if(fileInput) fileInput.value = '';
    if(panel) {
      panel.style.display = 'block';
      panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  };

  window.closeObservationResponse = function(){
    const panel = document.getElementById('observation-response-panel');
    if(panel) panel.style.display = 'none';
  };

  window.submitObservationResponse = function(){
    const obsId = document.getElementById('obs-response-id')?.textContent;
    const responseText = document.getElementById('obs-response-text')?.value.trim();
    const fileInput = document.getElementById('obs-response-file');
    
    if(!responseText){
      alert('Please provide a response before submitting.');
      return;
    }
    
    const fileCount = fileInput?.files?.length || 0;
    const fileMsg = fileCount > 0 ? ` with ${fileCount} attachment(s)` : '';
    
    alert(`Response submitted for ${obsId}${fileMsg}\n\nYour response will be reviewed by the inspection team.`);
    closeObservationResponse();
  };

  window.saveObservationDraft = function(){
    const obsId = document.getElementById('obs-response-id')?.textContent;
    alert(`Draft saved for ${obsId}\n\nYou can continue editing later.`);
  };

  window.viewObservationResponse = function(obsId){
    alert(`Viewing response for ${obsId}\n\n[This would show the previously submitted response]`);
  };

  // ========== Modal Functions ==========
  window.openModal = function(modalId) {
    const modal = document.getElementById(modalId);
    if(modal) {
      modal.classList.add('show');
      modal.setAttribute('aria-hidden', 'false');
      document.body.style.overflow = 'hidden';
    }
  };

  window.closeModal = function(modalId) {
    const modal = document.getElementById(modalId);
    if(modal) {
      modal.classList.remove('show');
      modal.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = '';
    }
  };

  // Close modal on outside click
  document.querySelectorAll('.modal').forEach(modal => {
    modal.addEventListener('click', function(e) {
      if(e.target === this) {
        closeModal(this.id);
      }
    });
  });

  // Close modal on Escape key
  document.addEventListener('keydown', function(e) {
    if(e.key === 'Escape') {
      document.querySelectorAll('.modal.show').forEach(modal => {
        closeModal(modal.id);
      });
    }
  });

  // ========== Data Validation Rule Functions ==========
  $('#btnAddRule')?.addEventListener('click', () => openModal('modalAddRule'));

  window.saveRule = function() {
    const name = $('#rule-name')?.value;
    const dataset = $('#rule-dataset')?.value;
    const severity = $('#rule-severity')?.value;
    const expression = $('#rule-expression')?.value;

    if(!name || !expression) {
      alert('Please fill in Rule Name and Expression');
      return;
    }

    // Add dummy row to table
    const tbody = document.querySelector('#data-validation tbody');
    if(tbody) {
      const severityClass = severity === 'High' ? 'miss' : severity === 'Medium' ? 'warn' : 'chip';
      const newRow = `
        <tr style="border-bottom:1px solid var(--color-border);">
          <td style="padding:var(--spacing-md); font-weight:600;">${name}</td>
          <td style="padding:var(--spacing-md); font-family:monospace; font-size:0.8125rem; color:var(--color-text-muted);">${expression}</td>
          <td style="padding:var(--spacing-md);"><span class="chip ${severityClass}">${severity}</span></td>
          <td style="padding:var(--spacing-md); color:var(--color-text-muted); font-size:0.875rem;">${dataset}</td>
          <td style="padding:var(--spacing-md);"><span class="chip ok">Active</span></td>
          <td style="padding:var(--spacing-md); color:var(--color-text-muted); font-size:0.875rem;">${new Date().toLocaleDateString('en-GB', {day:'2-digit', month:'short', year:'numeric'})}</td>
          <td style="padding:var(--spacing-md); text-align:right;">
            <button type="button" class="btn small" style="padding:0.25rem 0.5rem; margin-right:0.25rem; background:transparent; color:var(--color-primary); box-shadow:none;" title="Edit">✏️</button>
            <button type="button" class="btn small" style="padding:0.25rem 0.5rem; margin-right:0.25rem; background:transparent; color:var(--color-text-muted); box-shadow:none;" title="Disable">⏸️</button>
            <button type="button" class="btn small" style="padding:0.25rem 0.5rem; background:transparent; color:var(--color-accent-error); box-shadow:none;" title="Delete">🗑️</button>
          </td>
        </tr>
      `;
      tbody.insertAdjacentHTML('afterbegin', newRow);
    }

    // Clear form
    $('#rule-name').value = '';
    $('#rule-expression').value = '';
    $('#rule-description').value = '';
    
    closeModal('modalAddRule');
    alert('Rule added successfully!');
  };

  // ========== Regulatory Check Functions ==========
  $('#btnAddRegCheck')?.addEventListener('click', () => openModal('modalAddRegCheck'));

  window.saveRegCheck = function() {
    const regulation = $('#reg-regulation')?.value;
    const clause = $('#reg-clause')?.value;
    const checkName = $('#reg-check-name')?.value;
    const logic = $('#reg-logic')?.value;
    const severity = $('#reg-severity')?.value;

    if(!checkName || !logic) {
      alert('Please fill in Check Name and Logic');
      return;
    }

    // Add dummy row to table
    const tbody = document.querySelector('#reg-rules tbody');
    if(tbody) {
      const severityClass = severity === 'High' ? 'miss' : severity === 'Medium' ? 'warn' : 'chip';
      const newRow = `
        <tr style="border-bottom:1px solid var(--color-border);">
          <td style="padding:var(--spacing-md); font-weight:600;">${checkName}</td>
          <td style="padding:var(--spacing-md); color:var(--color-text-muted); font-size:0.875rem;">${regulation} – ${clause}</td>
          <td style="padding:var(--spacing-md); font-family:monospace; font-size:0.8125rem;">${logic.substring(0, 50)}${logic.length > 50 ? '...' : ''}</td>
          <td style="padding:var(--spacing-md);"><span class="chip ${severityClass}">${severity}</span></td>
          <td style="padding:var(--spacing-md);"><span class="chip ok">Active</span></td>
          <td style="padding:var(--spacing-md); text-align:right;">
            <button type="button" class="btn small" style="padding:0.25rem 0.5rem; margin-right:0.25rem; background:transparent; color:var(--color-primary); box-shadow:none;" title="Edit">✏️</button>
            <button type="button" class="btn small" style="padding:0.25rem 0.5rem; background:transparent; color:var(--color-text-muted); box-shadow:none;" title="Disable">⏸️</button>
          </td>
        </tr>
      `;
      tbody.insertAdjacentHTML('afterbegin', newRow);
    }

    // Clear form
    $('#reg-check-name').value = '';
    $('#reg-clause').value = '';
    $('#reg-logic').value = '';
    
    closeModal('modalAddRegCheck');
    alert('Regulatory check added successfully!');
  };

  // ========== Analytics Subtabs ==========
  const analyticsSubtabs = $$('.analytics-subtab');
  analyticsSubtabs.forEach(tab => {
    tab.addEventListener('click', function() {
      const target = this.getAttribute('data-subtarget');
      
      // Update active tab
      analyticsSubtabs.forEach(t => t.classList.remove('active'));
      this.classList.add('active');
      
      // Show/hide content
      $$('.analytics-subtab-content').forEach(content => {
        content.style.display = content.id === target ? 'block' : 'none';
      });
    });
  });

  // ========== Template Functions ==========
  $('#btnAddTemplate')?.addEventListener('click', () => openModal('modalAddTemplate'));

  window.updateCategoryHelper = function() {
    const category = $('#template-category')?.value;
    const helper = $('#category-helper');
    
    const helpers = {
      'policy': 'Policy data includes policy numbers, coverage details, premium information, and policyholder demographics.',
      'claims': 'Claims data includes claim registration, settlement details, TAT metrics, and repudiation information.',
      'finance': 'Financial data includes solvency ratios, investment portfolios, income statements, and balance sheets.',
      'reinsurance': 'Reinsurance data includes treaty details, claims ceded, premium paid to reinsurers, and recovery information.',
      'governance': 'Governance data includes board composition, meeting minutes, committee structures, and compliance frameworks.',
      'grievance': 'Grievance data includes complaint registration, resolution timelines, escalation patterns, and customer satisfaction metrics.'
    };
    
    if(category && helper) {
      helper.textContent = helpers[category] || '';
      helper.style.display = 'block';
    } else if(helper) {
      helper.style.display = 'none';
    }
  };

  window.saveTemplate = function() {
    const name = $('#template-name')?.value;
    const type = $('#template-type')?.value;

    if(!name) {
      alert('Please enter a Template Name');
      return;
    }

    // Add dummy row to table
    const tbody = document.querySelector('#insp-templates tbody');
    if(tbody) {
      const newRow = `
        <tr style="border-bottom:1px solid var(--color-border); cursor:pointer;">
          <td style="padding:var(--spacing-md); font-weight:600; color:var(--color-primary);">${name}</td>
          <td style="padding:var(--spacing-md); color:var(--color-text-muted); font-size:0.875rem;">${type}</td>
          <td style="padding:var(--spacing-md); color:var(--color-text-muted); font-size:0.875rem);">${new Date().toLocaleDateString('en-GB', {day:'2-digit', month:'short', year:'numeric'})}</td>
        </tr>
      `;
      tbody.insertAdjacentHTML('afterbegin', newRow);
    }

    // Clear form
    $('#template-name').value = '';
    $('#template-category').value = '';
    updateCategoryHelper();
    
    closeModal('modalAddTemplate');
    alert('Template created successfully!');
  };
});
</script>
<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyAcANUS1p-cFZhFxFuA1wwP9l1MyKm6QM0",
  authDomain: "supervision-demo-e3ee0.firebaseapp.com",
  projectId: "supervision-demo-e3ee0",
  storageBucket: "supervision-demo-e3ee0.firebasestorage.app",
  messagingSenderId: "182618191187",
  appId: "1:182618191187:web:e7e6dc2e095bef6198dda6"
};

// Initialize
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

console.log("🔥 Firebase Connected");

// Login handler
document.getElementById("login-btn").addEventListener("click", async () => {

  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value.trim();

  try {

    await signInWithEmailAndPassword(auth, email, password);

    alert("Login successful ✅");

    document.getElementById("login").style.display = "none";
    document.getElementById("app-root").style.display = "";

  } catch (error) {

    alert(error.message);

  }

});

</script>
</script>
</body>
</html>
